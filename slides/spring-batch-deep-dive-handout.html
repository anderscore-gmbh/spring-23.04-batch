<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>Spring-Batch Deep-Dive</title><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui" name="viewport"><link href="reveal.js-3.9.2/css/reveal.css" rel="stylesheet"><link href="reveal.js-3.9.2/plugin/title-footer/title-footer.css" rel="stylesheet"><link rel="stylesheet" href="reveal.js-3.9.2/css/theme/anderscore.css" id="theme"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css"><style>/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid currentColor;opacity:.35;padding:0 .5em 0 0}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}</style><link href="reveal.js-3.9.2/lib/css/zenburn.css" rel="stylesheet"><script>document.write( '<link rel="stylesheet" href="reveal.js-3.9.2/css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );</script></head><body><div class="reveal"><div class="slides"><section class="title" data-state="title"><h1>Spring-Batch Deep-Dive</h1></section><section id="_lektion_1_einführung" data-state="no-title-footer"><h2>Lektion 1 - Einführung</h2><div class="paragraph center"><p>Warum Spring-Batch?</p></div></section>
<section id="_herkunft"><h2>Herkunft</h2><div class="paragraph lead"><p>Was ist Batchverarbeitung?</p></div>
<div class="ulist"><ul><li><p>Historisch: Stapelverarbeitung (Lochkarten)</p></li><li><p>Windows: .BAT Dateien</p></li><li><p>Großer Stil: Operator verwaltet Jobs im Rechenzentrum</p></li><li><p>Batchverarbeitung vs. Dialogverarbeitung vs. Messaging</p></li></ul></div></section>
<section id="_merkmale"><h2>Merkmale</h2><div class="paragraph lead"><p>Wodurch zeichnen sich Batchprogramme aus?</p></div>
<div class="paragraph"><p>Batchprogramme &#8230;&#8203;</p></div>
<div class="ulist step"><ul><li class="fragment"><p>laufen ohne Benutzerinteraktion</p></li><li class="fragment"><p>verarbeiten eine vorgegebene Datenmenge</p></li><li class="fragment"><p>enden nachdem alle Daten verarbeitet wurden</p></li><li class="fragment"><p>eigenen sich nur, wenn Verzögerung akzeptabel ist</p></li></ul></div></section>
<section id="_wozu"><h2>Wozu?</h2><div class="paragraph lead"><p>Batch-Verarbeitung ist doch ganz einfach,<br>
wozu braucht man dafür ein Framework?</p></div></section>
<section id="_anforderungen"><h2>Anforderungen</h2><div class="paragraph"><p>Batch-Programme &#8230;&#8203;</p></div>
<div class="ulist"><ul><li><p>müssen große Datenmengen verarbeiten können</p></li><li><p>müssen ausreichende Performance liefern</p></li><li><p>müssen mit Fehlern klarkommen</p><div class="ulist"><ul><li><p>defekte Eingangsdaten</p></li><li><p>(temporäre) Ausfälle</p></li></ul></div></li><li><p>müssen Wiederanlauf unterstützen</p></li><li><p>müssen überwacht werden können</p></li></ul></div></section>
<section id="_anwendungsbereiche"><h2>Anwendungsbereiche</h2><div class="paragraph lead"><p>Ein Fall für Spring-Batch?</p></div>
<div class="olist arabic step"><ol class="arabic"><li class="fragment"><p>Kontoauszüge am Monatsende erstellen und verschicken</p></li><li class="fragment"><p>Eingehende Dokumente vom Scandienstleister an ein Workflowsystem übergeben</p></li><li class="fragment"><p>Eine Web-Anwendung soll immer den aktuellsten Standortkatalog (XML-Datei) importieren</p></li><li class="fragment"><p>Generierung eines umfangreichen PDF-Dokuments über Web-Oberfläche</p></li><li class="fragment"><p>Einmalige Datenmigration aus einer Altanwendung</p></li><li class="fragment"><p>Einlesen einer großen XML- oder CSV-Datei</p></li><li class="fragment"><p>Regelmäßig den Cache für Konfigurationsdaten löschen, damit Änderungen aus der Datenbank gezogen werden</p></li></ol></div></section>
<section id="" data-state="no-title-footer"><h2></h2><div class="imageblock" style=""><img src="images/intro/Mothers-Brewing-Spring-Batch.jpg" alt="Mothers Brewing Spring Batch"></div></section>
<section id="_historie"><h2>Historie</h2><div class="ulist"><ul><li><p>2007: Code-Beitrag von Accenture</p></li><li><p>2008: Spring-Batch-1.0.0.FINAL (Java 4)</p></li><li><p>2009: 2.0.0.RELEASE (Java 5, Generics, Flows, Remote Chunking, Partitioning)</p></li><li><p>2014: 3.0.0.RELEASE (JSR-352, Spring 4, Java 8)</p></li><li><p>2017: 4.0.0.RELEASE (Spring 5, benötigt Java 8, Builder für Reader/Writer)</p></li><li><p><a href="https://github.com/spring-projects/spring-batch/releases">aktuell</a>:
4.3.6 (Records, JpaCursorItemReader, Json, Bean Validation, Micrometer, Kafka, Avro, Vereinfachungen, Doku, sichere JSON-Deserialisierung)</p></li><li><p><a href="https://github.com/spring-projects/spring-batch/wiki/Spring-Batch-5.0-Migration-Guide">2023</a>:
5.0.0 (Spring 6, benötigt Java 17, Defaultmethoden statt Supportklassen,
transactionManager Bean Problem gelöst <a href="https://github.com/spring-projects/spring-batch/pull/3981">#3981</a>)</p></li></ul></div></section>
<section id="_typische_lernkurve_bei_spring_batch"><h2>Typische Lernkurve bei Spring-Batch</h2><div class="imageblock" style=""><img src="images/intro/Lernkurve1.svg" alt="Lernkurve1" width="1200"></div></section>
<section id="_ziel_dieser_schulung"><h2>Ziel dieser Schulung&#8230;&#8203;</h2><div class="imageblock" style=""><img src="images/intro/Lernkurve3.svg" alt="Lernkurve3" width="1200"></div></section>
<section id="_architektur_jars"><h2>Architektur (JARs)</h2><div class="imageblock" style=""><img src="images/Spring-Batch-Komponenten.svg" alt="Spring Batch Komponenten" width="780" height="494"></div></section>
<section id="_typischer_ablauf_eines_batch_jobs"><h2>Typischer Ablauf eines Batch-Jobs</h2><div class="imageblock" style=""><img src="images/Typischer-Batch-Ablauf.svg" alt="Typischer Batch Ablauf" width="540" height="680"></div></section>
<section id="_zusammenfassung_lektion_1"><h2>Zusammenfassung Lektion 1</h2><div class="ulist"><ul><li><p>Batchprogramme laufen ohne Benutzerinteraktion und enden wenn alles verarbeitet ist.</p></li><li><p>Batchprogramme müssen performant und fehlertolerant sein, Wiederanlauf unterstützen und überwacht werden können.</p></li><li><p>Anwendungsbeispiele&#8230;&#8203;</p></li><li><p>Historie</p></li><li><p>Architektur von Spring-Batch</p></li><li><p>Ein typischer Batchablauf</p></li></ul></div>
<div class="paragraph"><p><br>
&#8594; <a href="index.html">Agenda</a></p></div></section>
<section id="_lektion_2_hello_world_mit_spring_batch" data-state="no-title-footer"><h2>Lektion 2 - Hello World mit Spring-Batch</h2></section>
<section id="_überblick_zu_dieser_lektion"><h2>Überblick zu dieser Lektion</h2><div class="olist arabic"><ol class="arabic"><li><p><a href="lesson02-hello.html#/_spring_batch_anwendung_mit_spring_initializr">Hello World mit Spring Initializr</a>
(<a href="lesson02-hello.html#/_aufgabe_1_spring_batch_anwendung_mit_spring_initilizr">Aufgabe 1</a>)</p></li><li><p><a href="lesson02-hello.html#/_tasklet_stacktrace_transactiontemplate">Stacktrace</a> und
<a href="lesson02-hello.html#/_relevante_singleton_beans_aus_dem_applicationcontext">ApplicationContext</a> analysieren</p></li><li><p><a href="lesson02-hello.html#/_commandlinejobrunner">CommandLineRunner verwenden</a>
(<a href="lesson02-hello.html#/_aufgabe_2_spring_batch_anwendung_ohne_spring_boot_ausf%C3%BChren">Aufgabe 2</a>)</p></li><li><p><a href="lesson02-hello.html#/<em>job_parameter">Parameterübergabe und Wiederholung</a>
mit <a href="lesson02-hello.html#/_l%C3%B6sung_1_jobexecutionlistener">Listener</a>
(<a href="lesson02-hello.html#/_aufgabe_3_job_mit_parameter">Aufgabe 3</a>)
oder <a href="lesson02-hello.html#/_l%C3%B6sung_3_job_parameter</em>%C3%BCber_expression_language">EL</a>
(<a href="lesson02-hello.html#/_aufgabe_4_expression_language">Aufgabe 4</a>)</p></li><li><p><a href="lesson02-hello.html#/_hello_world_job_als_unit_test">Testing</a></p></li><li><p><a href="lesson02-hello.html#/_manuelle_job_konfiguration">Spring-Batch ohne Autowiring</a></p></li></ol></div></section>
<section id="_bestandteile_eines_spring_batch_jobs"><h2>Bestandteile eines Spring-Batch Jobs</h2><div class="imageblock" style=""><img src="images/HelloJob.svg" alt="HelloJob" width="1008" height="374"></div></section>
<section id="_implementierung_hello_world_tasklet"><h2>Implementierung Hello World-Tasklet</h2><pre class="CodeRay listingblock"><code class="java language-java"><span class="directive">public</span> <span class="type">class</span> <span class="class">HelloTasklet</span> <span class="directive">implements</span> Tasklet {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution, ChunkContext chunkContext) {
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hello World!</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">return</span> RepeatStatus.FINISHED;
    }
}</code></pre>
<div class="paragraph"><p>Der Rückgabewert <code>RepeatStatus.FINISHED</code> bewirkt, dass der Step nach der 1. Ausführung beendet wird.</p></div></section>
<section id="_grundgerüst_einer_job_konfiguration"><h2>Grundgerüst einer Job-Konfiguration</h2><pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Configuration</span>
<span class="annotation">@EnableBatchProcessing</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">HelloConfig</span> {

    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> JobBuilderFactory jobBuilderFactory;

    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> StepBuilderFactory stepBuilderFactory;

    <span class="comment">// ...</span>

}</code></pre>
<div class="paragraph"><p>Die Annotation <code>EnableBatchProcessing</code> (&#8594; Source) bewirkt, dass alle relevanten Beans für Spring-Batch
angelegt werden.</p></div></section>
<section id="_konfiguration_des_hello_jobs"><h2>Konfiguration des Hello-Jobs</h2><pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Bean</span>
HelloTasklet helloTasklet() {
    <span class="keyword">return</span> <span class="keyword">new</span> HelloTasklet();
}

<span class="annotation">@Bean</span>
Step helloStep() {
    <span class="keyword">return</span> stepBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">helloStep</span><span class="delimiter">&quot;</span></span>).tasklet(helloTasklet()).build();
}

<span class="annotation">@Bean</span>
Job helloJob() {
    <span class="keyword">return</span> jobBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">helloJob</span><span class="delimiter">&quot;</span></span>).start(helloStep()).build();
}</code></pre>
<div class="paragraph"><p>Jobs und Steps sollte man immer mit den zugehörigen Builder-Factories erzeugen.</p></div></section>
<section id="_spring_initializr"><h2>Spring Initializr</h2><div class="ulist"><ul><li><p>Bootstraping von Spring-Boot Applikation</p></li><li><p>Web-UI: <a href="https://start.spring.io/" class="bare">https://start.spring.io/</a></p></li><li><p>In Java-IDEs integriert</p></li><li><p>Bietet Oberfläche zur Auswahl von</p><div class="ulist"><ul><li><p>Sprache (Java, Kotlin)</p></li><li><p>Build-System (Maven, Gradle)</p></li><li><p>Versionen</p></li><li><p>Abhängigkeiten</p></li></ul></div></li><li><p>Erzeugt lauffähiges Grundgerüst einer Applikation</p></li></ul></div></section>
<section id="_spring_batch_anwendung_mit_spring_initializr"><h2>Spring-Batch-Anwendung mit Spring Initializr</h2><div class="imageblock" style=""><img src="images/hello/Spring_Initializr.png" alt="Spring Initializr"></div></section>
<section id="_optionen_für_hello_world_anwendung"><h2>Optionen für Hello World Anwendung</h2><div class="imageblock" style=""><img src="images/hello/Spring_Initializr-Options.png" alt="Spring Initializr Options" width="800px"></div></section>
<section id="_build_mit_maven"><h2>Build mit Maven</h2><div class="imageblock" style=""><img src="images/hello/Maven-Befehlszeile.png" alt="Maven Befehlszeile" width="1600px"></div></section>
<section id="_aufgabe_1_spring_batch_anwendung_mit_spring_initilizr"><h2>Aufgabe 1: Spring-Batch-Anwendung mit Spring-Initilizr</h2><div class="olist arabic"><ol class="arabic"><li><p>Erstellen Sie eine Spring-Boot Anwendung mit Spring-Initilizr mit folgenden Einstellungen:</p><div class="ulist"><ul><li><p>Maven</p></li><li><p>Java 17</p></li><li><p>Abhängigkeiten: Spring Batch, HyperSQL Database</p></li></ul></div></li><li><p>Fügen Sie eine <code>HelloConfig</code> mit einem Hello World Job hinzu</p></li><li><p>Führen Sie die Anwendung aus</p></li><li><p>Was fällt Ihnen bei den Logausgaben auf, wenn Sie die Anwendung mit "debug=true" ausführen?</p></li><li><p>Setzen Sie einen Breakpoint in der <code>execute</code> Methode. Welche Abschnitte des Stacktrace gehören zu Spring-Batch?</p></li><li><p>Welche Beans im <em>ApplicationContext</em> gehören zu Spring-Batch? Wie könnten Sie das herausfinden?</p></li></ol></div></section>
<section id="_tasklet_stacktrace_transactiontemplate"><h2>Tasklet-Stacktrace: TransactionTemplate</h2><pre class="CodeRay listingblock"><code>execute:17, HelloTasklet (de.springbatchdeepdive.lesson02.hello)
doInTransaction:407, TaskletStep$ChunkTransactionCallback (org.springframework.batch.core.step.tasklet)
doInTransaction:331, TaskletStep$ChunkTransactionCallback (org.springframework.batch.core.step.tasklet)
execute:140, TransactionTemplate (org.springframework.transaction.support)
doInChunkContext:273, TaskletStep$2 (org.springframework.batch.core.step.tasklet)
...</code></pre>
<div class="paragraph"><p>Jeder Aufruf von <code>Tasklet.execute</code> wird in einer eigenen Transaktion ausgeführt.</p></div></section>
<section id="_tasklet_stacktrace_repeattemplate"><h2>Tasklet-Stacktrace: RepeatTemplate</h2><pre class="CodeRay listingblock"><code>...
doInChunkContext:273, TaskletStep$2 (org.springframework.batch.core.step.tasklet)
doInIteration:82, StepContextRepeatCallback (org.springframework.batch.core.scope.context)
getNextResult:375, RepeatTemplate (org.springframework.batch.repeat.support)
executeInternal:215, RepeatTemplate (org.springframework.batch.repeat.support)
iterate:145, RepeatTemplate (org.springframework.batch.repeat.support)
doExecute:258, TaskletStep (org.springframework.batch.core.step.tasklet)
...</code></pre>
<div class="paragraph"><p>Das <code>RepeatTemplate</code> ersetzt eine Schleife zur Wiederholung des <code>Tasklet</code>.</p></div></section>
<section id="_repeattemplateein_framework_für_eine_schleife"><h2>RepeatTemplate&#8201;&#8212;&#8201;Ein Framework für eine Schleife</h2><div class="imageblock" style=""><img src="images/RepeatTemplate.svg" alt="RepeatTemplate" width="2188" height="840"></div></section>
<section id="_verwendung_des_repeattemplate_beim_taskletstep"><h2>Verwendung des RepeatTemplate beim TaskletStep</h2><div class="imageblock" style=""><img src="images/TaskletStep.svg" alt="TaskletStep" width="1952" height="592"></div></section>
<section id="_tasklet_ausführen"><h2>Tasklet ausführen</h2><div class="imageblock" style=""><img src="images/TaskletExec.svg" alt="TaskletExec" width="792" height="434"></div></section>
<section id="_tasklet_stacktrace_simplejoblauncher"><h2>Tasklet-Stacktrace: SimpleJobLauncher</h2><pre class="CodeRay listingblock"><code>...
doExecute:258, TaskletStep (org.springframework.batch.core.step.tasklet)
execute:208, AbstractStep (org.springframework.batch.core.step)
handleStep:152, SimpleStepHandler (org.springframework.batch.core.job)
handleStep:413, AbstractJob (org.springframework.batch.core.job)
doExecute:136, SimpleJob (org.springframework.batch.core.job)
execute:320, AbstractJob (org.springframework.batch.core.job)
run:149, SimpleJobLauncher$1 (org.springframework.batch.core.launch.support)
...</code></pre>
<div class="paragraph"><p>Der <code>SimpleJobLauncher</code> führt den Batch-Job aus.</p></div>
<aside class="notes"><p>Den Stacktraces am besten direkt im Debugger ansehen.</p></aside></section>
<section id="_tasklet_stacktrace_simplejoblauncher_ist_als_lazyproxy_verpackt"><h2>Tasklet-Stacktrace: SimpleJobLauncher ist als <em>LazyProxy</em> verpackt</h2><pre class="CodeRay listingblock"><code>...
run:149, SimpleJobLauncher$1 (org.springframework.batch.core.launch.support)
execute:50, SyncTaskExecutor (org.springframework.core.task)
run:140, SimpleJobLauncher (org.springframework.batch.core.launch.support)
invoke0:-1, NativeMethodAccessorImpl (jdk.internal.reflect)
invoke:77, NativeMethodAccessorImpl (jdk.internal.reflect)
invoke:43, DelegatingMethodAccessorImpl (jdk.internal.reflect)
invoke:568, Method (java.lang.reflect)
invokeJoinpointUsingReflection:344, AopUtils (org.springframework.aop.support)
invokeJoinpoint:198, ReflectiveMethodInvocation (org.springframework.aop.framework)
proceed:163, ReflectiveMethodInvocation (org.springframework.aop.framework)
invoke:128, SimpleBatchConfiguration$PassthruAdvice (org.springframework.batch.core.configuration.annotation)
proceed:186, ReflectiveMethodInvocation (org.springframework.aop.framework)
invoke:215, JdkDynamicAopProxy (org.springframework.aop.framework)
run:-1, $Proxy50 (jdk.proxy2)
...</code></pre>
<div class="paragraph"><p>Die <code>SimpleBatchConfiguration</code> (&#8594; Source) verpackt Spring-Batch Beans als lazy Proxy.<br>
Das löst Probleme bei der Initialisierungsreihenfolge.</p></div>
<div class="admonitionblock caution teacherBox"><table><tr><td class="icon"><i class="fa fa-fire" title="Caution"></i></td><td class="content">Name der Beans (z. B. <strong>transactionManager</strong>) ist in <code>SimpleBatchConfiguration</code> hart verdrahtet!</td></tr></table></div></section>
<section id="_tasklet_stacktrace_joblauncherapplicationrunner"><h2>Tasklet-Stacktrace: JobLauncherApplicationRunner</h2><pre class="CodeRay listingblock"><code>...
run:-1, $Proxy50 (jdk.proxy2)
execute:199, JobLauncherApplicationRunner (org.springframework.boot.autoconfigure.batch)
executeLocalJobs:173, JobLauncherApplicationRunner (org.springframework.boot.autoconfigure.batch)
launchJobFromProperties:160, JobLauncherApplicationRunner (org.springframework.boot.autoconfigure.batch)
run:155, JobLauncherApplicationRunner (org.springframework.boot.autoconfigure.batch)
run:150, JobLauncherApplicationRunner (org.springframework.boot.autoconfigure.batch)
callRunner:782, SpringApplication (org.springframework.boot)
callRunners:772, SpringApplication (org.springframework.boot)
run:345, SpringApplication (org.springframework.boot)
run:1343, SpringApplication (org.springframework.boot)
run:1332, SpringApplication (org.springframework.boot)
main:10, HelloBootApplication (de.springbatchdeepdive.lesson02.hello)</code></pre>
<div class="ulist"><ul><li><p>Standardmäßig führt Spring-Boot alle Jobs mit dem <code>JobLauncherApplicationRunner</code> beim
Start der Anwendung aus.</p></li><li><p>Dies kann man über die <em>application.properties</em> mit <code>spring.batch.job.enabled=false</code> unterbinden
oder man kann über <code>spring.batch.job.names</code> explizit angeben, welche Jobs ausgeführt werden sollen
(siehe <a href="https://docs.spring.io/spring-boot/docs/current/api/org/springframework/boot/autoconfigure/batch/BatchProperties.html">&#8594; <code>BatchProperties</code></a>).</p></li></ul></div></section>
<section id="_relevante_singleton_beans_aus_dem_applicationcontext"><h2>Relevante Singleton-Beans aus dem ApplicationContext</h2><table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:50%"><col style="width:50%"></colgroup><thead><tr><th class="tableblock halign-left valign-top">Bean-Name</th><th class="tableblock halign-left valign-top">Bean-Klasse</th></tr><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">jobRepository</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">org.springframework.batch.core.repository.JobRepository</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">jobLauncher</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">org.springframework.batch.core.launch.JobLauncher</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">jobRegistry</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">org.springframework.batch.core.configuration.JobRegistry</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">jobExplorer</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">org.springframework.batch.core.explore.JobExplorer</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">jobOperator</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">org.springframework.batch.core.launch.support.SimpleJobOperatorEnhancerBySpringCGLIB8c1a6d16</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">transactionManager</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">org.springframework.transaction.PlatformTransactionManager</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">jdbcTemplate</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">org.springframework.jdbc.core.JdbcTemplate</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">dataSource</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">com.zaxxer.hikari.HikariDataSource</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">jobBuilders</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">org.springframework.batch.core.configuration.annotation.JobBuilderFactory</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">stepBuilders</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">org.springframework.batch.core.configuration.annotation.StepBuilderFactory</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">helloJob</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">org.springframework.batch.core.job.SimpleJob</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">helloStep</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">org.springframework.batch.core.step.tasklet.TaskletStep</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">helloTasklet</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">de.springbatchdeepdive.lesson02.hello.HelloConfig$1</p></td></tr></table></section>
<section id="_commandlinejobrunner" data-state="no-title-footer"><h2>CommandLineJobRunner</h2><div class="paragraph center"><p>Batch-Jobs ohne Spring-Boot ausführen</p></div></section>
<section id="_commandlinejobrunnerüberblick"><h2>CommandLineJobRunner&#8201;&#8212;&#8201;Überblick</h2><div class="ulist"><ul><li><p>Der <code>CommandLineJobRunner</code> ist eine Klasse mit einer <code>main</code> Methode.</p></li><li><p>Man kann damit einen einzelnen Job ausführen oder die Ausführung von Jobs steuern.</p></li><li><p>Alternativ kann man auch eine Spring-Boot Anwendung mit Job-Parameter aufrufen.</p></li></ul></div></section>
<section id="_commandlinejobrunnerverwendung"><h2>CommandLineJobRunner&#8201;&#8212;&#8201;Verwendung</h2><pre class="CodeRay listingblock"><code>java -cp ..
    org.springframework.batch.core.launch.support.CommandLineJobRunner
        jobPath &lt;options&gt; jobIdentifier (jobParameters)*</code></pre>
<div class="ulist"><ul><li><p>Der <em>jobPath</em> ist entweder eine XML-ApplicationContext-Datei oder der voll qualifizierte
Klassenname einer Configuration-Klasse.</p></li><li><p>Der <em>jobIdentifier</em> ist der Name, der Job-Bean.<br>
Alternativ können auch Execution-Id oder Name aus dem <em>JobRepository</em> angegeben werden.</p></li><li><p>Job-Parameter müssen in der Form <code>name=wert</code> angegeben werden.</p></li><li><p>Die Optionen <em>-restart</em>, <em>-stop</em>, <em>-abandon</em> und <em>-next</em> spielen nur im Zusammenhang mit dem <em>JobRepository</em> eine Rolle.</p></li></ul></div>
<div class="paragraph"><p>Für Details siehe &#8594;
<a href="https://docs.spring.io/spring-batch/docs/4.3.x/api/org/springframework/batch/core/launch/support/CommandLineJobRunner.html">
CommandLineJobRunner Javadocs</a></p></div></section>
<section id="_aufgabe_2_spring_batch_anwendung_ohne_spring_boot_ausführen"><h2>Aufgabe 2: Spring-Batch-Anwendung ohne Spring-Boot ausführen</h2><div class="olist arabic"><ol class="arabic"><li><p>Kopieren Sie Ihre <code>HelloConfig</code> in das vorbereitete <code>exercises-plain</code> Projekt.</p></li><li><p>Passen Sie ggf. das exec-Target in der <em>pom.xml</em> an.</p></li><li><p>Führen Sie die Anwendung über Maven aus.</p></li><li><p>Alternativ: Erstellen Sie sich eine entsprechende Launch-Konfiguration in Ihrer IDE.</p></li><li><p>Erstellen Sie einen 2. Job zum Verabschieden und führen Sie diesen aus.</p></li><li><p>Welche Beans sind jetzt im ApplicationContext?</p></li><li><p>Was hat sich am Stacktrace geändert?</p></li></ol></div></section>
<section id="_job_parameter"><h2>Job-Parameter</h2><div class="ulist"><ul><li><p>In der Regel benötigen Jobs Parameter</p></li><li><p>Möglichkeit 1: System-Properties</p><div class="ulist"><ul><li><p>Aufruf über -Dname=Egon</p></li><li><p>Verwendung über <code>Environment</code>:</p><pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">${name:World}</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> <span class="predefined-type">String</span> name;</code></pre></li></ul></div></li><li><p>Möglichkeit 2: Job-Parameter</p></li></ul></div></section>
<section id="_job_parameterklasse_jobparameters"><h2>Job-Parameter&#8201;&#8212;&#8201;Klasse JobParameters</h2><div class="paragraph"><p>Der Zugriff auf Job-Paramter erfolgt über die Klasse <code>JobParameters</code>:</p></div>
<div class="imageblock" style="text-align: left"><img src="images/JobParameters.svg.svg" alt="JobParameters.svg" width="402" height="234"></div></section>
<section id="_commandlinejobrunnerparameterübergabe"><h2>CommandLineJobRunner&#8201;&#8212;&#8201;Parameterübergabe</h2><div class="ulist"><ul><li><p>Der <code>CommandLineJobRunner</code> verwendet den <code>DefaultJobParametersConverter</code>.</p></li><li><p>Datums- und Zahlenformat kann über entsprechende Formatter angepasst werden
(erfordert eigene <code>JobParametersConverter</code> Bean).</p></li><li><p>Parameter werden in der Form <code>key(&lt;type&gt;)=value</code> angegeben</p></li><li><p>Als <code>type</code> sind <em>string</em> (default), <em>date</em> oder <em>long</em> zulässig</p></li><li><p>Ein vorangestelltes <strong>-</strong> kennzeichnet den Parameter als nicht <em>identifizierend</em>.</p></li></ul></div>
<div class="paragraph"><p>Beispiele:</p></div>
<div class="literalblock"><div class="content"><pre>-name=Egon
department.id(long)=2345
schedule.date(date)=2020/02/27</pre></div></div>
<div class="paragraph"><p>Für Details siehe &#8594;
<a href="https://docs.spring.io/spring-batch/docs/4.3.x/api/org/springframework/batch/core/converter/DefaultJobParametersConverter.html">
DefaultJobParametersConverter Javadocs</a></p></div>
<div class="admonitionblock note teacherBox"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">Eine Job-Ausführung ist eindeutig durch den Jobnamen und die <em>identifizierenden</em>
Parameter bestimmt.</td></tr></table></div></section>
<section id="_parameterzugriff_über_listener"><h2>Parameterzugriff über Listener</h2><div class="paragraph"><p>Problem: Wie kommt man an das <strong><code>Parameters</code></strong> Objekt ran?</p></div></section>
<section id="_lösung_1_jobexecutionlistener"><h2>Lösung 1: JobExecutionListener</h2><div class="imageblock" style="text-align: left"><img src="images/JobExecutionListener.svg.svg" alt="JobExecutionListener.svg" width="1470" height="184"></div>
<div class="ulist"><ul><li><p>Die <strong><code>JobExecution</code></strong> enthält Metdaten zur Jobausführung, u. a. die Parameter</p></li><li><p>Eine Klasse (z. B. ein <code>Tasklet</code>) kann das <strong><code>JobExecutionListener</code></strong> Interface implementieren,<br>
um vor oder nach der Jobausführung auf diese Metadaten zuzugreifen.</p></li><li><p><code>JobExecutionListenerSupport</code> bietet <em>default</em>-Methoden für den <code>JobExecutionListener</code></p></li></ul></div>
<div class="admonitionblock note teacherBox"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">Listener sind bei Spring-Batch generell nützlich zum Zugriff auf Metadaten oder
zur Datenübergabe.</td></tr></table></div></section>
<section id="_lösung_1_jobexecutionlistener_registrieren"><h2>Lösung 1: JobExecutionListener registrieren</h2><div class="paragraph"><p>Damit ein <code>JobExecutionListener</code> aufgerufen wird, muss er beim Job registriert werden.<br>
Dafür bietet die <code>JobBuilderFactory</code> die <strong><code>listener</code></strong>-Methode:</p></div>
<pre class="CodeRay listingblock"><code class="java language-java"><span class="keyword">return</span> jobBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">helloJob</span><span class="delimiter">&quot;</span></span>)
        .start(helloStep)
        .listener(helloTasklet) <span class="comment">// Tasklet als JobExecutionListener registrieren</span>
        .build();</code></pre></section>
<section id="_lösung_2_tasklet_parameter"><h2>Lösung 2: Tasklet-Parameter</h2><div class="imageblock" style=""><img src="images/Tasklet.svg.svg" alt="Tasklet.svg" width="2110" height="184"></div>
<div class="admonitionblock note teacherBox"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">An die <code>JobParameters</code> gelangt man auch über:<br>
<code>contribution.getStepExecution().getJobParameters()</code> oder über<br>
<code>chunkContext.getStepContext().getJobParameters()</code></td></tr></table></div></section>
<section id="_aufgabe_3_job_mit_parameter"><h2>Aufgabe 3: Job mit Parameter</h2><div class="olist arabic"><ol class="arabic"><li><p>Erweiteren Sie den Hello World Job so, dass er die Parameter <code>name</code> und <code>count</code> akzeptiert.</p><div class="ulist"><ul><li><p><code>name</code> ist eine Zeichenkette (default: <em>World</em>)</p></li><li><p><code>count</code> ist eine Ganzzahl (default: <em>1</em>)</p></li></ul></div></li><li><p>Der Job soll <em>count</em> mal <em>Hello &lt;name&gt;!</em> ausgeben.</p></li></ol></div>
<div class="admonitionblock tip teacherBox"><table><tr><td class="icon"><i class="fa fa-lightbulb-o" title="Tip"></i></td><td class="content">Sie benötigen für das <code>Tasklet</code> eine eigne Klasse <code>HelloTasklet</code>, damit diese
die beiden Interfaces <code>Tasklet</code> und <code>JobExecutionListener</code> implementieren kann.</td></tr></table></div></section>
<section id="_lösung_3_job_parameter_über_expression_language"><h2>Lösung 3: Job-Parameter über Expression-Language</h2><div class="paragraph"><p>Man kann auch über Expression-Language Ausdrücke auf die Job-Parameter zugreifen:</p></div>
<pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters['name']?:'World'}</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> <span class="predefined-type">String</span> name;
<span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters['count']?:1}</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> <span class="type">int</span> count;</code></pre>
<div class="dlist"><dl><dt class="hdlist1">Problem: </dt><dd><p>Der <em>ApplicationContext</em> (und somit auch die Singleton-Beans) wird initialisiert<br>
<strong>bevor</strong> die Parameter ausgewertet werden.</p></dd><dt class="hdlist1">Lösung: </dt><dd><div class="ulist"><ul><li><p>Erzeugung der Bean muss verzögert werden</p></li><li><p><strong><code>@JobScope</code></strong> verknüpft den Lebenszyklus einer Bean mit dem Lebenszyklus eines Jobs</p></li></ul></div></dd></dl></div>
<div class="admonitionblock tip teacherBox"><table><tr><td class="icon"><i class="fa fa-lightbulb-o" title="Tip"></i></td><td class="content">Mittels <strong><code>@JobScope</code></strong> und <strong><code>@StepScope</code></strong> kann man per Expression Language auf Zwischenergebnisse
zugreifen, die erst während der Jobausführung entstehen.</td></tr></table></div></section>
<section id="_jobcontext" class="columns"><h2>JobContext</h2><div class="openblock one-col"><div class="content"><div class="paragraph"><p>Der <strong><code>JobContext</code></strong> dient dazu, Ausdrücke von Beans mit <strong><code>@JobScope</code></strong> auszuwerten.</p></div>
<div class="paragraph"><p><br></p></div></div></div>
<div class="openblock two-col"><div class="content"><div class="imageblock" style=""><img src="images/JobContext.svg.svg" alt="JobContext.svg" width="448" height="234"></div></div></div>
<div class="openblock two-col"><div class="content"><div class="paragraph"><p>Das ermöglicht Expression-Language Ausdrücke der Form:</p></div>
<pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobName}</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters[name]}</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobExecutionContext['input.file.name']}</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#{systemProperties}['java.home']</span><span class="delimiter">&quot;</span></span>)</code></pre></div></div>
<div class="admonitionblock note one-col teacherBox"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">Analoges gilt für <strong><code>@StepScope</code></strong> und <strong><code>StepContext</code></strong>.</td></tr></table></div>
<div class="admonitionblock warning one-col teacherBox"><table><tr><td class="icon"><i class="fa fa-warning" title="Warning"></i></td><td class="content">Wenn der Key ein '.' enthält, muss er in 'Anführungszeichen' gesetzt werden.</td></tr></table></div></section>
<section id="_aufgabe_4_expression_language"><h2>Aufgabe 4: Expression-Language</h2><div class="ulist"><ul><li><p>Nutzen Sie Expression-Language-Ausdrücke statt einem <code>JobExecutionListener</code>, um auf
die Parameter <code>name</code> und <code>count</code> zuzugreifen.</p></li></ul></div></section>
<section id="_testing" data-state="no-title-footer"><h2>Testing</h2><div class="paragraph center"><p>Batch-Jobs als Unit-Test ausführen</p></div></section>
<section id="_hello_world_job_als_unit_test"><h2>Hello World Job als Unit-Test</h2><div class="title">HelloJobTest.java</div><pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@SpringJUnitConfig</span>(HelloConfigParamsScope.class)
<span class="directive">public</span> <span class="type">class</span> <span class="class">HelloJobTest</span> {

    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> JobLauncher jobLauncher;

    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> Job helloJob;

    <span class="annotation">@Test</span>
    <span class="type">void</span> testHello() <span class="directive">throws</span> JobParametersInvalidException, JobExecutionAlreadyRunningException,
            JobRestartException, JobInstanceAlreadyCompleteException {
        <span class="comment">// run the job</span>
        JobParameters params = <span class="keyword">new</span> JobParametersBuilder()
                .addString(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Germany</span><span class="delimiter">&quot;</span></span>)
                .addLong(<span class="string"><span class="delimiter">&quot;</span><span class="content">count</span><span class="delimiter">&quot;</span></span>, <span class="integer">2L</span>)
                .toJobParameters();
        JobExecution execution = jobLauncher.run(helloJob, params);

        <span class="comment">// make sure job finished successfully</span>
        assertThat(execution.getAllFailureExceptions()).isEmpty();
        assertThat(execution.getExitStatus()).isEqualTo(ExitStatus.COMPLETED);
    }
}</code></pre>
<div class="admonitionblock note teacherBox"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">Genau so würde man einen Job innerhalb einer Applikation ausführen.</td></tr></table></div></section>
<section id="_manuelle_job_konfiguration"><h2>Manuelle Job-Konfiguration</h2><div class="paragraph"><p>Es geht auch ganz ohne <em>ApplicationContext</em>&#8230;&#8203;</p></div>
<div class="title">HelloJobManualTest.java</div><pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Test</span>
<span class="directive">public</span> <span class="type">void</span> testManualJobConfig() <span class="directive">throws</span> <span class="exception">Exception</span> {
    <span class="comment">// prepare infrastructure</span>
    MapJobRepositoryFactoryBean jobRepositoryFactoryBean = <span class="keyword">new</span> MapJobRepositoryFactoryBean(); <span class="comment">// deprecated</span>
    JobRepository jobRepository = jobRepositoryFactoryBean.getObject();
    PlatformTransactionManager transactionManager = <span class="keyword">new</span> ResourcelessTransactionManager();
    jobBuilderFactory = <span class="keyword">new</span> JobBuilderFactory(jobRepository);
    stepBuilderFactory = <span class="keyword">new</span> StepBuilderFactory(jobRepository, transactionManager);

    <span class="comment">// create the job</span>
    Job job = helloJob();

    <span class="comment">// create a launcher</span>
    SimpleJobLauncher launcher = <span class="keyword">new</span> SimpleJobLauncher();
    launcher.setJobRepository(jobRepository);
    launcher.afterPropertiesSet();

    <span class="comment">// launch the job</span>
    JobParameters params = <span class="keyword">new</span> JobParameters();
    JobExecution execution = launcher.run(job, params);

    <span class="comment">// make sure job finished successfully</span>
    assertThat(execution.getAllFailureExceptions()).isEmpty();
    assertThat(execution.getExitStatus()).isEqualTo(ExitStatus.COMPLETED);
}</code></pre></section>
<section id="_variante_job_und_step_scoped_beans_execution_listener"><h2>Variante: Job und Step-Scoped Beans: Execution Listener</h2><pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@ExtendWith</span>(SpringExtension.class)
<span class="annotation">@EnableBatchProcessing</span>
<span class="annotation">@SpringBatchTest</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">FlatFileItemReaderTests</span> {
        <span class="annotation">@Autowired</span>
        <span class="directive">private</span> FlatFileItemReader&lt;CustomerUpdate&gt; customerUpdateItemReader;
        <span class="directive">public</span> StepExecution getStepExecution() {
                JobParameters jobParameters = <span class="keyword">new</span> JobParametersBuilder()
                                .addString(<span class="string"><span class="delimiter">&quot;</span><span class="content">p1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">v1</span><span class="delimiter">&quot;</span></span>)
                                .toJobParameters();
                <span class="keyword">return</span> MetaDataInstanceFactory.createStepExecution(jobParameters);
        }
        <span class="annotation">@Test</span>
        <span class="directive">public</span> <span class="type">void</span> testSth()  { <span class="comment">/* ..*/</span> }
}</code></pre>
<div class="olist arabic"><ol class="arabic"><li><p>Spring batch bietet: <code>StepScopeTestExecutionListener</code>, <code>JobScopeTestExecutionListener</code></p></li><li><p><code>@SpringBatchTest</code> erzeugt Beans: <code>JobLauncherTestUtils</code>, <code>JobRepositoryTestUtils</code>, <code>StepScopeTestExecutionListener</code>, <code>JobScopeTextExecutionListener</code></p></li></ol></div></section>
<section id="_zusammenfassung_lektion_2"><h2>Zusammenfassung Lektion 2</h2><div class="ulist"><ul><li><p>Batch-Anwendung mit Spring-Initializr</p></li><li><p>Job mit CommandLineRunner verwenden</p></li><li><p>Parameterübergabe</p></li><li><p>JobExecutionListener</p></li><li><p>@JobScope</p></li><li><p>Ausführung als JUnit-Test</p></li></ul></div>
<div class="paragraph"><p><br>
&#8594; <a href="index.html">Agenda</a></p></div></section>
<section id="_lektion_3_das_spring_batch_repository" data-state="no-title-footer"><h2>Lektion 3 - Das Spring-Batch Repository</h2></section>
<section id="_überblick_zu_dieser_lektion_2"><h2>Überblick zu dieser Lektion</h2><div class="olist arabic"><ol class="arabic"><li><p>Wozu ein Repository?</p></li><li><p><a href="lesson03-repository.html#/_aufbau_eines_batch_jobs_konzeptmodell">Konzeptmodell</a>,
<a href="lesson03-repository.html#/_laufzeit_datenmodell">Laufzeitmodell</a>,
<a href="lesson03-repository.html#/_datenbank_schema">Datenbankmodell</a></p></li><li><p><a href="lesson03-repository.html#/_hsqldbverwendung_in_process">Verwendung von HSQL-DB</a>
(<a href="lesson03-repository.html#/_aufgabe_1_hello_world_mit_repository">Aufgabe 1</a>)</p></li><li><p><a href="lesson03-repository.html#/_batchstatus_vs_exitstatus">Job-Status, Exist-Status und Return-Code</a></p></li><li><p><a href="lesson03-repository.html#/_zugriff_auf_jobrepository">Zugriff auf JobRepository</a>
(<a href="lesson03-repository.html#/_aufgabe_2_jobexplorer_verwenden">Aufgabe 2</a>)</p></li><li><p><a href="lesson03-repository.html#/_jobparametersincrementerrunidincrementer">Mehr Details zu Job-Parametern</a></p></li><li><p><a href="lesson03-repository.html#/_zust%C3%A4nde_eines_jobs">Job-Steuerung (Wiederanlauf)</a>
(<a href="lesson03-repository.html#/_aufgabe_3_job_verwalten">Aufgabe 3</a>)</p></li><li><p><a href="lesson03-repository.html#/_joboperatorapi">JobOperator-API</a>
(<a href="http://localhost:8071/lesson03-repository.html#/_aufgabe_4_optional_joboperator_verwenden">Aufgabe 4</a>)</p></li></ol></div></section>
<section id="_wozu_ein_jobrepository"><h2>Wozu ein JobRepository?</h2><div class="ulist"><ul><li class="fragment"><p>Protokollierung</p></li><li class="fragment"><p>Wiederanlauf</p></li><li class="fragment"><p>Überwachung</p></li><li class="fragment"><p>Steuerung</p></li><li class="fragment"><p>Falls diese Punkte keine Rolle spielen&#8230;&#8203;<br></p><div class="admonitionblock note teacherBox"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content"><code>MapJobRepository</code> (<strong>deprecated!</strong>) kann als Platzhalter verwendet werden</td></tr></table></div></li></ul></div></section>
<section id="_aufbau_eines_batch_jobs_konzeptmodell"><h2>Aufbau eines Batch-Jobs (Konzeptmodell)</h2><div class="imageblock" style=""><img src="images/BatchJobKonzeptmodell.svg" alt="BatchJobKonzeptmodell" width="890" height="566"></div></section>
<section id="_laufzeit_datenmodell"><h2>Laufzeit-Datenmodell</h2><div class="imageblock" style=""><img src="images/JobLaufzeitmodell.svg" alt="JobLaufzeitmodell" width="1698" height="566"></div></section>
<section id="_datenbank_schema"><h2>Datenbank-Schema</h2><div class="imageblock" style=""><img src="images/repository/Repository.png" alt="Repository" width="100%"></div>
<div class="admonitionblock note teacherBox"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">Alle Tabellennamen haben standardmäßig den Präfix <em>BATCH_</em>. Dieser ist konfigurierbar.</td></tr></table></div></section>
<section id="_hsqldb"><h2>HSQLDB</h2><div class="paragraph heading"><p>HSQLDB in Stichworten</p></div>
<div class="ulist"><ul><li><p>Freie, vollständig in Java programmierte relationale SQL-Datenbank</p></li><li><p>Bestandteil von OpenOffice und LibreOffice</p></li><li><p>Sehr schlank (nur ein JAR)</p></li><li><p>Als In-Memory-Datenbank verwendbar (nützlich für Tests)</p></li></ul></div></section>
<section id="_hsqldbverwendung_in_process"><h2>HSQLDB&#8201;&#8212;&#8201;Verwendung <em>In-Process</em></h2><div class="paragraph"><p>Notwendige Abhängigkeit:</p></div>
<pre class="CodeRay listingblock"><code class="xml language-xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.hsqldb<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>hsqldb<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;scope&gt;</span>runtime<span class="tag">&lt;/scope&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
<table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:50%"><col style="width:50%"></colgroup><thead><tr><th class="tableblock halign-left valign-top">JDBC-URL (Beispiel)</th><th class="tableblock halign-left valign-top">Verwendungszweck</th></tr><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">jdbc:hsqldb:mem:mymemdb</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">In-Memory Datenbank</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">jdbc:hsqldb:file:mydir/standalonedb</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Standanlone Datenbank</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">jdbc:hsqldb:hsql://localhost/xdb</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Datenbank-Server</p></td></tr></table></section>
<section id="_hsqldbverwendung_als_server"><h2>HSQLDB&#8201;&#8212;&#8201;Verwendung als Server</h2><div class="dlist"><dl><dt class="hdlist1">Aufruf: </dt><dd><pre class="CodeRay listingblock"><code>java -cp hsqldb-2.5.0.jar org.hsqldb.server.Server --database.0 file:mydb --dbname.0 xdb --silent false</code></pre></dd><dt class="hdlist1">Aufruf über das Maven-Projekt <em>hsqldb-server</em>: </dt><dd><pre class="CodeRay listingblock"><code>mvn</code></pre>
<div class="paragraph"><p>bzw. in einem neuen Konsolen-Fenster:</p></div>
<pre class="CodeRay listingblock"><code>start mvn</code></pre></dd><dt class="hdlist1">JDBC-URL: </dt><dd><pre class="CodeRay listingblock"><code>jdbc:hsqldb:hsql://localhost/xdb</code></pre></dd></dl></div>
<div class="paragraph"><p><a href="http://hsqldb.org/doc/guide/running-chapt.html">&#8594; HSQLDB Guide:Running and Using HyperSQL</a></p></div></section>
<section id="_hsqldbdatenbank_management_tool"><h2>HSQLDB&#8201;&#8212;&#8201;Datenbank Management Tool</h2><div class="dlist"><dl><dt class="hdlist1">Aufruf: </dt><dd><pre class="CodeRay listingblock"><code>java -cp hsqldb-2.5.0.jar org.hsqldb.util.DatabaseManagerSwing</code></pre></dd><dt class="hdlist1">Aufruf über das Maven-Projekt <em>hsqldb-server</em>: </dt><dd><pre class="CodeRay listingblock"><code>mvn exec:java@ui</code></pre></dd><dt class="hdlist1">Initialer Login: </dt><dd><table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:50%"><col style="width:50%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">Username</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">"<strong>SA</strong>"</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">Passwort</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">""</p></td></tr></table></dd></dl></div>
<div class="paragraph"><p><br></p></div>
<div class="dlist"><dl><dt class="hdlist1">Mögliche Alternativen: </dt><dd><div class="ulist"><ul><li><p>Datenbank Management Tool der jeweiligen IDE</p></li><li><p><a href="http://squirrel-sql.sourceforge.net/">&#8594; SQuirreL SQL Client</a></p></li></ul></div></dd></dl></div></section>
<section id="_hsqldbkonfiguration_einer_spring_datasource" class="columns"><h2>HSQLDB&#8201;&#8212;&#8201;Konfiguration einer Spring-Datasource</h2><div class="openblock top"><div class="content"><div class="paragraph"><p>Abhängigkeit für Connection-Pool:</p></div>
<pre class="CodeRay listingblock"><code class="xml language-xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>com.zaxxer<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>HikariCP<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
<div class="paragraph"><p>Altenativ der <em>DBCP2 Connection Pool</em>:</p></div>
<pre class="CodeRay listingblock"><code class="xml language-xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.apache.commons<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>commons-dbcp2<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre></div></div>
<div class="openblock top"><div class="content"><div class="paragraph"><p>Deklaration der DataSource:</p></div>
<pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Configuration</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">DataSourceConfig</span> {

    <span class="annotation">@Bean</span>
    HikariDataSource dataSource() {
        HikariConfig config = <span class="keyword">new</span> HikariConfig();
        config.setJdbcUrl(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:hsqldb:hsql://localhost/xdb</span><span class="delimiter">&quot;</span></span>);
        config.setUsername(<span class="string"><span class="delimiter">&quot;</span><span class="content">SA</span><span class="delimiter">&quot;</span></span>);
        config.setPassword(<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>);

        HikariDataSource ds = <span class="keyword">new</span> HikariDataSource(config);
        <span class="keyword">return</span> ds;
    }
}</code></pre></div></div>
<div class="paragraph one-col"><p>Für <strong>Spring-Boot</strong> genügen folgende Einträge in der <em>application.properties</em>:</p></div>
<pre class="CodeRay listingblock"><code>spring.datasource.url=jdbc:hsqldb:hsql://localhost/xdb
spring.datasource.username=SA
spring.datasource.password=

spring.batch.jdbc.initialize-schema=always</code></pre></section>
<section id="_hsqldbschema_für_spring_batch_respository_anlegen"><h2>HSQLDB&#8201;&#8212;&#8201;Schema für Spring-Batch Respository anlegen</h2><div class="paragraph"><p>In <code>spring-batch-core-x.y.z.RELEASE.jar</code> findet man im Verzeichnis<br>
<em>/org/springframework/batch/core</em> für diverse Datenbanksysteme<br>
Skripte zum Anlegen des Schemas.</p></div>
<div class="paragraph"><p>Für Testzwecke legt man das Schema am einfachsten über einen Unittest an:</p></div>
<pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@SpringJUnitConfig</span>(DataSourceConfig.class)
<span class="directive">public</span> <span class="type">class</span> <span class="class">SpringBatchSchemaSetup</span> {

    <span class="annotation">@Test</span>
    <span class="annotation">@Sql</span>(scripts = <span class="string"><span class="delimiter">&quot;</span><span class="content">/org/springframework/batch/core/schema-hsqldb.sql</span><span class="delimiter">&quot;</span></span>,
         statements = { <span class="string"><span class="delimiter">&quot;</span><span class="content">SET DATABASE TRANSACTION CONTROL MVCC</span><span class="delimiter">&quot;</span></span>,
                        <span class="string"><span class="delimiter">&quot;</span><span class="content">SET PROPERTY </span><span class="char">\&quot;</span><span class="content">sql.enforce_strict_size</span><span class="char">\&quot;</span><span class="content"> TRUE</span><span class="delimiter">&quot;</span></span> })
    <span class="type">void</span> initSchema() {
    }
}</code></pre>
<div class="admonitionblock note teacherBox"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">Standardmäßig haben alle Spring-Batch Tabellen den Präfix <strong><code>BATCH_</code></strong>.
Diesen Wert kann man ändern, siehe
<a href="https://docs.spring.io/spring-batch/docs/4.3.x/api/org/springframework/batch/core/repository/support/JobRepositoryFactoryBean.html#setTablePrefix-java.lang.String-">
&#8594; JobRepositoryFactoryBean</a>. Dafür muss man das JobRepository selbst erzeugen, siehe
<a href="https://docs.spring.io/spring-batch/docs/4.3.x/api/org/springframework/batch/core/configuration/annotation/DefaultBatchConfigurer.html#createJobRepository--">
&#8594; DefaultBatchConfigurer.createJobRepository()</a>.</td></tr></table></div></section>
<section id="_aufgabe_1_hello_world_mit_repository"><h2>Aufgabe 1: Hello World mit Repository</h2><div class="olist arabic"><ol class="arabic"><li><p>Starten Sie den HSQLDB-Server, legen Sie das Schema an und prüfen Sie, ob die Tabellen vorhanden sind.</p></li><li><p>Importieren Sie die <code>DataSourceConfig</code> in die HelloWorld-Configuration und führen Sie den Job aus.</p></li><li><p>Welche Einträge finden Sie nach der Ausführung in den Tabellen?</p></li><li><p>Was passiert wenn Sie den Job erneut (mit gleichen oder unterschiedlichen Parametern) ausführen?</p></li></ol></div></section>
<section id="_batchstatus_vs_exitstatus"><h2>BatchStatus vs. ExitStatus</h2><div class="paragraph"><p>Beide Tabellen <code>BATCH_JOB_EXECUTION</code> und <code>BATCH_STEP_EXECUTION</code> haben<br>
die Spalten <code>STATUS</code> und <code>EXIT_CODE</code>:</p></div>
<div class="imageblock" style=""><img src="images/StatusClasses.svg" alt="StatusClasses" width="1850" height="508"></div></section>
<section id="_return_code"><h2>Return-Code</h2><div class="ulist"><ul><li><p>Um Batch-Jobs auf Befehlszeile zu starten, werden oft <em>Enterprise Scheduler</em> verwendet.</p></li><li><p>Diese können meistens nur den Return-Code eines Shell-Skripts auswerten.</p></li><li><p>Der <code>CommandLineJobRunner</code> wandelt den <code>ExitStatus</code> eines Jobs mit einem <code>ExitCodeMapper</code> um.</p></li><li><p>Standardmäßig wird dafür der <code>SimpleJvmExitCodeMapper</code> verwendet.</p></li><li><p>Um einen eigenen <code>ExitCodeMapper</code> zu verwenden, genügt es eine entsprechende Bean zu definieren:</p><pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Bean</span>
ExitCodeMapper exitCodeMapper() {
    <span class="keyword">return</span> exitCode -&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">COMPLETED</span><span class="delimiter">&quot;</span></span>.equals(exitCode) ? <span class="integer">42</span> : -<span class="integer">13</span>;
}</code></pre></li><li><p>Spring-Boot wertet den <code>ExitCodeMapper</code> standardmäßig nicht aus.</p></li></ul></div>
<div class="admonitionblock note teacherBox"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">Der <code>CommandLineJobRunner</code> wird aus dem angegeben <em>ApplicationContext</em> per Autowiring initialsiert.</td></tr></table></div></section>
<section id="_return_code_bei_spring_boot"><h2>Return-Code bei Spring-Boot</h2><div class="ulist"><ul><li><p>Mit dem <code>ExitCodeExceptionMapper</code> kann man Exceptions einen Return-Code zuordnen.</p></li><li><p>Folgender Listener wertet den <code>ExitCodeMapper</code> aus:</p></li></ul></div>
<pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ExitCodeJobExecutionEventListener</span>
        <span class="directive">implements</span> ApplicationListener&lt;JobExecutionEvent&gt;, ExitCodeGenerator, InitializingBean {

    <span class="annotation">@Autowired</span>(required = <span class="predefined-constant">false</span>)
    <span class="directive">private</span> ExitCodeMapper exitCodeMapper;
    <span class="directive">private</span> <span class="type">int</span> exitCode;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> afterPropertiesSet() {
        <span class="keyword">if</span> (exitCodeMapper == <span class="predefined-constant">null</span>) {
            exitCodeMapper = <span class="keyword">new</span> SimpleJvmExitCodeMapper();
        }
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> onApplicationEvent(JobExecutionEvent event) { <span class="comment">// alternativ: @EventListener</span>
        ExitStatus exitStatus = event.getJobExecution().getExitStatus();
        exitCode = exitCodeMapper.intValue(exitStatus.getExitCode());
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">int</span> getExitCode() {
        <span class="keyword">return</span> exitCode;
    }
}</code></pre></section>
<section id="_return_code_bei_spring_boot_system_exit"><h2>Return-Code bei Spring-Boot (System.exit)</h2><div class="paragraph"><p>Damit der zuvor gezeigte <code>ExitCodeJobExecutionEventListener</code> funktioniert muss die <code>main</code> Methode der
Spring-Boot Angepasst werden:</p></div>
<pre class="CodeRay listingblock"><code class="java language-java"><span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
        <span class="predefined-type">System</span>.exit(
                        SpringApplication.exit(
                                        SpringApplication.run(HelloBootApplication.class, args)));
}</code></pre></section>
<section id="_zugriff_auf_jobrepository" class="columns"><h2>Zugriff auf JobRepository</h2><div class="imageblock two-col" style=""><img src="images/repository/job-repository-advanced.png" alt="job repository advanced" width="1000px"></div>
<div class="openblock two-col top"><div class="content"><div class="ulist"><ul><li><p>Zu jedem dieser Interfaces existiert eine <strong><code>SimpleJob&#8230;&#8203;</code></strong> Implementierung, die in der Regel verwendet wird.</p></li><li><p>Die <code>SimpleBatchConfiguration</code>, welche via <code>@EnableBatchProcessing</code> eingebunden wird,
legt keinen <code>JobOperator</code> an.</p></li></ul></div></div></div></section>
<section id="_jobexplorer"><h2>JobExplorer</h2><div class="paragraph"><p>Der <code>JobExplorer</code> bietet eine komfortable API zum Zugriff auf das Repository.</p></div>
<div class="imageblock" style=""><img src="images/JobExplorer.svg.svg" alt="JobExplorer.svg" width="1020" height="412"></div></section>
<section id="_aufgabe_2_jobexplorer_verwenden"><h2>Aufgabe 2: JobExplorer verwenden</h2><div class="paragraph"><p>Schreiben Sie einen Unit-Test, der über System.out alle JobExecutions und die zugehörigen Steps
aus dem Repository ausgibt.
Geben Sie dafür jeweils den Namen, den Startzeitpunkt, den Status und den Exit-Code aus.</p></div>
<div class="paragraph"><p>Verwenden Sie folgendes Grundgerüst:</p></div>
<pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@SpringJUnitConfig</span>(HelloRepositoryConfig.class)
<span class="directive">public</span> <span class="type">class</span> <span class="class">JobExplorerSample</span> {

    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> JobExplorer jobExplorer;

}</code></pre></section>
<section id="_jobparametersincrementerrunidincrementer"><h2>JobParametersIncrementer&#8201;&#8212;&#8201;RunIdIncrementer</h2><div class="ulist"><ul><li><p>Der <code>RunIdIncrementer</code> ergänzt jeden Aufruf um einen <strong><code>run.id</code></strong> Parameter</p></li><li><p>Als Wert wird eine fortlaufend hochgezählte Zahl übergeben</p></li><li><p>Dadurch kann man einen Job mit sonst gleichen <strong>identifizierenden</strong> Parametern erneut ausführen</p></li></ul></div>
<pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Bean</span>
RunIdIncrementer incrementer() {
    <span class="keyword">return</span> <span class="keyword">new</span> RunIdIncrementer();
}

<span class="annotation">@Bean</span>
Job helloJob() {
    Job job = jobBuilderFactory
            .get(<span class="string"><span class="delimiter">&quot;</span><span class="content">helloIncrementerJob</span><span class="delimiter">&quot;</span></span>)
            .start(helloStep())
            .incrementer(incrementer()) <span class="comment">// Bei jedem Start run.id hochzählen</span>
            .preventRestart() <span class="comment">// Erneuten Start von fehlgeschlagenen Jobs verhindern</span>
            .build();
    <span class="keyword">return</span> job;
}</code></pre>
<div class="paragraph"><p>Verwendung mit einem <strong><code>JobLauncher</code></strong>:</p></div>
<pre class="CodeRay listingblock"><code class="java language-java">JobParameters jobParameters = <span class="keyword">new</span> JobParametersBuilder(jobExplorer)
        .getNextJobParameters(helloJob) <span class="comment">// Nächste run.id beschaffen</span>
        .toJobParameters();
JobExecution jobExecution = jobLauncher.run(helloJob, jobParameters);</code></pre></section>
<section id="_zustände_eines_jobs" class="columns"><h2>Zustände eines Jobs</h2><div class="openblock two-col top"><div class="content"><div class="paragraph"><p>Ein Job kann folgende Zustände (<code>BatchStatus</code>) annehmen:</p></div>
<div class="imageblock" style=""><img src="images/StatusTransitions.svg" alt="StatusTransitions" width="751" height="481"></div></div></div>
<div class="openblock two-col top"><div class="content"><div class="paragraph"><p>Die <strong><code>CommandLineJobRunner</code></strong> Optionen:</p></div>
<table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:25%"><col style="width:75%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">-restart</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Die letzte fehlgeschlagene Ausführung erneut starten (mit den gleichen Parametern) oder
          einen gestoppten Job fortsetzen</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">-stop</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Den laufenden Job anhalten</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">-abandon</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Den Job stilllegen</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">-next</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Den nächsten Job entsprechend dem <code>JobParametersIncrementer</code> ausführen</p></td></tr></table></div></div>
<div class="admonitionblock warning teacherBox"><table><tr><td class="icon"><i class="fa fa-warning" title="Warning"></i></td><td class="content">Wenn der Prozess mit <strong><code>kill -9</strong></code> abgebrochen wurde hat er den Status <strong><code>STARTED</strong></code>.</td></tr></table></div></section>
<section id="_aufgabe_3_job_verwalten"><h2>Aufgabe 3: Job verwalten</h2><div class="olist arabic"><ol class="arabic"><li><p>Führen Sie <code>LongRunningJobConfig</code> mit dem <code>CommandLineJobRunner</code> aus.</p></li><li><p>Lernen Sie die Jobsteuerung kennen:</p><div class="ulist"><ul><li><p>Starten Sie den Job mit unterschiedlichen Parametern für <strong><code>stop.at</code></strong> und <strong><code>fail.at</code></strong></p></li><li><p>Verwenden Sie die Optionen <em>-restart</em>, <em>-stop</em>, <em>-abandon</em> (mit einem 2. Prozess)</p></li><li><p>Nutzen Sie die Lösung aus der Vorherigen Aufgabe (oder ein Datenbanktool) um sich
die Auswirkungen auf das Repository anzusehen.</p></li><li><p>Was passiert mit Parametern bei <em>-restart</em>?</p></li><li><p>Welche Auswirkung hat ein <code>preventRestart()</code> bei der Job-Konfiguration?</p></li></ul></div></li><li><p>Sammeln Sie Erfahrung mit dem <code>RunIdIncrementer</code></p><div class="ulist"><ul><li><p>Ergänzen Sie <code>LongRunningJobConfig</code> um einen <code>RunIdIncrementer</code></p></li><li><p>Führen Sie den Job mit <em>-next</em> aus.</p></li><li><p>Optional: Bauen Sie einen Unittest, der den Job mit einem <code>JobLauncher</code> ausführt</p></li></ul></div></li></ol></div></section>
<section id="_joboperatorapi" class="center"><h2>JobOperator&#8201;&#8212;&#8201;API</h2><div class="paragraph"><p>Der <strong><code>JobOperator</code></strong> bietet eine API zur Verwaltung von Jobs:</p></div>
<div class="imageblock" style=""><img src="images/JobOperator.svg.svg" alt="JobOperator.svg" width="1932" height="638"></div></section>
<section id="_joboperator_konfigurieren"><h2>JobOperator konfigurieren</h2><div class="paragraph"><p>Da mit <strong><code>@EnableBatchProcessing</code></strong> kein JobOperator angelegt wird,<br>
muss dieser explizit konfiguriert werden:</p></div>
<div class="title">OperatorConfig.java</div><pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Bean</span>
SimpleJobOperator jobOperator() {
    SimpleJobOperator operator = <span class="keyword">new</span> SimpleJobOperator();
    operator.setJobLauncher(jobLauncher);
    operator.setJobExplorer(jobExplorer);
    operator.setJobRegistry(jobRegistry);
    operator.setJobRepository(jobRepository);
    <span class="keyword">return</span> operator;
}

<span class="annotation">@Bean</span>
JobRegistryBeanPostProcessor jobRegistryBeanPostProcessor() {
    JobRegistryBeanPostProcessor postProcessor = <span class="keyword">new</span> JobRegistryBeanPostProcessor();
    postProcessor.setJobRegistry(jobRegistry);
    <span class="keyword">return</span> postProcessor;
}</code></pre>
<div class="admonitionblock note teacherBox"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">Mit <code>@EnableBatchProcessing</code> wird zwar eine <code>JobRegistry</code> angelegt, aber nicht befüllt.
Der <code>JobRegistryBeanPostProcessor</code> registiert jeden Job in der <code>JobRegistry</code>.
Das ist notwendig, um mit dem <code>JobOperator</code> einen Job über den Namen anzusprechen.</td></tr></table></div></section>
<section id="_joboperator_verwenden"><h2>JobOperator verwenden</h2><div class="paragraph"><p>Einen so konfigurierten JobOperator kann man für die Verwaltung von Jobs nutzen:</p></div>
<div class="title">OperatorTest.java</div><pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Autowired</span>
<span class="directive">private</span> JobOperator jobOperator;

<span class="annotation">@Test</span>
<span class="type">void</span> testJobOperator() <span class="directive">throws</span> <span class="exception">Exception</span> {
    <span class="predefined-type">Long</span> executionId = jobOperator.startNextInstance(<span class="string"><span class="delimiter">&quot;</span><span class="content">helloIncrementerJob</span><span class="delimiter">&quot;</span></span>);
    <span class="predefined-type">System</span>.out.println(jobOperator.getSummary(executionId));
    <span class="predefined-type">System</span>.out.println(jobOperator.getStepExecutionSummaries(executionId));
}</code></pre></section>
<section id="_zusammenfassung_lektion_3"><h2>Zusammenfassung Lektion 3</h2><div class="ulist"><ul><li><p>JobRepository für Protokollierung, Wiederanlauf, Überwachung und Steuerung von Jobs</p></li><li><p>Konzeptmodell, Laufzeitmodell, Datenbankmodell</p></li><li><p>Verwendung von HSQL-DB</p></li><li><p><code>BatchStatus</code>, <code>ExitStatus</code> und Return-Code</p></li><li><p>Explorer, Launcher und Operations</p></li><li><p>(Identifizierende) Parameter und <code>RunIdIncrementer</code></p></li><li><p>Job-Steuerung mit <code>CommandLineJobRunner</code> und <code>JobOperations</code></p></li></ul></div></section>
<section id="_aufgabe_4_optional_joboperator_verwenden"><h2>Aufgabe 4 (optional): JobOperator verwenden</h2><div class="paragraph"><p>Erstellen Sie eine Konfiguration für den <code>JobOperator</code> und nutzen Sie diese, um den HelloJob
mit einem Unittest auszuführen.</p></div>
<div class="paragraph"><p><br>
&#8594; <a href="index.html">Agenda</a></p></div></section>
<section id="_lektion_4_transaktionen_und_fehlerbehandlung" data-state="no-title-footer"><h2>Lektion 4 - Transaktionen und Fehlerbehandlung</h2></section>
<section id="_überblick_zu_dieser_lektion_3"><h2>Überblick zu dieser Lektion</h2><div class="olist arabic"><ol class="arabic"><li><p><a href="lesson04-chunks.html#/_readerprocessorwriter">Reader, Processor und Writer</a></p></li><li><p><a href="lesson04-chunks.html#/_transaktionen_bei_der_batchverarbeitung">Chunk-Verarbeitung</a>,
<a href="lesson04-chunks.html#/_chunkorientedtasklet">ChunkOrientedTasklet</a></p></li><li><p><a href="lesson04-chunks.html#/_fehler_bei_der_batchverarbeitung">Fehlertoleranz</a>,
<a href="lesson04-chunks.html#/_retrytemplatenoch_ein_framework_f%C3%BCr_eine_schleife">RetryTemplate</a></p></li><li><p><a href="lesson04-chunks.html#/_komponenten_zur_job_konfiguration">Job-Konfiguration im Detail</a></p></li><li><p><a href="lesson04-chunks.html#/_listener_interfaces">Listener Interfaces</a>
(<a href="lesson04-chunks.html#/_aufgabe_teil_a">Aufgabe</a>)</p></li></ol></div></section>
<section id="_typischer_ablauf_eines_batch_jobs_2"><h2>Typischer Ablauf eines Batch-Jobs</h2><div class="imageblock" style=""><img src="images/typischer_batch_job_ablauf.svg" alt="typischer batch job ablauf" width="540" height="680"></div></section>
<section id="_definition_eines_typischen_batch_jobs"><h2>Definition eines typischen Batch-Jobs</h2><div class="ulist"><ul><li><p>Spring-Batch definiert die Interfaces</p><div class="ulist"><ul><li><p><code>ItemReader&lt;T&gt;</code></p></li><li><p><code>ItemProcessor&lt;I,O&gt;</code> und</p></li><li><p><code>ItemWriter&lt;T&gt;</code>.</p></li></ul></div></li><li><p>Diese Interfaces kann man in eine Job-Konfiguration einbinden</p></li><li><p>Alternativ kann man auch die entsprechenden <strong>JSR-352</strong> Interfaces implementieren</p></li></ul></div>
<div class="admonitionblock tip teacherBox"><table><tr><td class="icon"><i class="fa fa-lightbulb-o" title="Tip"></i></td><td class="content">Eigene Implementierung möglichst unabhängig vom Framework-Code halten.</td></tr></table></div>
<aside class="notes"><p>Praktisch alles, was man für eine eigene Implementierung benötigt, liegt in
<code>spring-batch-infrastructure</code>. Nur die Job-Konfiguration sollte eine
Abhängigkeit zu <code>spring-batch-core</code> benötigen. Das kann man über <em>ArchUnit</em>-Tests,
ein Multi-Module-Projekt oder XML basierte Konfiguration sicherstellen.</p></aside></section>
<section id="_readerprocessorwriter" class="columns center top"><h2>Reader&#8201;&#8212;&#8201;Processor&#8201;&#8212;&#8201;Writer</h2><div class="openblock"><div class="content"><div class="paragraph lead"><p>Spring-Batch</p></div>
<div class="imageblock" style=""><img src="images/ReaderWriter.svg.svg" alt="ReaderWriter.svg" width="632" height="620"></div>
<div class="ulist"><ul><li><p>Spring-Batch verwendet Generics</p></li><li><p>Spring-Batch unterstützt JSR-352</p></li></ul></div></div></div>
<div class="openblock"><div class="content"><div class="paragraph lead"><p>JSR-352</p></div>
<div class="imageblock" style=""><img src="images/JsrReaderWriter.svg.svg" alt="JsrReaderWriter.svg" width="556" height="772"></div></div></div></section>
<section id="_vereinfachter_batch_ablauf_mit_reader_processor_und_writer" class="columns"><h2>Vereinfachter Batch-Ablauf mit Reader, Processor und Writer</h2><div class="imageblock" style=""><img src="images/simplified_reader_writer.svg" alt="simplified reader writer" width="676" height="434"></div>
<div class="openblock"><div class="content"><div class="paragraph lead"><p>Rückgabewerte/Verhalten:</p></div>
<div class="dlist"><dl><dt class="hdlist1">null bei read: </dt><dd><p>Markiert Ende der Verarbeitung</p></dd><dt class="hdlist1">null bei process: </dt><dd><p>Überspringt Datensatz (wird nicht geschrieben)</p></dd><dt class="hdlist1">Exception: </dt><dd><p>Markiert Datensatz als Fehlerhaft<br>
(Was damit geschieht, hängt von der Konfiguration ab)</p></dd></dl></div></div></div></section>
<section id="_beispielimplementierung_simplereader"><h2>Beispielimplementierung: SimpleReader</h2><div class="title">SimpleReader.java</div><pre class="CodeRay listingblock"><code class="java language-java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SimpleReader</span> <span class="directive">implements</span> ItemReader&lt;<span class="predefined-type">Integer</span>&gt; {
    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">Iterator</span>&lt;<span class="predefined-type">Integer</span>&gt; iter;

    <span class="directive">public</span> SimpleReader(<span class="type">int</span> numItems) {
        iter = IntStream.rangeClosed(<span class="integer">1</span>, numItems).boxed().iterator();
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">Integer</span> read() {
        <span class="keyword">return</span> iter.hasNext() ? iter.next() : <span class="predefined-constant">null</span>;
    }
}</code></pre></section>
<section id="_beispielimplementierung_simpleprocessor"><h2>Beispielimplementierung: SimpleProcessor</h2><div class="title">SimpleProcessor.java</div><pre class="CodeRay listingblock"><code class="java language-java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SimpleProcessor</span> <span class="directive">implements</span> ItemProcessor&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>&gt; {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> process(<span class="predefined-type">Integer</span> item) {
        <span class="keyword">return</span> <span class="predefined-type">String</span>.format(<span class="string"><span class="delimiter">&quot;</span><span class="content">Item %03d</span><span class="delimiter">&quot;</span></span>, item);
    }

}</code></pre></section>
<section id="_beispielimplementierung_simplewriter"><h2>Beispielimplementierung: SimpleWriter</h2><div class="title">SimpleWriter.java</div><pre class="CodeRay listingblock"><code class="java language-java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SimpleWriter</span> <span class="directive">implements</span> ItemWriter&lt;<span class="predefined-type">String</span>&gt; {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> write(<span class="predefined-type">List</span>&lt;? <span class="directive">extends</span> <span class="predefined-type">String</span>&gt; items) {
        <span class="predefined-type">System</span>.out.println(items.stream().collect(Collectors.joining(<span class="string"><span class="delimiter">&quot;</span><span class="content">, </span><span class="delimiter">&quot;</span></span>)));
    }

}</code></pre>
<div class="admonitionblock note teacherBox"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">Writer verarbeitet eine Liste von Items.</td></tr></table></div></section>
<section id="_beispielimplementierung_simplejobconfig"><h2>Beispielimplementierung: SimpleJobConfig</h2><div class="title">SimpleJobConfig.java</div><pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Bean</span>
Job simpleJob() {
    Step simpleStep = stepBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">simpleStep</span><span class="delimiter">&quot;</span></span>)
            .&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>&gt;chunk(<span class="integer">1</span>)
            .reader(simpleReader())
            .processor(simpleProcessor())
            .writer(simpleWriter())
            .build();

    <span class="keyword">return</span> jobBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">simpleJob</span><span class="delimiter">&quot;</span></span>).start(simpleStep).build();
}</code></pre></section>
<section id="_transaktionen_bei_der_batchverarbeitung"><h2>Transaktionen bei der Batchverarbeitung</h2><div class="paragraph"><p>Möglichkeiten der Verarbeitung:</p></div>
<div class="ulist"><ul><li class="fragment"><p>Eine Transaktion für jeden einzelnen Datensatz</p></li><li class="fragment"><p>&#8658; zu langsam</p></li><li class="fragment"><p>Alle Datensätze in einer Transaktion schreiben</p></li><li class="fragment"><p>&#8658; zu fehleranfällig, bei großen Datenmengen nicht machbar</p></li><li class="fragment"><p>Lösung: Daten <strong>Chunk</strong>-weise verarbeiten</p></li></ul></div></section>
<section id="_step_mit_repeattemplate_und_transactionmanager"><h2>Step mit RepeatTemplate und TransactionManager</h2><div class="imageblock" style=""><img src="images/TaskletStep.svg" alt="TaskletStep" width="1952" height="592"></div></section>
<section id="_step_mit_einzelnem_tasklet" class="columns"><h2>Step mit einzelnem Tasklet</h2><div class="imageblock" style=""><img src="images/repeat_tasklet.svg" alt="repeat tasklet" width="792" height="434"></div>
<div class="openblock"><div class="content"><div class="ulist"><ul><li class="fragment"><p>Iteriert wird mit dem <code>RepeatTemplate</code></p></li><li class="fragment"><p>Das Tasklet wird innerhalb einer Transaktion ausgeführt</p></li><li class="fragment"><p>&#8658; Für Chunkverarbeitung müsste Tasklet über<br>
die Elemente eines Chunks iterieren</p></li></ul></div></div></div></section>
<section id="_chunkorientedtasklet"><h2>ChunkOrientedTasklet</h2><div class="imageblock" style=""><img src="images/ChunkOrientedTasklet.svg" alt="ChunkOrientedTasklet" width="1972" height="566"></div></section>
<section id="_chunkverarbeitung_mit_dem_chunkorientedtasklet"><h2>Chunkverarbeitung mit dem ChunkOrientedTasklet</h2><div class="imageblock" style=""><img src="images/ChunkExec.svg" alt="ChunkExec" width="2398" height="790"></div></section>
<section id="_fehler_bei_der_batchverarbeitung" class="top"><h2>Fehler bei der Batchverarbeitung</h2><div class="ulist"><ul><li><p>Welche Fehler sind bei der Batchverarbeitung zu erwarten?</p></li><li><p>Wie soll damit umgegangen werden?</p></li></ul></div>
<table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:50%"><col style="width:50%"></colgroup><thead><tr><th class="tableblock halign-left valign-top">Fehler</th><th class="tableblock halign-left valign-top">Umgang</th></tr><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td></tr></table></section>
<section id="_beispiele_für_fehler"><h2>Beispiele für Fehler</h2><table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:33.3333%"><col style="width:33.3333%"><col style="width:33.3334%"></colgroup><thead><tr><th class="tableblock halign-left valign-top">Datensatz überpringen</th><th class="tableblock halign-left valign-top">Erneut versuchen</th><th class="tableblock halign-left valign-top">Job abbrechen</th></tr><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">Programmierfehler</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Verbindungsunterbrechung</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Systemausfall</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">Ungültiges Zeichen in Datensatz</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Neustart eines Servers</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Fehlende Berechtigung</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">Datei defekt</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Datensatz gesperrt</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Nicht berücksichtigte Exception</p></td></tr></table>
<div class="admonitionblock note teacherBox"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">Das erwünschte Fehlerverhalten gibt man bei der Job-Konfiguration an.</td></tr></table></div></section>
<section id="_konfiguration_eines_fehlertoleranten_jobs"><h2>Konfiguration eines fehlertoleranten Jobs</h2><div class="title">SkipSimulatorJobConfig.java</div><pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Bean</span>
TaskletStep skipSimulationStep() {
    <span class="keyword">return</span> stepBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">skip-simulation-step</span><span class="delimiter">&quot;</span></span>)
            .listener(logListener())
            .&lt;Ball, Ball&gt;chunk(<span class="integer">6</span>)
            .reader(ballContainer())
            .processor(ballProcessor())
            .writer(ballContainer())
            .faultTolerant().skip(InvalidBallException.class).skipLimit(<span class="integer">3</span>)
            .build();
}</code></pre>
<div class="olist arabic"><div class="title">Der Job &#8230;&#8203;</div><ol class="arabic"><li><p>verarbeitet Chunks der Größe 6,</p></li><li><p>ist fehlertolerant gegenüber <code>InvalidBallException</code> und</p></li><li><p>bricht nach 3 Exceptions ab.</p></li></ol></div></section>
<section id="_simulation_fehler_bei_chunkverarbeitung"><h2>Simulation: Fehler bei Chunkverarbeitung</h2><div class="paragraph"><p><span class="image"><img src="images/chunk/SkipSimulator.png" alt="SkipSimulator"></span></p></div>
<div class="ulist"><div class="title">Installationsvoraussetzungen:</div><ul><li><p>JavaFX-SDK muss installiert sein &#8594; <a href="https://gluonhq.com/products/javafx/" class="bare">https://gluonhq.com/products/javafx/</a></p></li><li><p>Variable <em>PATH_TO_FX</em> muss auf das <strong>lib</strong>-Verzeichnis des SDK zeigen (Eclipse)</p></li><li><p>Aufruf mit <em>VM arguments</em>:</p><pre class="CodeRay listingblock"><code>--module-path ${PATH_TO_FX}
--add-modules javafx.controls,javafx.fxml</code></pre></li><li><p>Varianten über <code>skipsim.model.BallContainer.skipMode</code> einstellbar&#8230;&#8203;</p></li></ul></div>
<aside class="notes"><p>Der Simulator zeigt in der 1. Zeile die noch zu lesenden Elemente, in der 2. Zeile das gerade
bearbeitete Element und in der 3. Zeile die geschriebenen Elemente. Der Simulator macht eine
Pause, wenn er die Bearbeitung beginnt (Kugel sichtbar) und wenn er die Bearbeitung abgeschlossen
hat (Kugel nicht sichtbar). Blaue Kugeln führen in der entsprechenden Phase (<code>skipMode</code>) zu
einer <code>InvalidBallException</code>. <strong>Besonders auf das Verhalten bei Prozess- oder Schreibfehlern achten!</strong></p></aside></section>
<section id="_retrytemplatenoch_ein_framework_für_eine_schleife"><h2>RetryTemplate&#8201;&#8212;&#8201;Noch ein Framework für eine Schleife&#8230;&#8203;</h2><div class="imageblock" style=""><img src="images/RetryTemplate.svg" alt="RetryTemplate" width="2148" height="761"></div></section>
<section id="_chunkverarbeitung_mit_retry"><h2>Chunkverarbeitung mit Retry</h2><div class="imageblock" style=""><img src="images/ChunkExecWithRetry.svg" alt="ChunkExecWithRetry" width="2123" height="763"></div></section>
<section id="_fehlertoleranz_bei_chunkorientedtasklet"><h2>Fehlertoleranz bei ChunkOrientedTasklet</h2><div class="imageblock" style=""><img src="images/FaulttolerantChunkOrientedTasklet.svg" alt="FaulttolerantChunkOrientedTasklet" width="2430" height="702"></div></section>
<section id="_beispiel_für_aufwendigere_retry_konfiguration"><h2>Beispiel für aufwendigere Retry-Konfiguration</h2><pre class="CodeRay listingblock"><code>        TaskletStep step = stepBuilderFactory
                .get("retryStep") // StepBuilder
                .&lt;Integer, String&gt;chunk(4) // SimpleStepBuilder
                .reader(reader()).processor(processor()).writer(writer())
                .faultTolerant() // FaultTolerantStepBuilder
                    .retryLimit(7) // bis zu 7 mal wiederholen
                    .retry(MyRetryException.class)
                    .backOffPolicy(new ExponentialBackOffPolicy()) // nach jedem Versuch doppelt so lange Warten
                .skip(MyRetryException.class) // nach 7 Fehlversuchen diesen Datensatz überspringen
                    .skipLimit(3) // Maximal 3 Datensätze überspringen
                .listener(loggingSkipListener())
                .build();</code></pre>
<div class="olist arabic"><ol class="arabic"><li><p>Wiederholt den Process- oder Write-Schritt bei einer <code>MyRetryException</code> bis zu 7 mal.</p></li><li><p>Wartet vor jedem Versuch 100ms, 200ms, 400ms, &#8230;&#8203;</p></li><li><p>Überspringt den Datensatz nach 7 fehlgeschlagenen Versuchen.</p></li><li><p>Loggt übersprungene Datensätze.</p></li><li><p>Bricht den Step nach 3 übersprungenen Datensätzen ab.</p></li></ol></div></section>
<section id="_wissenswertes_zur_retry_konfiguration"><h2>Wissenswertes zur Retry-Konfiguration</h2><div class="ulist"><ul><li><p>Eine <strong><code>BackOffPolicy</code></strong> gibt an, wie lange vor jedem erneuten Versuch gewartet werden soll.</p></li><li><p>Die <strong><code>ExponentialBackOffPolicy</code></strong> wartet beim ersten Versuch 100ms und verdoppelt dann die
Wartezeit bis zu maximal 30s. (Ist natürlich alles konfigurierbar).</p></li><li><p>Mehr Einflussmöglichkeiten hat man durch eine eigene <strong><code>RetryPolicy</code></strong>.<br>
(Spring-Batch bringt einige Varianten davon mit.)</p></li><li><p>Mit einer nachgelagerten <strong><code>SkipPolicy</code></strong> kann man dafür sorgen, das der Datensatz nach
n Versuchen übersprungen wird.</p></li></ul></div>
<div class="admonitionblock warning teacherBox"><table><tr><td class="icon"><i class="fa fa-warning" title="Warning"></i></td><td class="content">Die <strong><code>RetryPolicy</code></strong> hat keine Auswirkung auf Fehler beim Lesen, da nur der
<code>FaultTolerantChunkProcessor</code> ein <code>RetryTemplate</code> verwendet, nicht aber der
<code>FaultTolerantChunkProvider</code>. Letzterer hat nur eine <strong><code>SkipPolicy</code></strong>.</td></tr></table></div></section>
<section id="_komponenten_zur_job_konfiguration"><h2>Komponenten zur Job-Konfiguration</h2><div class="imageblock" style=""><img src="images/BatchConfigurer.svg" alt="BatchConfigurer" width="1900" height="736"></div></section>
<section id="_stepbuilder_methoden"><h2>StepBuilder-Methoden</h2><div class="imageblock" style=""><img src="images/StepBuilder.svg" alt="StepBuilder" width="2302" height="850"></div></section>
<section id="_jobbuilder_methoden"><h2>JobBuilder-Methoden</h2><div class="imageblock" style=""><img src="images/JobBuilderMethoden.svg" alt="JobBuilderMethoden" width="1524" height="586"></div></section>
<section id="_konfiguration_des_transaktions_und_wiederanlaufverhaltens"><h2>Konfiguration des Transaktions- und Wiederanlaufverhaltens</h2><div class="imageblock" style=""><img src="images/TxConfig.svg" alt="TxConfig" width="2476" height="732"></div>
<aside class="notes"><p>Hier ist jede einzelne Methode relevant!</p></aside></section>
<section id="_listener_interfaces"><h2>Listener-Interfaces</h2><div class="imageblock" style=""><img src="images/ListenerInterfaces.svg" alt="ListenerInterfaces" width="2786" height="887"></div></section>
<section id="_registrierung_der_listener_interfaces"><h2>Registrierung der Listener-Interfaces</h2><div class="imageblock" style=""><img src="images/ListenerRegistierung.svg" alt="ListenerRegistierung" width="1838" height="882"></div></section>
<section id="_wissenswertes_zu_listenern"><h2>Wissenswertes zu Listenern</h2><div class="ulist"><ul><li><p><strong><code>ItemReader</code></strong>, <strong><code>ItemProcessor</code></strong> und <strong><code>ItemWriter</code></strong> werden automatisch als <strong><code>StepListener</code></strong>
registiert, sobald sie eines der entsprechenden Interfaces implementieren.</p></li><li><p>Für jede Listener-Methode gibt es eine korrespondierende Annotation (z. B. <strong><code>@BeforeRead</code></strong>).<br>
Ein Objekt, das eine so annotierte Methode enthält kann genauso also Listener registiert
werden, wie ein Objekt, welches das entsprechende Interface implementiert.</p></li><li><p>Zu praktisch jedem Listener gibt es ein entsprechendes JSR-352 Pendant. Diese können genauso
wie die Spring-Batch eigenen Listener verwendet werden.</p></li></ul></div>
<div class="admonitionblock caution teacherBox"><table><tr><td class="icon"><i class="fa fa-fire" title="Caution"></i></td><td class="content">Damit das automatische Registieren funktioniert, muss als Return-Type bei der Bean-Methode
eine Klasse oder Interface angegeben werden, das den bzw. die entsprechenden Listener implementiert.
<code>@Bean ItemReader&lt;String&gt; myItemReader()</code> funktioniert nicht.</td></tr></table></div></section>
<section id="_wozu_sind_listener_gut"><h2>Wozu sind Listener gut?</h2><div class="olist arabic"><ol class="arabic"><li class="fragment"><p>Monitoring und Tracing</p></li><li class="fragment"><p>Ausnahmebehandlung</p></li><li class="fragment"><p>Einflussname auf den Batch-Workflow</p></li><li class="fragment"><p>Zugriff auf Framework-Informationen</p><div class="admonitionblock note teacherBox"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">Man kann beispielsweise in <strong><code>beforeStep()</code></strong> auf Inhalte der <strong><code>StepExecution</code></strong> zugreifen
und in einer Instanzvariablen speichern. Andere (Listener)-Methoden kommen so an die
entsprechende Information.</td></tr></table></div></li><li class="fragment"><p>Kommunikation mit Batch-Framework</p></li><li class="fragment"><p>Parameterübergabe zwischen Steps</p></li></ol></div></section>
<section id="_parameter_der_listener_methoden"><h2>Parameter der Listener-Methoden</h2><div class="imageblock" style=""><img src="images/ListenerParameter.svg" alt="ListenerParameter" width="2210" height="856"></div></section>
<section id="_spezielle_listener"><h2>Spezielle Listener</h2><div class="imageblock" style=""><img src="images/SpezielleListener.svg" alt="SpezielleListener" width="1932" height="748"></div></section>
<section id="_zusammenfassung_lektion_4"><h2>Zusammenfassung Lektion 4</h2><div class="ulist"><ul><li><p>Interfaces <strong><code>ItemReader</code></strong>, <strong><code>ItemProcessor</code></strong> und <strong><code>ItemWriter</code></strong> implementieren und verwenden</p></li><li><p>Aufbau und Funktsionsweise des <strong><code>ChunkorientetTasklet</code></strong></p></li><li><p>Konfiguration von Fehlertoleranz und Umgang mit Fehlern</p></li><li><p>Registrierung, Zweck und Verwendung der diversen Listener Interfaces</p></li><li><p>Job- und Step-Builder im Detail</p></li></ul></div></section>
<section id="_aufgabe_teil_a"><h2>Aufgabe: (Teil A)</h2><div class="olist arabic"><ol class="arabic"><li><p>Implementieren Sie einen ItemReader, der eine über einen Parameter einstellbare Anzahl von
Zufallsbrüchen mit Nenner und Zähler zwischen -10 und +10 liefert. Nutzen Sie dafür die
bereits vorbereitete Klasse <code>Fraction</code>.</p></li><li><p>Implementieren Sie einen ItemProcessor, der jeden Bruch in der Form <strong><code>3/4 = 0,750</code></strong> ausgibt.
Nutzen Sie dafür <code>Fraction.toDescription()</code>.</p></li><li><p>Implementieren Sie einen ItemWriter, der alle Brüche eines Chunks in einer Zeile über <code>System.out</code> ausgibt.</p></li><li><p>Stellen Sie alles in einem fehlertoleranten Job zusammen, der bis zu 5 <code>ArithmeticException</code> (wegen
Division durch <code>0</code>) zulässt.</p></li><li><p>Führen Sie den Job aus und sehen Sie sich das Job-Repository an (dieses muss natürlich entsprechend
konfiguriert sein).</p></li><li><p>Welche Exceptions landen in <code>jobExecution.getAllFailureExceptions()</code>?</p></li></ol></div>
<div class="admonitionblock tip teacherBox"><table><tr><td class="icon"><i class="fa fa-lightbulb-o" title="Tip"></i></td><td class="content">Mit Log-Level DEBUG gibt Spring-Batch alle Exception aus.</td></tr></table></div></section>
<section id="_aufgabe_teil_b_optional"><h2>Aufgabe: (Teil B - optional)</h2><div class="olist arabic"><ol class="arabic" start="6"><li><p>Erstellen Sie einen weiteren Step, der alle Brüche ausgibt, bei denen ein Fehler aufgetreten ist.
Nutzen Sie den <code>ExecutionContext</code> und geeignete Listener, um diese 2er-Tupel zu übergeben.</p></li><li><p>Führen Sie einen neunen Exit-Status "WARNING" ein, der zurückgegeben werden soll, sobald eine
<code>ArithmeticException</code> aufgetreten ist.</p></li><li><p>Sorgen Sie dafür, dass der Job bei Exit-Status "WARNING" mit Return-Code 99 beendet wird:</p><div class="imageblock" style="text-align: left"><img src="images/chunk/ExitCode.png" alt="ExitCode" width="1000"></div></li></ol></div>
<div class="paragraph"><p><br>
&#8594; <a href="index.html">Agenda</a></p></div></section>
<section id="_lektion_5_die_spring_batch_infrastruktur" data-state="no-title-footer"><h2>Lektion 5 - Die Spring-Batch Infrastruktur</h2></section>
<section id="_überblick_zu_dieser_lektion_4" class="columns"><h2>Überblick zu dieser Lektion</h2><div class="olist arabic"><ol class="arabic"><li><p>Die Reader und Writer von Spring-Batch</p></li><li><p><a href="lesson05-infra.html#/_datenbankzugriff_mit_spring_batch">Reader und Writer für die Datenbank</a></p></li><li><p><a href="lesson05-infra.html#/_dateisystemzugriff_mit_spring_batch">Zugriff auf das Dateisystem</a></p></li><li><p><a href="lesson05-infra.html#/_die_supportklassen">Komposition von Readern und Writern</a></p></li><li><p><a href="lesson05-infra.html#/_filterung_von_items">Filterung und Validierung</a></p></li><li><p><a href="lesson05-infra.html#/_xml">Unterstützung für XML und JSON</a>
(<a href="lesson05-infra.html#/_aufgabe">Aufgabe</a>)</p></li></ol></div>
<div class="imageblock" style=""><img src="images/SpringCoreUndInfra.svg" alt="SpringCoreUndInfra" width="648" height="342"></div></section>
<section><section id="_die_org_springframework_batch_item_packages"><h2>Die <code>org.springframework.batch.item&#8230;&#8203;</code> Packages</h2><div class="paragraph lead"><p>Datenbankzugriff</p></div><table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:14.2857%"><col style="width:85.7143%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">avro</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Apache Avro Daten Serialisierung</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">data</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">NoSQL-Datenbanken (GemFire, MongoDB, Neo4j, Spring-Data Repository)</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">database</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">SQL-Datenbanken (Jdbc, Hibernate, JPA, Stored Procedures)</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">ldif</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">LDAP Data Interchange Format: Reader für Zugriff auf LDAP-Quellen</p></td></tr></table></section><section id="_messaging"><h2>Messaging</h2><table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:14.2857%"><col style="width:85.7143%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">amqp</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Reader und Writer für Advanced Message Queuing Protocol<br>
(Apache Qpid, Microsoft Windows Azure Service Bus, RabbitMQ)</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">jms</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">JMS Reader und Writer</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">kafka</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Apache Kafka Reader und Writer</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">mail</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Writer zum versenden von Mails</p></td></tr></table></section><section id="_einfache_dateien"><h2>Einfache Dateien</h2><table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:14.2857%"><col style="width:85.7143%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">file</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Framework zum Arbeiten mit Dateien (CSV, feste Spaltenbreite)</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">json</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Lesen und Schreiben von JSON-Dateien</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">xml</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Lesen und Schreiben von XML-Dateien</p></td></tr></table></section><section id="_support"><h2>Support</h2><table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:14.2857%"><col style="width:85.7143%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">adapter</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Beliebige Methoden als Reader, Processor oder Writer verwenden</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">function</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Funktionen als ItemProcessor verwenden</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">support</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Komposition von Readern, Prozessoren und Writern</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">validator</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Validierung vor oder nach der Verarbeitung im Prozessor</p></td></tr></table></section></section>
<section id="_datenbankzugriff_mit_spring_batch"><h2>Datenbankzugriff mit Spring-Batch</h2><table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:20%"><col style="width:20%"><col style="width:20%"><col style="width:20%"><col style="width:20%"></colgroup><thead><tr><th class="tableblock halign-left valign-top"></th><th class="tableblock halign-left valign-top">JDBC</th><th class="tableblock halign-left valign-top">JPA</th><th class="tableblock halign-left valign-top">Hibernate</th><th class="tableblock halign-left valign-top">Stored Procedure</th></tr><tbody><tr><th class="tableblock halign-left valign-top"><p class="tableblock header">Reader (Cursor)</p></th><td class="tableblock halign-left valign-top"><p class="tableblock">JdbcCursor-ItemReader</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">JpaCursor-ItemReader</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">HibernateCursor-ItemReader</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">StoredProcedure-ItemReader</p></td></tr><tr><th class="tableblock halign-left valign-top"><p class="tableblock header">Reader (paged)</p></th><td class="tableblock halign-left valign-top"><p class="tableblock">JdbcPaging-ItemReader</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">JpaPaging-ItemReader</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">HibernatePaging-ItemReader</p></td><td class="tableblock halign-left valign-top"></td></tr><tr><th class="tableblock halign-left valign-top"><p class="tableblock header">Writer</p></th><td class="tableblock halign-left valign-top"><p class="tableblock">JdbcBatch-ItemWriter</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">JpaItemWriter</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Hibernate-ItemWriter</p></td><td class="tableblock halign-left valign-top"></td></tr></table>
<div class="admonitionblock note teacherBox"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">Der <code>JdbcCursorItemReader</code> verwendet eine eigene Connection und ist somit nicht in
Transaktionen bei der Step-Verarbeitung eingebunden.</td></tr></table></div></section>
<section id="_dateisystemzugriff_mit_spring_batch"><h2>Dateisystemzugriff mit Spring-Batch</h2><div class="paragraph"><p>Folgende Reader und Writer dienen dem Zugriff auf das Dateisystem:</p></div>
<div class="ulist"><ul><li><p><strong><code>FlatFileItemReader</code></strong> und <strong><code>FlatFileItemWriter</code></strong> für Textdateien (CSV, feste Spaltenbereite)</p></li><li><p><strong><code>StaxEventItemReader</code></strong> und <strong><code>StaxEventItemWriter</code></strong> verarbeiten XML-Dateien fragmentweise,
wobei jedes Fragment mit <strong>OXM</strong> (<em>JAXB</em>, <em>Castor</em>, <em>XStream</em>, etc.) gemapped wird.<br>
&#8658; OXM mit sehr großen Dateien möglich.</p></li><li><p><strong><code>JsonItemReader</code></strong> und <strong><code>JsonFileItemWriter</code></strong> zur sequentiellen Verarbeitung von JSON-Objekten,
unterstützt <em>Jackson</em> und <em>GSON</em>.</p></li><li><p><strong><code>ResourcesItemReader</code></strong> iteriert über Dateien</p></li><li><p><strong><code>MultiResourceItemReader</code></strong> zur elementweisen Verarbeitung mehrerer Dateien</p></li></ul></div>
<div class="admonitionblock note teacherBox"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">Man kann diese Klassen auch ohne den Overhead des Spring-Batch Frameworks nutzen.
Siehe dazu <a href="https://www.informatik-aktuell.de/entwicklung/methoden/strukturierte-textdateien-mit-spring-batch-verarbeiten.html">
&#8594; <em>Informatik Aktuell</em>: Strukturierte Textdateien mit Spring Batch verarbeiten</a>.</td></tr></table></div></section>
<section id="_flatfileitemreader"><h2>FlatFileItemReader</h2><div class="imageblock" style=""><img src="images/FlatFileItemReader.svg" alt="FlatFileItemReader" width="1994" height="618"></div></section>
<section id="_beispieldaten_für_verarbeitung_einer_csv_datei"><h2>Beispieldaten für Verarbeitung einer CSV-Datei</h2><div class="title">Persons.csv</div><pre class="CodeRay listingblock"><code>Nachname; Vorname; Geburtsdatum
&quot;Brantwein&quot;; &quot;Franz&quot;; 17.12.1958
&quot;Bolika&quot;; &quot;Anna&quot;; 03.07.1972
&quot;Panse&quot;; &quot;Jim&quot;; 08.02.2002</code></pre>
<div class="title">Person.java (mit JSR-303 Annotationen)</div><pre class="CodeRay listingblock"><code class="java language-java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Person</span> {
    <span class="annotation">@NotBlank</span>
    <span class="annotation">@Size</span>(max = <span class="integer">80</span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> firstName;
    <span class="annotation">@NotNull</span>
    <span class="annotation">@Size</span>(min = <span class="integer">2</span>, max = <span class="integer">80</span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> lastName;
    <span class="annotation">@DateTimeFormat</span>(pattern = <span class="string"><span class="delimiter">&quot;</span><span class="content">dd.MM.yyyy</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@Past</span>
    <span class="directive">private</span> LocalDate birthday;

    <span class="comment">// getters, setters, toString...</span>
}</code></pre></section>
<section id="_konfiguration_des_flatfileitemreader"><h2>Konfiguration des FlatFileItemReader</h2><pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Bean</span>
<span class="annotation">@JobScope</span>
FlatFileItemReader&lt;Person&gt; personCsvReader(
        <span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters[file]}</span><span class="delimiter">&quot;</span></span>) Resource source) {
    <span class="keyword">return</span> <span class="keyword">new</span> FlatFileItemReaderBuilder&lt;Person&gt;()
            .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">personCsvReader</span><span class="delimiter">&quot;</span></span>) <span class="comment">// arbitrary name</span>
            .saveState(<span class="predefined-constant">false</span>) <span class="comment">// don't save progress in ExecutionContext</span>
            .resource(source) <span class="comment">// read from this Resource</span>
            .delimited() <span class="comment">// expect a delimited (CSV) file</span>
            .delimiter(<span class="string"><span class="delimiter">&quot;</span><span class="content">;</span><span class="delimiter">&quot;</span></span>) <span class="comment">// use ';' as delimiter instead of ','</span>
            .quoteCharacter(<span class="string"><span class="delimiter">'</span><span class="content">\&quot;</span><span class="delimiter">'</span></span>) <span class="comment">// remove quotation from content</span>
            .names(<span class="keyword">new</span> <span class="predefined-type">String</span><span class="type">[]</span> { <span class="string"><span class="delimiter">&quot;</span><span class="content">lastName</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">firstName</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">birthday</span><span class="delimiter">&quot;</span></span> }) <span class="comment">// map column to names</span>
            .fieldSetMapper(<span class="keyword">new</span> BeanWrapperFieldSetMapper&lt;Person&gt;() {
                {
                    setTargetType(Person.class); <span class="comment">// initialize mapper</span>
                    DefaultFormattingConversionService cv = <span class="keyword">new</span> DefaultFormattingConversionService();
                    setConversionService(cv); <span class="comment">// convert date/time values</span>
                }
            })
            .linesToSkip(<span class="integer">1</span>) <span class="comment">// skip first (header) row</span>
            .build(); <span class="comment">// create the reader</span>
}</code></pre>
<div class="admonitionblock note teacherBox"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">Für praktisch jeden Reader oder Writer gibt es einen korrespondierenden Builder.</td></tr></table></div></section>
<section id="_die_supportklassen"><h2>Die Supportklassen&#8230;&#8203;</h2><div class="ulist"><ul><li><p><strong><code>ItemReaderAdapter</code></strong>, <strong><code>ItemProcessorAdapter</code></strong> und <strong><code>ItemWriterAdapter</code></strong> dienen dazu eine
beliebige Methode für die entsprechende Operation zu verwenden. (Dank <em>functional Interfaces</em> überflüssig.)</p></li><li><p><strong><code>CompositeItemStream</code></strong>, <strong><code>CompositeItemProcessor</code></strong> und <strong><code>CompositeItemWriter</code></strong> dienen dazu,
mehrere Streams, Prozessoren bzw. Writer zu verketten. Bei Prozessoren wird das Ergebnis an den
nächsten Prozessor weitergereicht.</p></li><li><p><strong><code>IteratorItemReader</code></strong>,<strong><code>ListItemReader</code></strong> und <strong><code>ListItemWriter</code></strong> sind Wrapper für entsprechende
Collection-Interfaces.</p></li><li><p>Mit dem <strong><code>ScriptItemProcessor</strong></code> kann man die <code>process</code>-Logik in ein Skript auslagern.</p></li><li><p>Der <strong><code>SingleItemPeekableItemReader</code></strong> ist ein Wrapper for einen Reader, mit dem man auf das nächste
Item vorausschauen kann.</p></li><li><p><strong><code>SynchronizedItemStreamReader</code></strong> ist ein Decorator, der Zugriffe auf die <code>read</code>-Methode synchronisiert.</p></li></ul></div></section>
<section id="_spezielle_tasklets"><h2>Spezielle Tasklets</h2><div class="imageblock" style=""><img src="images/SpecialTasklets.svg" alt="SpecialTasklets" width="1450" height="578"></div></section>
<section id="_das_itemstream_interface"><h2>Das ItemStream Interface</h2><div class="paragraph"><p>Die meisten Reader und Writer müssen geöffnet und geschlossen werden, dafür implementieren Sie das ItemStream Interface:</p></div>
<div class="imageblock" style=""><img src="images/spring-batch-reader-writer.svg" alt="spring batch reader writer" width="1920" height="576"></div>
<div class="admonitionblock note teacherBox"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">Mit der <code>update</code> Methode kann der ItemStream seinen Forschritt im ExecutionContext speichern.
Diese Information dient zum Wiederanlauf nach einem Abbruch.</td></tr></table></div></section>
<section id="_delegate_pattern"><h2>Delegate Pattern</h2><div class="paragraph"><p>Sehr häufig wird das <em>Delegate Pattern</em> verwendet, um vorhandene Reader, Prozessoren oder Writer
für eigene Zwecke anzupassen:</p></div>
<pre class="CodeRay listingblock"><code class="java language-java"><span class="directive">public</span> <span class="type">class</span> <span class="class">DelegateReader</span> <span class="directive">implements</span> ItemReader&lt;<span class="predefined-type">BigDecimal</span>&gt; {

    <span class="directive">private</span> <span class="directive">final</span> ItemReader&lt;? <span class="directive">extends</span> <span class="predefined-type">Number</span>&gt; delegate;

    <span class="directive">public</span> DelegateReader(ItemReader&lt;? <span class="directive">extends</span> <span class="predefined-type">Number</span>&gt; delegate) {
        <span class="local-variable">this</span>.delegate = delegate;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">BigDecimal</span> read() <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="predefined-type">Number</span> value = delegate.read();
        <span class="keyword">return</span> value == <span class="predefined-constant">null</span> ? <span class="predefined-constant">null</span> : <span class="predefined-type">BigDecimal</span>.valueOf(value.longValue());
    }
}</code></pre>
<div class="admonitionblock note teacherBox"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">Vererbung ist keine gute Idee um Code wiederzuverwenden, weil es zu einer starken
Kopplung führt und u. a. das Testen erschwert.</td></tr></table></div></section>
<section id="_filterung_von_items"><h2>Filterung von Items</h2><div class="paragraph"><p>Es gibt zwei Stellen an denen Items gefiltert werden können:</p></div>
<div class="olist arabic"><ol class="arabic"><li><p><strong><code>ItemReader</code></strong> überspringt die zu filternden Items</p><div class="ulist"><ul><li><p>&#8658; Übersprungene Datensätze werden nicht gezählt</p></li></ul></div></li><li><p><strong><code>ItemProcessor</code></strong> filtert, indem er <strong><code>null</code></strong> zurück gibt</p><div class="ulist"><ul><li><p><strong><code>readCount</code></strong>: Alle Datensätze</p></li><li><p><strong><code>writeCount</code></strong>: Nur tatsächlich verarbeitete Datensätze</p></li><li><p><strong><code>filterCount</code></strong>: Datensätze, die der <em>Processor</em> herausgefiltert hat</p></li></ul></div></li></ol></div></section>
<section id="_validierung_von_items"><h2>Validierung von Items</h2><div class="ulist"><ul><li><p>Erste Validierung erfolgt durch Reader:</p><div class="ulist"><ul><li><p>Spalte in CSV-Datei existiert nicht oder kann nicht in entsprechenden Typ umgewandelt werden</p></li><li><p>Mapping eines XML-Fragments mit OXM nicht möglich</p></li><li><p>&#8658; Bei invaliden Datensätzen wird immer eine Exception geworfen</p></li></ul></div></li><li><p>Für Validierung bei der Verarbeitung definiert Spring-Batch das <strong><code>Validator</code></strong> Interface:</p><pre class="CodeRay listingblock"><code class="java language-java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">Validator</span>&lt;T&gt; {
    <span class="type">void</span> validate(T value) <span class="directive">throws</span> ValidationException;
}</code></pre></li><li><p>Dieses Interface wird in Kombination mit einem <strong><code>ValidatingItemProcessor</code></strong> verwendet</p><div class="ulist"><ul><li><p>Dieser kann wahlweise invalide Datensätze filtern oder die Chunkverarbeitung mit einer
Exception abbrechen</p></li><li><p>Man kann entweder davon ableiten oder einen <strong><code>CompositeItemProcessor</code></strong> verwenden</p></li></ul></div></li></ul></div></section>
<section id="_spring_batch_validierungsframework"><h2>Spring-Batch Validierungsframework</h2><div class="imageblock" style=""><img src="images/ValidationFramework.svg" alt="ValidationFramework" width="1932" height="814"></div></section>
<section id="_jsr_303_abhängigkeiten"><h2>JSR-303 Abhängigkeiten</h2><div class="paragraph"><p>Die folgenden Abhängigkeiten sind notwendig, wenn man den <strong><code>BeanValidatingItemProcessor</code></strong>
verwenden möchte:</p></div>
<pre class="CodeRay listingblock"><code class="xml language-xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>javax.validation<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>validation-api<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.apache.tomcat.embed<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>tomcat-embed-el<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.hibernate.validator<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>hibernate-validator<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
<div class="admonitionblock note teacherBox"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content"><code>tomcat-embed-el</code> ist die <code>javax.el</code> Implementierung, die standardmäßig von
Spring-Boot Applikationen verwendet wird.</td></tr></table></div></section>
<section id="_verwendung_des_beanvalidatingitemprocessor"><h2>Verwendung des BeanValidatingItemProcessor</h2><div class="title">Konfiguration eines Validators für JSR-303 Annotationen:</div><pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Bean</span>
BeanValidatingItemProcessor&lt;Person&gt; validator() {
    BeanValidatingItemProcessor&lt;Person&gt; validator = <span class="keyword">new</span> BeanValidatingItemProcessor&lt;&gt;();
    validator.setFilter(<span class="predefined-constant">true</span>);
    <span class="keyword">return</span> validator;
}</code></pre>
<div class="paragraph"><p><br></p></div>
<div class="title">Komposition des Validators mit einem anderen Prozessor:</div><pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Bean</span>
ItemProcessor&lt;PersonJaxb, Person&gt; processor() {
    <span class="keyword">return</span> <span class="keyword">new</span> CompositeItemProcessorBuilder&lt;PersonJaxb, Person&gt;()
            .delegates((ItemProcessor&lt;PersonJaxb, Person&gt;) <span class="local-variable">this</span>::map, validator())
            .build();
}</code></pre></section>
<section id="_xml"><h2>XML</h2><div class="paragraph"><p>Zur Verarbeitung von XML-Dateien dienen die folgenden Klassen:</p></div>
<div class="ulist"><ul><li><p><strong><code>StaxEventItemReader</code></strong></p></li><li><p><strong><code>StaxEventItemWriter</code></strong></p></li></ul></div>
<div class="paragraph"><p>Diese kombinieren StAX mit OXM:</p></div>
<div class="ulist"><ul><li><p><em>StAX</em> ist ein Pull-API zur effizienten Verarbeitung großer XML-Dateien</p></li><li><p><em>OXM</em> steht für Objekt-XML-Mapping und ist eine Mapping-API von Spring</p></li><li><p>OXM bietet eine einheitliche API für verschiedene Mapping-Implementierungen,<br>
wie z. B. <em>JAXB</em>, <em>Castor</em> oder <em>XStream</em></p></li><li><p>OXM verwandelt eine komplette XML-Datensturktur in eine korrespondierende
Objektstruktur oder umgekehrt.<br>
&#8658; Die Objektsturktur muss im Arbeisspeicher Platz haben</p></li><li><p>Durch die Kombination von OXM mit StAX können XML-Dateien fragmentweise
mit OXM verarbeitet werden.<br>
&#8658; Verarbeitung oder Erstellung sehr großer XML-Dateien möglich</p></li></ul></div></section>
<section id="_jaxb"><h2>JAXB</h2><div class="ulist"><ul><li><p>JAXB steht für <em>Java Architecture for XML Binding</em></p></li><li><p>Man kann damit</p><div class="ulist"><ul><li><p>aus einem XML-Schema korresponierende Java-Klassen (üblicher Weg) oder</p></li><li><p>aus entsprechend annotierten Java-Klassen ein XML-Schema erzeugen.</p></li></ul></div></li><li><p>OXM bietet einen <code>Jaxb2Marshaller</code> mit dem man sehr einfach JAXB verwenden kann:</p><pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Bean</span>
Unmarshaller getUnmarshaller() {
    Jaxb2Marshaller marshaller = <span class="keyword">new</span> Jaxb2Marshaller();
    marshaller.setContextPath(Persons.class.getPackage().getName());
    marshaller.setMappedClass(PersonJaxb.class);
    <span class="keyword">return</span> marshaller;
}</code></pre></li><li><p>Der Jaxb2Marshaller implementiert sowohl das <code>Marshaller</code> als auch das <code>Unmarshaller</code>
Interface.</p></li></ul></div></section>
<section id="_abhängigkeiten_für_oxmjaxb2"><h2>Abhängigkeiten für OXM+JAXB2</h2><div class="paragraph"><p>Seit Java 11 ist JAXB kein Bestandteil des JDK mehr. Deswegen sind jetzt explizite
Abhängigkeiten zu JAXB notwendig:</p></div>
<pre class="CodeRay listingblock"><code class="xml language-xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.springframework<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>spring-oxm<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>javax.xml.bind<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>jaxb-api<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.glassfish.jaxb<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>jaxb-runtime<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>javax.activation<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>javax.activation-api<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre></section>
<section id="_konfiguration_des_jaxb_plugins" class="columns"><h2>Konfiguration des JAXB-Plugins</h2><div class="openblock"><div class="content"><pre class="CodeRay listingblock"><code class="xml language-xml"><span class="tag">&lt;plugin&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.codehaus.mojo<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>jaxb2-maven-plugin<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>2.5.0<span class="tag">&lt;/version&gt;</span>
    <span class="tag">&lt;dependencies&gt;</span>
        <span class="tag">&lt;dependency&gt;</span>
            <span class="tag">&lt;groupId&gt;</span>javax.xml.bind<span class="tag">&lt;/groupId&gt;</span>
            <span class="tag">&lt;artifactId&gt;</span>jaxb-api<span class="tag">&lt;/artifactId&gt;</span>
            <span class="tag">&lt;version&gt;</span>${javax-jaxb.version}<span class="tag">&lt;/version&gt;</span>
        <span class="tag">&lt;/dependency&gt;</span>
        <span class="tag">&lt;dependency&gt;</span>
            <span class="tag">&lt;groupId&gt;</span>org.glassfish.jaxb<span class="tag">&lt;/groupId&gt;</span>
            <span class="tag">&lt;artifactId&gt;</span>jaxb-jxc<span class="tag">&lt;/artifactId&gt;</span>
            <span class="tag">&lt;version&gt;</span>${glassfish-jaxb.version}<span class="tag">&lt;/version&gt;</span>
        <span class="tag">&lt;/dependency&gt;</span>
        <span class="tag">&lt;dependency&gt;</span>
            <span class="tag">&lt;groupId&gt;</span>org.glassfish.jaxb<span class="tag">&lt;/groupId&gt;</span>
            <span class="tag">&lt;artifactId&gt;</span>jaxb-runtime<span class="tag">&lt;/artifactId&gt;</span>
            <span class="tag">&lt;version&gt;</span>${glassfish-jaxb.version}<span class="tag">&lt;/version&gt;</span>
        <span class="tag">&lt;/dependency&gt;</span>
        <span class="tag">&lt;dependency&gt;</span>
            <span class="tag">&lt;groupId&gt;</span>javax.activation<span class="tag">&lt;/groupId&gt;</span>
            <span class="tag">&lt;artifactId&gt;</span>javax.activation-api<span class="tag">&lt;/artifactId&gt;</span>
            <span class="tag">&lt;version&gt;</span>${javax-activation.version}<span class="tag">&lt;/version&gt;</span>
        <span class="tag">&lt;/dependency&gt;</span>
    <span class="tag">&lt;/dependencies&gt;</span></code></pre></div></div>
<div class="openblock"><div class="content"><pre class="CodeRay listingblock"><code class="xml language-xml">    <span class="tag">&lt;executions&gt;</span>
        <span class="tag">&lt;execution&gt;</span>
            <span class="tag">&lt;id&gt;</span>xjc<span class="tag">&lt;/id&gt;</span>
            <span class="tag">&lt;goals&gt;</span>
                <span class="tag">&lt;goal&gt;</span>xjc<span class="tag">&lt;/goal&gt;</span>
            <span class="tag">&lt;/goals&gt;</span>
        <span class="tag">&lt;/execution&gt;</span>
    <span class="tag">&lt;/executions&gt;</span>
<span class="tag">&lt;/plugin&gt;</span></code></pre>
<div class="paragraph"><p>Erzeugt Java-Klassen aus<br>
den Schema-Dateien im<br>
Verzeichnis <code>src/main/xsd</code><br>
entsprechend der Bindings<br>
in <code>src/main/xjb</code>.</p></div></div></div></section>
<section id="_binding_eines_schemas" class="columns"><h2>Binding eines Schemas</h2><div class="openblock two-col"><div class="content"><div class="title">persons.xsd</div><pre class="CodeRay listingblock"><code class="xml language-xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;?&gt;</span>
<span class="tag">&lt;xs:schema</span>
    <span class="attribute-name">targetNamespace</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://anderscore.com/persons</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:xs</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://anderscore.com/persons</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;xs:element</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">persons</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;xs:complexType&gt;</span>
            <span class="tag">&lt;xs:sequence&gt;</span>
                <span class="tag">&lt;xs:element</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">person</span><span class="delimiter">&quot;</span></span>
                    <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">PersonType</span><span class="delimiter">&quot;</span></span>
                    <span class="attribute-name">minOccurs</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span>
                    <span class="attribute-name">maxOccurs</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">unbounded</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;/xs:sequence&gt;</span>
        <span class="tag">&lt;/xs:complexType&gt;</span>
    <span class="tag">&lt;/xs:element&gt;</span>

    <span class="tag">&lt;xs:complexType</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">PersonType</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;xs:sequence&gt;</span>
            <span class="tag">&lt;xs:element</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">firstName</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xs:string</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;xs:element</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lastName</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xs:string</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;xs:element</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">birthday</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xs:date</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/xs:sequence&gt;</span>
    <span class="tag">&lt;/xs:complexType&gt;</span>
<span class="tag">&lt;/xs:schema&gt;</span></code></pre></div></div>
<div class="openblock two-col top"><div class="content"><div class="title">bindings.xjb</div><pre class="CodeRay listingblock"><code class="xml language-xml"><span class="tag">&lt;jaxb:bindings</span> <span class="attribute-name">version</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2.0</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:jaxb</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://java.sun.com/xml/ns/jaxb</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:xjc</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://java.sun.com/xml/ns/jaxb/xjc</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:xs</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">jaxb:extensionBindingPrefixes</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xjc</span><span class="delimiter">&quot;</span></span>
<span class="tag">&gt;</span>
    <span class="tag">&lt;jaxb:bindings</span>
        <span class="attribute-name">namespace</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://anderscore.com/persons</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">../xsd/persons.xsd</span><span class="delimiter">&quot;</span></span>
    <span class="tag">&gt;</span>
        <span class="comment">&lt;!-- Bindet XML-Namespace an ein Java-Package --&gt;</span>
        <span class="tag">&lt;jaxb:schemaBindings&gt;</span>
            <span class="tag">&lt;jaxb:package</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">infra.persons.jaxb</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/jaxb:schemaBindings&gt;</span>

        <span class="comment">&lt;!-- Expliziter Klassename für ein XML-Element --&gt;</span>
        <span class="tag">&lt;jaxb:bindings</span>
            <span class="attribute-name">node</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">//xs:complexType[@name='PersonType']</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;jaxb:class</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">PersonJaxb</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/jaxb:bindings&gt;</span>
    <span class="tag">&lt;/jaxb:bindings&gt;</span>
<span class="tag">&lt;/jaxb:bindings&gt;</span></code></pre></div></div></section>
<section id="_konfiguration_eines_reader_für_xmljaxb"><h2>Konfiguration eines Reader für XML+JAXB</h2><pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Bean</span>
<span class="annotation">@JobScope</span>
StaxEventItemReader&lt;PersonJaxb&gt; personXmlReader(
        <span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters[file]}</span><span class="delimiter">&quot;</span></span>) Resource source) {
    <span class="keyword">return</span> <span class="keyword">new</span> StaxEventItemReaderBuilder&lt;PersonJaxb&gt;()
            .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">personXmlReader</span><span class="delimiter">&quot;</span></span>)
            .resource(source)
            .addFragmentRootElements(<span class="string"><span class="delimiter">&quot;</span><span class="content">person</span><span class="delimiter">&quot;</span></span>)
            .unmarshaller(getUnmarshaller())
            .build();
}</code></pre>
<pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Bean</span>
Unmarshaller getUnmarshaller() {
    Jaxb2Marshaller marshaller = <span class="keyword">new</span> Jaxb2Marshaller();
    marshaller.setContextPath(Persons.class.getPackage().getName());
    marshaller.setMappedClass(PersonJaxb.class);
    <span class="keyword">return</span> marshaller;
}</code></pre>
<div class="paragraph"><p>Wichtig ist, dass das Root-Element für das Fragment mit der <em>MappedClass</em> beim
<code>Jaxb2Marshaller</code> übereinstimmt.</p></div></section>
<section id="_json"><h2>JSON</h2><div class="paragraph"><p>Analog zur XML-Verarbeitung gibt es für JSON die beiden Klassen:</p></div>
<div class="ulist"><ul><li><p><strong><code>JsonItemReader</code></strong></p></li><li><p><strong><code>JsonItemWriter</code></strong></p></li></ul></div>
<div class="paragraph"><p>Auch diese Verarbeiten bzw. Erstellen JSON-Dateien fragmentweise (ermöglicht große Dateien)</p></div>
<div class="ulist"><ul><li><p>Zur (De-)Serialisierung können wahlweise <em>Jackson</em> oder <em>Gson</em> eingesetzt werden.</p></li><li><p>Je Fragment ist ein entsprechender <code>JsonObjectReader</code> zum Lesen bzw.
ein <code>JsonObjectMarshaller</code> zum Schreiben notwendig.</p></li></ul></div></section>
<section id="_lesen_mit_jackson"><h2>Lesen mit Jackson</h2><pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Bean</span>
<span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">jackson</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@StepScope</span>
JsonItemReader&lt;Person&gt; personJacksonReader(<span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters[file]}</span><span class="delimiter">&quot;</span></span>) Resource source) {
    <span class="keyword">return</span> <span class="keyword">new</span> JsonItemReaderBuilder&lt;Person&gt;()
            .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">personJacksonReader</span><span class="delimiter">&quot;</span></span>)
            .jsonObjectReader(jacksonJsonObjectReader())
            .resource(source)
            .build();
}

<span class="annotation">@Bean</span>
JacksonJsonObjectReader&lt;Person&gt; jacksonJsonObjectReader() {
        JacksonJsonObjectReader&lt;Person&gt; objectReader = <span class="keyword">new</span> JacksonJsonObjectReader&lt;&gt;(Person.class);
    objectReader.setMapper(objectMapper());
    <span class="keyword">return</span> objectReader;
}

<span class="annotation">@Bean</span>
ObjectMapper objectMapper() {
        ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();
    objectMapper.registerModule(<span class="keyword">new</span> JavaTimeModule());
    <span class="keyword">return</span> objectMapper;
}</code></pre></section>
<section id="_lesen_mit_gson"><h2>Lesen mit Gson</h2><pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Bean</span>
<span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">gson</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@StepScope</span>
JsonItemReader&lt;Person&gt; personGsonReader(<span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters[file]}</span><span class="delimiter">&quot;</span></span>) Resource source) {
    <span class="keyword">return</span> <span class="keyword">new</span> JsonItemReaderBuilder&lt;Person&gt;()
            .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">personGsonReader</span><span class="delimiter">&quot;</span></span>)
            .jsonObjectReader(gsonJsonObjectReader())
            .resource(source)
            .build();
}

<span class="annotation">@Bean</span>
GsonJsonObjectReader&lt;Person&gt; gsonJsonObjectReader() {
        GsonJsonObjectReader&lt;Person&gt; objectReader = <span class="keyword">new</span> GsonJsonObjectReader&lt;&gt;(Person.class);
    objectReader.setMapper(gson());
    <span class="keyword">return</span> objectReader;
}

<span class="annotation">@Bean</span>
Gson gson() {
    <span class="keyword">return</span> <span class="keyword">new</span> GsonBuilder()
            .registerTypeAdapter(LocalDate.class, <span class="keyword">new</span> LocalDateTypeAdapter().nullSafe())
            .create();
}

<span class="comment">// see https://stackoverflow.com/questions/39192945/serialize-java-8-localdate-as-yyyy-mm-dd-with-gson/39193077#39193077</span>
<span class="directive">static</span> <span class="type">class</span> <span class="class">LocalDateTypeAdapter</span> <span class="directive">extends</span> TypeAdapter&lt;LocalDate&gt; {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> write(JsonWriter out, LocalDate value) <span class="directive">throws</span> <span class="exception">IOException</span> {
        out.value(DateTimeFormatter.ISO_LOCAL_DATE.format(value));
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> LocalDate read(JsonReader in) <span class="directive">throws</span> <span class="exception">IOException</span> {
        <span class="keyword">return</span> LocalDate.parse(in.nextString());
    }
}</code></pre></section>
<section id="_zusammenfassung_lektion_5"><h2>Zusammenfassung Lektion 5</h2><div class="ulist"><ul><li><p>Überblick über die Reader und Writer von Spring-Batch</p></li><li><p>Reader und Writer für die Datenbankzugriff</p></li><li><p>Dateisystemzugriff und Verarbeitung von strukturierten Textdateien (CSV, XML, JSON)</p></li><li><p>Konfiguration des <code>FlatFileItemReader</code>.</p></li><li><p>Hilfsklassen für Komposition und Dekoration von Readern und Writern</p></li><li><p>Validierung</p></li></ul></div></section>
<section id="_aufgabe"><h2>Aufgabe:</h2><div class="olist arabic"><ol class="arabic"><li><p>Erstellen Sie einen Batch-Job, der die Einträge aus der Tabelle<br>
<code>BATCH_STEP_EXECUTION</code> als CSV-Datei exportiert.</p><div class="ulist"><ul><li><p>Verwenden Sie dazu die Klasse <code>StepExecutionData</code>,</p></li><li><p>das SQL-Statement <code>select * from BATCH_STEP_EXECUTION order by STEP_EXECUTION_ID</code>,</p></li><li><p>den <code>JdbcCursorItemReader</code> und</p></li><li><p>den <code>FlatFileItemWriterBuilder</code>.</p></li></ul></div></li><li><p>Filtern Sie alle Step-Executions mit Read-Count 0 heraus.
Verwenden Sie dafür den <code>BeanValidatingItemProcessor</code>
(siehe <code>@Min(value = 50)</code> in <code>StepExecutionData</code>).</p></li><li><p><em>Optional</em>: Exportieren Sie die Einträge als XML- oder JSON-Datei.</p></li></ol></div>
<div class="paragraph"><p><br>
&#8594; <a href="index.html">Agenda</a></p></div></section>
<section id="_lektion_6_parallelverarbeitung" data-state="no-title-footer"><h2>Lektion 6 - Parallelverarbeitung</h2></section>
<section id="_überblick_zu_dieser_lektion_5"><h2>Überblick zu dieser Lektion</h2><div class="olist arabic"><ol class="arabic"><li><p><a href="lesson06-parallel.html#/_step_mit_mehreren_threads_ausf%C3%BChren">Multithreading in Spring-Batch</a></p></li><li><p><a href="lesson06-parallel.html#/_partitionierung">Partitionierung</a>
(<a href="lesson06-parallel.html#/_aufgabe_1_summe_von_1_bis_100">Aufgabe 1</a>)</p></li><li><p><a href="lesson06-parallel.html#/_workflows_mit_spring_batch">Workflows</a>
(<a href="lesson06-parallel.html#/_aufgabe_2_producerconsumer">Aufgabe 2</a>)</p></li></ol></div></section>
<section id="_optimierung"><h2>Optimierung&#8230;&#8203;</h2><div class="quoteblock"><blockquote><div class="ulist"><ul><li><p>Rule 1: Don&#8217;t do it.</p></li><li><p>Rule 2: (for experts only) Don&#8217;t do it yet.</p></li></ul></div></blockquote><div class="attribution"><cite>Principals of Program Design</cite><br>&#8212; Michael A. Jackson (1975)</div></div>
<div class="quoteblock"><blockquote><div class="paragraph"><p>More computing sins are committed in the name of efficiency
(without necessarily achieving it) than for any other single
reason&#8201;&#8212;&#8201;including blind stupidity.</p></div></blockquote><div class="attribution">&#8212; W. A. Wulff</div></div></section>
<section id="_vorüberlegungen_zur_parallelisierung"><h2>Vorüberlegungen zur Parallelisierung</h2><div class="ulist"><ul><li class="fragment"><p>Muss das sein?</p></li><li class="fragment"><p>&#8658; Lieber erst mal die Chunkgröße justieren</p></li><li class="fragment"><p>&#8658; Erst mal ermitteln, wo der Performance-Engpass überhaupt liegt</p></li><li class="fragment"><p>Sie sind nicht allein!</p></li><li class="fragment"><p>&#8658; Welche (Online-)Anwendungen verwenden die gleichen Backend-Systeme?</p></li><li class="fragment"><p>&#8658; Welche Last ist zu welcher Uhrzeit vertretbar, ohne den Betrieb zu behindern?</p></li><li class="fragment"><p>Welche Art der Parallelisierung ist sinnvoll?</p></li><li class="fragment"><p>&#8658; Bei äußerst rechenintensiven Anwendungen:<br>
Verteilung auf mehrere Rechner (<em>Remote Chunking/-Partitioning</em>)</p></li><li class="fragment"><p>&#8658; Bei langsamer I/O (Webservice-Aufruf, Archivsystem, Datenbank): Multithreading</p></li></ul></div></section>
<section id="_möglichkeiten_der_parallelisierung"><h2>Möglichkeiten der Parallelisierung</h2><div class="ulist"><ul><li><p>Einen Step mit mehreren Threads ausführen</p></li><li><p>Mehrere Steps gleichzeitig ausführen (Flows)</p></li><li><p>Partitionierung</p></li><li><p>Remote Chunking</p></li></ul></div></section>
<section id="_step_mit_mehreren_threads_ausführen"><h2>Step mit mehreren Threads ausführen</h2><pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Bean</span>
ThreadPoolTaskExecutor taskExecutor() {
    ThreadPoolTaskExecutor taskExecutor = <span class="keyword">new</span> ThreadPoolTaskExecutor();
    taskExecutor.setCorePoolSize(<span class="integer">8</span>);
    <span class="keyword">return</span> taskExecutor;
}</code></pre>
<pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Bean</span>
TaskletStep parallelStep() {
    TaskletStep step = stepBuilderFactory
            .get(<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelStep</span><span class="delimiter">&quot;</span></span>)
            .&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>&gt;chunk(<span class="integer">5</span>)
            .reader(reader()).processor(processor()).writer(writer())
            .taskExecutor(taskExecutor()) <span class="comment">// Ausführung mit mehreren Threads</span>
            .throttleLimit(<span class="integer">4</span>) <span class="comment">// begrenzt Anzahl der Threads (default: 4)</span>
            .build();
    <span class="keyword">return</span> step;
}</code></pre>
<div class="ulist"><ul><li><p><code>TaskExecutorRepeatTemplate</code> führt <code>Tasklet</code> mit mehreren Threads aus</p></li><li><p>Reader, Processor und Writer müssen <strong>thread-save</strong> sein</p></li><li><p>Chunk-size bestimmt Synchronisationsaufwand</p></li></ul></div></section>
<section id="_taskexecutor_varianten_und_deren_verwendung"><h2>TaskExecutor Varianten und deren Verwendung</h2><div class="imageblock" style=""><img src="images/TaskExecutorVarianten.svg" alt="TaskExecutorVarianten" width="2472" height="638"></div></section>
<section id="_wo_kann_man_überall_einen_taskexecutor_angeben"><h2>Wo kann man überall einen TaskExecutor angeben?</h2><div class="imageblock" style=""><img src="images/TaskExecutorBuilder.svg" alt="TaskExecutorBuilder" width="2086" height="694"></div></section>
<section id="_partitionierung"><h2>Partitionierung</h2><div class="ulist"><ul><li><p>Erzeugt mehrere Kopien eines Steps.</p></li><li><p>Jeder Step hat einen eigenen Namen (z. B. <em>simpleStep:partition1</em>), einen eigenen ExecutionContext
und wird als separater Step im Repository gespeichert.</p></li><li><p>Jeder Step wird nur von einem Thread ausgeführt.</p></li><li><p>Für jede mit @StepScope annotierte Bean (z. B. Reader, Processor oder Writer) wird
für jeden Step ein eigenes Exemplar erzeugt &#8658; <strong>Bean braucht nicht thread-safe sein</strong><br>
(D. h. man kann nach belieben Instanzvariablen verwenden)</p></li><li><p>Ermöglicht Aufteilung der Datenmenge (Partitioniertung) und Verteilung auf die einzelnen Steps</p></li><li><p>Sinnvolle Kriterien zur Aufteilung notwendig</p></li><li><p>Auch ohne Partitionierung der Daten in Kombination mit @StepScope sinnvoll</p></li><li><p>In Kombination mit Remote-Verarbeitung möglich</p></li></ul></div></section>
<section id="_partitionstep_ausführung"><h2>PartitionStep Ausführung</h2><div class="imageblock" style=""><img src="images/PartitionStepExec.svg" alt="PartitionStepExec" width="1628" height="714"></div></section>
<section id="_bestandteile_eines_partitionstep"><h2>Bestandteile eines PartitionStep</h2><div class="imageblock" style=""><img src="images/PartitionStepClasses.svg" alt="PartitionStepClasses" width="2705" height="738"></div></section>
<section id="_partitionstep_implementieren"><h2>PartitionStep implementieren</h2><div class="dlist"><dl><dt class="hdlist1">Partitioner: </dt><dd><div class="ulist"><ul><li><p>Interface selbst implementieren</p></li><li><p>Konvention für Key: <em>partition1</em>, <em>partition2</em>, &#8230;&#8203;</p></li><li><p>Information aus dem PartionStep-ExecutionContext auf die einzelnen ExecutionContexte verteilen</p></li></ul></div></dd><dt class="hdlist1">StepExecutionAggregator: </dt><dd><div class="ulist"><ul><li><p><code>DefaultStepExecutionAggregator</code> erweitern</p></li><li><p>Ergebnisse aus den einzelnen Step-ExecutionContexten zusammenfassen und in den
PartionStep-ExecutionContext übertragen.</p></li></ul></div></dd></dl></div></section>
<section id="_einfacher_partition_step_zur_parallelen_ausführung_eines_steps"><h2>Einfacher Partition-Step zur parallelen Ausführung eines Steps</h2><div class="title">Dieser Step wird repliziert und parallel ausgeführt:</div><pre class="CodeRay listingblock"><code class="java language-java"><span class="keyword">return</span> stepBuilderFactory
        .get(<span class="string"><span class="delimiter">&quot;</span><span class="content">simpleStep</span><span class="delimiter">&quot;</span></span>)
        .&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>&gt;chunk(<span class="integer">4</span>)
        .reader(reader()).processor(processor()).writer(writer())
        .build();</code></pre>
<div class="title">Der PartitionStep:</div><pre class="CodeRay listingblock"><code class="java language-java"><span class="keyword">return</span> stepBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">partitionStep</span><span class="delimiter">&quot;</span></span>)
        .partitioner(<span class="string"><span class="delimiter">&quot;</span><span class="content">stepx</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> SimplePartitioner()) <span class="comment">// Präfix für partitionierte Steps</span>
        .step(step()) <span class="comment">// Der Step, der von meheren Threads ausgeführt wird</span>
        .gridSize(<span class="integer">5</span>) <span class="comment">// Anzahl Threads</span>
        .taskExecutor(taskExecutor())
        .build();</code></pre>
<div class="title">Der Job für den PartitionStep:</div><pre class="CodeRay listingblock"><code class="java language-java"><span class="keyword">return</span> jobBuilderFactory
        .get(<span class="string"><span class="delimiter">&quot;</span><span class="content">partitionJob</span><span class="delimiter">&quot;</span></span>)
        .start(partitionStep())
        .build();</code></pre>
<div class="admonitionblock tip teacherBox"><table><tr><td class="icon"><i class="fa fa-lightbulb-o" title="Tip"></i></td><td class="content"><code>@StepScope</code> bei (Reader), Processor und Writer erspart <code>synchronized</code>.<br>
&#8658; Möglichst immer PartitionStep zur parallelen Ausführung eines Steps verwenden.</td></tr></table></div></section>
<section id="_aufgabe_1_summe_von_1_bis_100"><h2>Aufgabe 1: Summe von 1 bis 100</h2><div class="ulist"><ul><li><p>Implementieren Sie einen Job, der alle Zahlen von 1 bis 100 zusammenzählt. Partitionieren Sie
dafür die Zahlenmenge in 5 gleich große Teile um diese parallel aufzusummieren.</p></li><li><p>Geben Sie danach das Ergebnis über einen weiteren Tasklet-Step auf System.out aus.</p></li><li><p>Sie können für diese Aufgabe die vorhandenen Klassen <code>NumberRangePartitioner</code>,
<code>NumberRangeReader</code>, <code>ShowResultTasklet</code>, <code>SumAggregator</code> und <code>SumItemWriter</code> verwenden.</p></li><li><p>Prüfen Sie den Job mit dem <code>PartitionGaussTest</code>.</p></li></ul></div>
<div class="admonitionblock tip teacherBox"><table><tr><td class="icon"><i class="fa fa-lightbulb-o" title="Tip"></i></td><td class="content">Versuchen Sie den Job erst mal ohne Partitionierung zum Laufen zu bekommen.</td></tr></table></div>
<div class="admonitionblock tip teacherBox"><table><tr><td class="icon"><i class="fa fa-lightbulb-o" title="Tip"></i></td><td class="content">Die Klassen <code>JobParameterExecutionContextCopyListener</code> und <code>ExecutionContextPromotionListener</code>
könnten hilfreich sein.</td></tr></table></div></section>
<section id="_workflows_mit_spring_batch"><h2>Workflows mit Spring-Batch</h2><div class="paragraph"><p>Spring-Batch kann mehr als Steps der Reihe nach ausführen:</p></div>
<div class="ulist"><ul><li><p>Mehrere Steps können gleichzeitig ausgeführt werden</p></li><li><p>Man kann abhängig von einer Bedingung zu einem von mehreren
möglichen Folgesteps verzweigen</p></li><li><p>Damit lassen sich komplexe Workflows realsieren</p></li></ul></div></section>
<section id="_beispiel_für_job_mit_flow" class="columns"><h2>Beispiel für Job mit Flow</h2><div class="openblock"><div class="content"><div class="title">FlowJobConfig.java</div><pre class="CodeRay listingblock"><code class="java language-java">Step step3 = createTaskletStep(<span class="string"><span class="delimiter">&quot;</span><span class="content">step 3</span><span class="delimiter">&quot;</span></span>, ExitStatus.FAILED);
Step step3x = createTaskletStep(<span class="string"><span class="delimiter">&quot;</span><span class="content">step 3x</span><span class="delimiter">&quot;</span></span>);
Step step4 = createTaskletStep(<span class="string"><span class="delimiter">&quot;</span><span class="content">step 4</span><span class="delimiter">&quot;</span></span>);
Flow flow1 = <span class="keyword">new</span> FlowBuilder&lt;Flow&gt;(<span class="string"><span class="delimiter">&quot;</span><span class="content">flow1</span><span class="delimiter">&quot;</span></span>)
        .from(createTaskletStep(<span class="string"><span class="delimiter">&quot;</span><span class="content">step 2a 1</span><span class="delimiter">&quot;</span></span>))
        .next(createTaskletStep(<span class="string"><span class="delimiter">&quot;</span><span class="content">step 2a 2</span><span class="delimiter">&quot;</span></span>))
        .build();
Flow flow2 = <span class="keyword">new</span> FlowBuilder&lt;Flow&gt;(<span class="string"><span class="delimiter">&quot;</span><span class="content">flow2</span><span class="delimiter">&quot;</span></span>)
        .from(createTaskletStep(<span class="string"><span class="delimiter">&quot;</span><span class="content">step 2b</span><span class="delimiter">&quot;</span></span>))
        .build();
Job job = jobBuilderFactory
        .get(<span class="string"><span class="delimiter">&quot;</span><span class="content">flowJob</span><span class="delimiter">&quot;</span></span>)
        .start(createTaskletStep(<span class="string"><span class="delimiter">&quot;</span><span class="content">step 1</span><span class="delimiter">&quot;</span></span>))
        .split(taskExecutor()).add(flow1, flow2)
        .next(step3)
        .on(ExitStatus.COMPLETED.getExitCode()).to(step4)
        .from(step3).on(ExitStatus.FAILED.getExitCode())
        .to(step3x).next(step4)
        .end()
        .build();</code></pre></div></div>
<div class="openblock"><div class="content"><div class="imageblock" style=""><img src="images/FlowBuilderSample.svg" alt="FlowBuilderSample" width="331" height="849"></div></div></div></section>
<section id="_flowsstate_pattern"><h2>Flows&#8201;&#8212;&#8201;State-Pattern</h2><div class="imageblock" style=""><img src="images/Flows.svg" alt="Flows" width="2478" height="778"></div></section>
<section id="_builder_api_für_flows"><h2>Builder-API für Flows</h2><div class="imageblock" style=""><img src="images/FlowBuilderApi.svg" alt="FlowBuilderApi" width="3051" height="810"></div></section>
<section id="_die_wichtigsten_methoden_für_flows"><h2>Die wichtigsten Methoden für Flows</h2><div class="ulist"><ul><li><p>flow(Step).next(Flow/Step).next(Flow/Step).end()</p></li><li><p>start(Flow).next(Flow/Step).next(Flow/Step).end()</p></li><li><p>split(TaskExecutor).add(Flow, Flow,&#8230;&#8203;).build()</p></li><li><p>on(String exitCode).to(Flow/Step)</p></li><li><p>from(Flow/Step).to(Flow/Step)</p></li><li><p>from(Flow/Step).on(String).to(Flow/Step)</p></li><li><p>from(JobExecutionDecider).on(String).to(Flow/Step)</p></li></ul></div></section>
<section id="_praktische_anwendung_von_flows_producerconsumer"><h2>Praktische Anwendung von Flows: Producer/Consumer</h2><div class="imageblock" style=""><img src="images/parallel/ProducerConsumer.svg" alt="ProducerConsumer" width="1200"></div>
<div class="ulist"><ul><li><p>Erster Step liest Daten sequentiell z. B. von einer CSV-Datei</p></li><li><p>Zweiter Step speichert Daten und nutzt dafür mehrere Threads</p></li><li><p>Sinnvoll wenn paralleles Schreiben den Durchsatz erhöht (Webservice, Datenbank)</p></li><li><p>Statt über einen Writer kann man die Queue auch über einen Listener
(z. B. <code>ChunkListener</code>) befüllen.</p></li></ul></div>
<div class="admonitionblock warning teacherBox"><table><tr><td class="icon"><i class="fa fa-warning" title="Warning"></i></td><td class="content">Mit einer In-Memory-Queue gehen, die Daten bei einem Abbruch verloren,
obwohl sie in Step 1 bereits als verarbeitet markiert wurden. Standardmäßig werden
diese Daten also nicht erneut gelesen.</td></tr></table></div></section>
<section id="_interaktion_der_steps_bei_producerconsumer"><h2>Interaktion der Steps bei Producer/Consumer</h2><div class="imageblock" style=""><img src="images/ProducerConsumerFlow.svg" alt="ProducerConsumerFlow" width="1545" height="920"></div></section>
<section id="_zusammenfassung_lektion_6"><h2>Zusammenfassung Lektion 6</h2><div class="ulist"><ul><li><p>Vor Einsatz von Parallelverarbeitung erst mal Notwendigkeit, Nutzen und Auswirkungen prüfen!</p></li><li><p>Parallelverarbeitung geht immer über einen <code>TaskExecutor</code>, davon gibt es mehrere Varianten.</p></li><li><p>Einfachste Parallelverarbeitung ist das Ausführen eines Steps mit mehreren Threads.</p></li><li><p>Mittels Partitionierung arbeitet jeder Thread auf eigenen Daten.</p></li><li><p>Flows ermöglichen die gleichzeitige Ausführung verschiedener Steps.</p></li></ul></div></section>
<section id="_aufgabe_2_producerconsumer"><h2>Aufgabe 2: Producer/Consumer</h2><div class="olist arabic"><ol class="arabic"><li><p>Verwenden Sie als Ausgangspunkt den Job in <code>ProducerConsumerJobConfig</code> und
<code>ProducerConsumerJobTest</code> um diesen Job auszuführen.</p></li><li><p>Teilen Sie den <code>simpleStep</code> in einen Producer-Step und einem Consumer-Step auf.</p></li><li><p>Nutzen Sie die <code>ProducerConsumerQueue</code> als Queue.</p></li><li><p>Verwenden Sie <code>-1</code> als Endemarkierung.</p></li><li><p>Sie benötigen 3 Flows für den Job: Producer-, Consumer-, und Split-Flow.</p></li><li><p>Führen Sie den Consumer mit mehreren Threads und einem <code>throttleLimit</code> von 8 aus.</p></li></ol></div>
<div class="admonitionblock caution teacherBox"><table><tr><td class="icon"><i class="fa fa-fire" title="Caution"></i></td><td class="content">Mit zu vielen Threads, gehen die Datenbankconnections aus!</td></tr></table></div></section>
<section id="_2"><h2>&#8230;&#8203;</h2><div class="paragraph"><p>&#8594; <a href="index.html">Agenda</a></p></div></section>
<section id="_lektion_7_remote_verarbeitung" data-state="no-title-footer"><h2>Lektion 7 - Remote-Verarbeitung</h2></section>
<section id="_überblick_zu_dieser_lektion_6"><h2>Überblick zu dieser Lektion</h2><div class="olist arabic"><ol class="arabic"><li><p>Lastverteilung auf mehrere Rechner</p></li><li><p><a href="http://localhost:8071/lesson07-remote.html#/_messaging">Messaging (ActiveMQ)</a></p></li><li><p><a href="http://localhost:8071/lesson07-remote.html#/_chunkorientedtasklet_bei_remote_chunking">Remote-Chunking</a>
(<a href="http://localhost:8071/lesson07-remote.html#/_aufgabe_1_job_auf_remote_chunking_umstellen">Aufgabe 1</a>)</p></li><li><p><a href="http://localhost:8071/lesson07-remote.html#/_wiederholung_partitionstep_ausf%C3%BChrung">Remote-Partitioning</a>
(<a href="http://localhost:8071/lesson07-remote.html#/_aufgabe_2_summe_von_1_bis_100_mit_remote_partitioning">Aufgabe 2</a>)</p></li></ol></div></section>
<section id="_wann_ist_lastverteilung_auf_mehere_rechner_sinnvoll"><h2>Wann ist Lastverteilung auf mehere Rechner sinnvoll?</h2><div class="ulist"><div class="title">Lastverteilung ist sinnvoll bei:</div><ul><li class="fragment"><p>rechenintensiven Jobs</p></li><li class="fragment"><p>großen Datenmengen (IO, Arbeitsspeicher)</p></li><li class="fragment"><p>evtl. zur Erhöhung der Ausfallsicherheit</p></li></ul></div>
<div class="ulist"><div class="title">aber</div><ul><li class="fragment"><p>Lastverteilung erhöht die Komplexität</p></li><li class="fragment"><p>Kommunikation zwischen Manager und Workern erhöht IO-Last</p></li><li class="fragment"><p>&#8658; Kosten und Nutzen abwägen!</p><div class="admonitionblock note teacherBox"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">Partitionierung ist sinnvoll, wenn ein externer Dienst (Datenbank, Webservice)<br>
Wartzeiten verursacht.<br>
Lastverteilung ist sinnvoll, wenn die Leistung eines Rechners
nicht mehr ausreicht.</td></tr></table></div></li></ul></div></section>
<section id="_einfachste_variante_der_lastverteilung_unabhängig_von_spring_batch"><h2>Einfachste Variante der Lastverteilung (unabhängig von Spring-Batch)</h2><div class="ulist"><div class="title">Voraussetzungen:</div><ul><li><p>Anzahl der Knoten ist fix</p></li><li><p>Name oder IP-Adressen der Knoten sind bekannt und fest</p></li><li><p>Datenmenge läßt sich in n Paritionen aufteilen (n = Anzahl Knoten)</p></li></ul></div>
<div class="paragraph"><p><br></p></div>
<div class="ulist"><div class="title">Umsetzung:</div><ul><li><p>Knotenname wird als Parameter übergeben</p></li><li><p>Datenmenge wird immer gleich partitioniert (auf jedem Knoten)</p></li><li><p>Jede Partition ist von einem Knoten zu bearbeiten (Zuordnung über Knotenname)</p></li></ul></div></section>
<section id="_lastverteilung_mit_spring_batch"><h2>Lastverteilung mit Spring-Batch</h2><div class="ulist"><ul><li><p>Remote Chunking</p></li><li><p>Remote Paritioning</p></li></ul></div></section>
<section id="_remote_chunking"><h2>Remote Chunking</h2><div class="imageblock" style=""><img src="images/remote/remote-chunking.png" alt="remote chunking" width="1000"></div></section>
<section id="_remote_partitioning"><h2>Remote Partitioning</h2><div class="imageblock" style=""><img src="images/remote/partitioning-overview.png" alt="partitioning overview" width="1000"></div></section>
<section id="_messaging_2" class="columns"><h2>Messaging</h2><div class="ulist"><ul><li><p>Verschicken von Nachrichten über Rechnergrenzen hinweg</p></li><li><p>Erfordert Messaging-Middleware (Broker)</p></li><li><p>Empfänger kann (temporär) offline sein</p></li><li><p>Zustellung wird grantiert</p></li><li><p>Einstellen und Abholen von Nachrichten ist transaktional</p></li><li><p>Kann für entfernte Methodenaufrufe (RMI) verwendet werden</p></li><li><p>Message in <em>Spring Integration</em>:</p><div class="imageblock" style="text-align: left"><img src="images/MessageClass.svg" alt="MessageClass" width="856" height="184"></div></li></ul></div>
<div class="imageblock" style="float: right"><img src="images/remote/51SO8Sn59NL._SX376_BO1,204,203,200_.jfif" alt="51SO8Sn59NL. SX376 BO1,204,203,200 " width="500"></div></section>
<section id="_activemq"><h2>ActiveMQ</h2><div class="ulist"><ul><li><p>Pure Java</p></li><li><p>Sehr einfach aufzusetzen (Maven-Plugin, ZIP-File, Docker-Image)</p></li><li><p>Kann in eigene Anwendungen intergriert werden (eigener Broker)</p></li><li><p>Verschiedene <em>Persistence Adapter</em> verfügbar (u. a. In-Memory)</p></li><li><p>Unterstützt verschieden Protokolle: JMS, AMQP, STOMP, MQTT</p></li><li><p>In zwei Ausprägungen verfügbar: <em>ActiveMQ 5 "Classic"</em> und <em>ActiveMQ Artemis</em> (non-blocking)</p></li><li><p>Alternativen: RabbitMQ, Kafka</p></li></ul></div></section>
<section id="_konfiguration_einer_jms_connectionfactory_für_activemq"><h2>Konfiguration einer JMS-ConnectionFactory für ActiveMQ</h2><pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Configuration</span>
<span class="annotation">@PropertySource</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:remote.properties</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">ActiveMQConfig</span> {

    <span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">${broker.url}</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> brokerUrl;

    <span class="annotation">@Bean</span>
    ActiveMQConnectionFactory connectionFactory() {
        ActiveMQConnectionFactory connectionFactory = <span class="keyword">new</span> ActiveMQConnectionFactory();
        connectionFactory.setBrokerURL(<span class="local-variable">this</span>.brokerUrl);
        connectionFactory.setTrustAllPackages(<span class="predefined-constant">true</span>);
        <span class="keyword">return</span> connectionFactory;
    }
}</code></pre>
<div class="title">remote.properties</div><pre class="CodeRay listingblock"><code>broker.url=tcp://localhost:61616</code></pre></section>
<section id="_chunkorientedtasklet_bei_remote_chunking"><h2>ChunkOrientedTasklet bei Remote-Chunking</h2><div class="imageblock" style=""><img src="images/RemoteChunkOrientedTasklet.svg" alt="RemoteChunkOrientedTasklet" width="2426" height="566"></div></section>
<section id="_worker_bei_remote_chunking"><h2>Worker bei Remote-Chunking</h2><div class="imageblock" style=""><img src="images/RemoteChunkingWorker.svg" alt="RemoteChunkingWorker" width="1780" height="602"></div></section>
<section id="_stepbuilder_für_remote_chunking"><h2>StepBuilder für Remote-Chunking</h2><div class="imageblock" style=""><img src="images/RemoteChunkingStepBuilder.svg" alt="RemoteChunkingStepBuilder" width="2122" height="630"></div></section>
<section id="_konfiguration_von_manager_und_worker_für_remote_chunking"><h2>Konfiguration von Manager und Worker für Remote-Chunking</h2><div class="title">Manager:</div><pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Configuration</span>
<span class="annotation">@Import</span>(ActiveMQConfig.class)
<span class="annotation">@EnableBatchProcessing</span>
<span class="annotation">@EnableBatchIntegration</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SampleManagerConfig</span> {
    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> RemoteChunkingManagerStepBuilderFactory managerStepBuilderFactory;
    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> ActiveMQConnectionFactory connectionFactory;
    <span class="comment">//...</span>
}</code></pre>
<div class="title">Worker:</div><pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Configuration</span>
<span class="annotation">@Import</span>(ActiveMQConfig.class)
<span class="annotation">@EnableBatchProcessing</span>
<span class="annotation">@EnableBatchIntegration</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SampleWorkerConfig</span> {
    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> RemoteChunkingWorkerBuilder&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">Integer</span>&gt; remoteChunkingWorkerBuilder;
    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> ActiveMQConnectionFactory connectionFactory;
    <span class="comment">//...</span>
}</code></pre></section>
<section id="_konfiguration_eines_outbound_flow"><h2>Konfiguration eines Outbound-Flow</h2><pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Bean</span>
DirectChannel requests() {
    <span class="keyword">return</span> <span class="keyword">new</span> DirectChannel();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> IntegrationFlow outboundFlow() {
    <span class="keyword">return</span> IntegrationFlows
            .from(requests())
            .handle(Jms.outboundAdapter(connectionFactory)
                    .destination(<span class="string"><span class="delimiter">&quot;</span><span class="content">sample.requests</span><span class="delimiter">&quot;</span></span>))
            .get();
}</code></pre>
<div class="admonitionblock note teacherBox"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">Die selbe Destination muss im Worker als Inbound-Flow konfiguriert werden.</td></tr></table></div></section>
<section id="_konfiguration_eines_inbound_flow"><h2>Konfiguration eines Inbound-Flow</h2><pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Bean</span>
<span class="directive">public</span> QueueChannel replies() {
    <span class="keyword">return</span> <span class="keyword">new</span> QueueChannel();
}

<span class="annotation">@Bean</span>
<span class="directive">public</span> IntegrationFlow inboundFlow() {
    <span class="keyword">return</span> IntegrationFlows
            .from(Jms.messageDrivenChannelAdapter(connectionFactory)
                    .destination(<span class="string"><span class="delimiter">&quot;</span><span class="content">sample.replies</span><span class="delimiter">&quot;</span></span>))
            .channel(replies())
            .get();
}</code></pre>
<div class="admonitionblock note teacherBox"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">Der <code>ChunkMessageChannelItemWriter</code> (Manager) benötigt einen <code>PollableChannel</code>,
also z. B. den <code>QueueChannel</code>. In allen anderen Fällen genügt ein einfacher <code>MessageChannel</code>,
also z. B. <code>DirectChannel</code>.</td></tr></table></div></section>
<section id="_manager_step_und_zugehöriger_worker_flow"><h2>Manager-Step und zugehöriger Worker-Flow</h2><div class="title">SampleRemoteChunkingManagerConfig.java</div><pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Bean</span>
<span class="directive">public</span> TaskletStep managerStep() {
    <span class="keyword">return</span> <span class="local-variable">this</span>.managerStepBuilderFactory.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">managerStep</span><span class="delimiter">&quot;</span></span>)
            .chunk(<span class="integer">10</span>)
            .reader(reader)
            .outputChannel(requests())
            .inputChannel(replies())
            .build();
}</code></pre>
<div class="paragraph"><p><br></p></div>
<div class="title">SampleRemoteChunkingWorkerConfig.java</div><pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Bean</span>
<span class="directive">public</span> IntegrationFlow workerIntegrationFlow() {
    <span class="keyword">return</span> <span class="local-variable">this</span>.remoteChunkingWorkerBuilder
            .itemProcessor(processor)
            .itemWriter(writer)
            .inputChannel(requests())
            .outputChannel(replies())
            .build();
}</code></pre></section>
<section id="_aufgabe_1_job_auf_remote_chunking_umstellen"><h2>Aufgabe 1: Job auf Remote-Chunking umstellen</h2><div class="olist arabic"><ol class="arabic"><li><p>Importieren Sie das Projekt <strong>exercises-remote</strong>.</p></li><li><p>Stellen Sie <strong><code>LocalDuplicateJobConfig</code></strong> auf Remote-Chunking um, indem Sie</p><div class="ulist"><ul><li><p><strong><code>DuplicateManagerConfig</code></strong> und</p></li><li><p><strong><code>DuplicateWorkerConfig</code></strong> implementieren.</p></li></ul></div></li><li><p>Nutzen Sie dafür die vorgebene <strong><code>ActiveMQConfig</code></strong>.</p></li><li><p>Starten Sie einen ActiveMQ-Broker, indem Sie in dem Projekt <strong>activemq-broker</strong>
über die Befehlszeile <code>mvn</code> aufrufen.</p></li><li><p>Nutzen Sie die beiden Unittests <code>DuplicateManagerStarter</code> und <code>DuplicateWorkerStarter</code> um
Manager und Worker auszuführen.</p></li><li><p>Setzen Sie Breakpoints in der <code>read</code>- bzw. <code>process</code>-Methode und sehen Sie sich die
Datenstrukturen von dem <code>ChunkOrientedTasklet</code> und dem <code>ChunkProcessorChunkHandler</code> an.</p></li><li><p>Sehen Sie sich den Repository-Inhalt zu diesem Remote-Chunking Job an.</p></li></ol></div></section>
<section id="_wiederholung_partitionstep_ausführung"><h2>Wiederholung: PartitionStep Ausführung</h2><div class="imageblock" style=""><img src="images/PartitionStepExecRemote.svg" alt="PartitionStepExecRemote" width="1994" height="764"></div></section>
<section id="_partitionstep_bei_remote_partitioning"><h2>PartitionStep bei Remote-Partitioning</h2><div class="imageblock" style=""><img src="images/RemotePartitioningStep.svg" alt="RemotePartitioningStep" width="900" height="566"></div></section>
<section id="_worker_bei_remote_partitioning"><h2>Worker bei Remote-Partitioning</h2><div class="imageblock" style=""><img src="images/RemotePartitioningWorker.svg" alt="RemotePartitioningWorker" width="1372" height="704"></div></section>
<section id="_stepbuilder_für_remote_partitioning"><h2>StepBuilder für Remote-Partitioning</h2><div class="imageblock" style=""><img src="images/RemotePartitioningStepBuilder.svg" alt="RemotePartitioningStepBuilder" width="2204" height="606"></div></section>
<section id="_manager_step_und_zugehöriger_worker_flow_bei_remote_partitioning"><h2>Manager-Step und zugehöriger Worker-Flow bei Remote-Partitioning</h2><div class="title">SampleRemotePartitioningManager.java</div><pre class="CodeRay listingblock"><code class="java language-java">Step step = managerStepBuilderFactory
        .get(<span class="string"><span class="delimiter">&quot;</span><span class="content">managerStep</span><span class="delimiter">&quot;</span></span>)
        .partitioner(<span class="string"><span class="delimiter">&quot;</span><span class="content">workerStep</span><span class="delimiter">&quot;</span></span>, partitioner)
        .outputChannel(requests())
        .inputChannel(replies())
        .build();</code></pre>
<div class="paragraph"><p><br></p></div>
<div class="title">SampleRemotePartitioningWorker.java</div><pre class="CodeRay listingblock"><code class="java language-java">Step step = workerStepBuilderFactory
        .get(<span class="string"><span class="delimiter">&quot;</span><span class="content">workerStep</span><span class="delimiter">&quot;</span></span>)
        .inputChannel(requests())
        .outputChannel(replies())
        .&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">Integer</span>&gt;chunk(<span class="integer">10</span>)
        .reader(reader)
        .processor(processor)
        .writer(writer)
        .build();</code></pre>
<div class="admonitionblock caution teacherBox"><table><tr><td class="icon"><i class="fa fa-fire" title="Caution"></i></td><td class="content">Bei Remote-Partitioning darf der Input-Channel für die <em>replies</em> (Manager)
kein <code>PollableChannel</code> sein. Man muss also <code>DirectChannel</code> statt <code>QueueChannel</code>
verwenden.</td></tr></table></div></section>
<section id="_unterschiede_remote_chunkingremote_partitioning" class="columns"><h2>Unterschiede Remote-Chunking&#8201;&#8212;&#8201;Remote-Partitioning</h2><div class="openblock"><div class="content"><div class="paragraph lead"><p>Remote-Chunking</p></div>
<div class="ulist"><ul><li><p>Reader im Manager</p></li><li><p>Gelesene Items werden als<br>
Message an Worker verschickt</p></li><li><p>Viel Netzwerk-Traffic</p></li><li><p>Sinnvoll, wenn Reader direkt<br>
auf Dateisystem zugreift</p></li></ul></div></div></div>
<div class="openblock"><div class="content"><div class="paragraph lead"><p>Remote-Partitioning</p></div>
<div class="ulist"><ul><li><p>Reader auf jedem Worker</p></li><li><p>Nur Metainformationen über Partions-<br>
grenzen werden an Worker verschickt</p></li><li><p>Netzwerk-Traffic moderat</p></li><li><p>Sinnvoll, wenn Reader die Daten von<br>
einer zentralen Datenquelle (Datenbank,<br>
Messaging-Middleware, Webservice) bezieht</p></li></ul></div></div></div></section>
<section id="_zusammenfassung_lektion_7"><h2>Zusammenfassung Lektion 7</h2><div class="ulist"><ul><li><p>Einfachste Partitionierung über Parameter</p></li><li><p>Messaging: transaktional und garantierte Zustellung</p></li><li><p>Remote-Chunking: Ein Reader, viel Traffic</p></li><li><p>Remote-Partitioning: Jeder Worker hat eigenen Reader</p></li></ul></div></section>
<section id="_aufgabe_2_summe_von_1_bis_100_mit_remote_partitioning"><h2>Aufgabe 2: Summe von 1 bis 100 mit Remote-Partitioning</h2><div class="olist arabic"><ol class="arabic"><li><p>Stellen Sie die Partitioning-Aufgabe aus der<br>
letzten Lektion auf Remote-Partitioning um.</p></li></ol></div>
<div class="paragraph"><p><br>
&#8594; <a href="index.html">Agenda</a></p></div></section>
<section id="_lektion_8_betrieb_von_batch_anwendungen" data-state="no-title-footer"><h2>Lektion 8 - Betrieb von Batch-Anwendungen</h2></section>
<section id="_überblick_zu_dieser_lektion_7"><h2>Überblick zu dieser Lektion</h2><div class="olist arabic"><ol class="arabic"><li><p><a href="#/_zeitgesteuerte_ausf%C3%BChrung_von_batch_jobs">Zeitgesteuerte Ausführung von Batch-Jobs</a></p></li><li><p><a href="#/_spring_integration_und_spring_batch">Integration via Messaging</a></p></li><li><p><a href="#/_rest">RESTful job processing</a></p></li><li><p><a href="#/_batchanwendungen_in_der_cloud">Batch-Anwendungen in der Cloud</a></p></li><li><p><a href="#/_monitoring_mit_micrometer">Monitoring</a></p></li></ol></div></section>
<section id="_möglichkeiten_einen_batch_job_anzustoßen"><h2>Möglichkeiten einen Batch-Job anzustoßen</h2><div class="olist arabic"><ol class="arabic"><li><p>Über die Befehlszeile mit dem <strong><code>CommandLineJobRunner</code></strong></p></li><li><p>Programmatisch über <strong><code>JobOperator.start()</code></strong> or <strong><code>JobLauncher.run()</code></strong></p></li><li><p>Als Spring-Boot-Anwendung:<br>
Standardmäßig werden alle Jobs beim Hochfahren der Anwendung ausgeführt.
Dieses Verhalten kann man in der <em>application.properties</em> mit
<code>spring.batch.job.enabled=false</code> unterbinden.</p></li><li><p>Über eine <em>Message</em> via Spring-Integration mit dem <strong><code>JobLaunchingMessageHandler</code></strong></p></li></ol></div></section>
<section id="_möglichkeiten_einen_batch_job_auszuliefern"><h2>Möglichkeiten einen Batch-Job auszuliefern</h2><div class="olist arabic"><ol class="arabic"><li><p>Als Shell-Skript (.bat, .sh) mit allen Abhängigkeiten in einem Verzeichnis</p></li><li><p>Als Maven <em>pom.xml</em> oder als Gradle-Skript</p></li><li><p>Als Spring-Boot-Anwendung (<em>uber jar</em>)</p></li><li><p>Als Docker-Image</p></li><li><p>Als Bestandteil einer bestehenden (Web-)Anwendung</p></li></ol></div></section>
<section id="_zeitgesteuerte_ausführung_von_batch_jobs"><h2>Zeitgesteuerte Ausführung von Batch-Jobs</h2><div class="olist arabic"><ol class="arabic"><li><p>Mit Bordmitteln des Betriebssystems: Crontab, Windows Task Scheduler (Aufgabenplanung)</p></li><li><p>Enterprise Job-Scheduler</p></li><li><p>Mit <code>@EnableScheduling</code> + <code>@Scheduled</code> in Spring</p></li><li><p>Quartz Job Scheduling Library</p></li></ol></div></section>
<section id="_verwendung_der_taskscheduler_abstraktion_von_spring"><h2>Verwendung der TaskScheduler-Abstraktion von Spring</h2><pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@EnableScheduling</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">HelloScheduledConfig</span> {
    <span class="annotation">@Scheduled</span>(cron = <span class="string"><span class="delimiter">&quot;</span><span class="content">${ops.hello.schedule.cron:-}</span><span class="delimiter">&quot;</span></span>)
    <span class="type">void</span> executeHelloJob() {
        <span class="comment">// ...</span>
    }
}</code></pre>
<div class="paragraph"><p>Die Property <code>ops.hello.schedule.cron</code> muss einen Cron-Ausdruck enthalten.
Siehe <a href="https://docs.spring.io/spring/docs/5.2.4.RELEASE/javadoc-api/org/springframework/scheduling/support/CronSequenceGenerator.html">
&#8594; Java-Docs zu CronSequenceGenerator</a>. Die Endung <strong><code>:-</code></strong> bewirkt, dass ein leerer String als
Cron-Ausdruck verwendet wird, wenn die Property nicht gesetzt ist. Damit wird die Ausführung unterbunden.</p></div>
<div class="paragraph"><p>Wenn beispielsweise der Job ab 0:03 Uhr alle 5 Minuten laufen soll, ist folgender Eintrag in
der <em>application.properties</em> notwendig:</p></div>
<pre class="CodeRay listingblock"><code>ops.hello.schedule.cron = 0 3/5 * * * *</code></pre></section>
<section id="_quartz_job_scheduling_library"><h2>Quartz Job Scheduling Library</h2><div class="ulist"><ul><li><p>Open-Source (Apache 2.0 license)</p></li><li><p>Java</p></li><li><p>Leicht in beliebige Applikationen zu integrieren</p></li><li><p>Job-Store wahlweise</p><div class="ulist"><ul><li><p>In-Memory (<code>RAMJobStore</code>) und Konfiguration via quartz.properties</p></li><li><p>JDBC sowohl über DataSource-Transaktionen (<code>JobStoreTX</code>)<br>
als auch JTA-Transaktionen (<code>JobStoreCMT</code>)</p></li></ul></div></li><li><p>Von Spring unterstützt</p></li></ul></div></section>
<section id="_die_wichtigsten_elemente_von_quartz"><h2>Die wichtigsten Elemente von Quartz</h2><div class="imageblock" style=""><img src="images/Quartz.svg" alt="Quartz" width="2152" height="694"></div>
<div class="admonitionblock note teacherBox"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">Interfaces sind von Quartz und Klassen sind von Spring.</td></tr></table></div></section>
<section id="_quartzjobbean_um_einen_batch_job_zu_starten"><h2>QuartzJobBean um einen Batch-Job zu starten</h2><pre class="CodeRay listingblock"><code class="java language-java"><span class="directive">public</span> <span class="type">class</span> <span class="class">HelloQuartzJob</span> <span class="directive">extends</span> QuartzJobBean {
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> log = LoggerFactory.getLogger(HelloQuartzJob.class);

    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> JobExplorer jobExplorer;
    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> JobLauncher jobLauncher;
    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> Job helloQuartzJob;

    <span class="annotation">@Override</span>
    <span class="directive">protected</span> <span class="type">void</span> executeInternal(JobExecutionContext context) <span class="directive">throws</span> JobExecutionException {
        JobParameters jobParameters = <span class="keyword">new</span> JobParametersBuilder(jobExplorer)
                .addDate(<span class="string"><span class="delimiter">&quot;</span><span class="content">scheduled.at</span><span class="delimiter">&quot;</span></span>, context.getScheduledFireTime()) <span class="comment">// wird im Cluster nur einmal ausgeführt</span>
                .toJobParameters();
        <span class="keyword">try</span> {
            JobExecution jobExecution = jobLauncher.run(helloQuartzJob, jobParameters);
            log.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">HelloQuartzJob finished: {}</span><span class="delimiter">&quot;</span></span>, jobExecution);
            <span class="keyword">if</span> (!ExitStatus.COMPLETED.getExitCode().equals(jobExecution.getExitStatus().getExitCode())) {
                <span class="keyword">throw</span> <span class="keyword">new</span> JobExecutionException(<span class="string"><span class="delimiter">&quot;</span><span class="content">HelloQuartzJob ended with </span><span class="delimiter">&quot;</span></span> + jobExecution.getExitStatus());
            }
        } <span class="keyword">catch</span> (JobExecutionAlreadyRunningException | JobRestartException
                | JobInstanceAlreadyCompleteException | JobParametersInvalidException ex) {
            log.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">HelloQuartzJob failed.</span><span class="delimiter">&quot;</span></span>, ex);
            <span class="keyword">throw</span> <span class="keyword">new</span> JobExecutionException(<span class="string"><span class="delimiter">&quot;</span><span class="content">HelloQuartzJob failed</span><span class="delimiter">&quot;</span></span>, ex);
        }
    }
}</code></pre></section>
<section id="_quartz_konfiguration_spring_boot"><h2>Quartz-Konfiguration (Spring-Boot)</h2><pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Configuration</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">QuartzConfig</span> {
    <span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">${ops.quartz.cron:0 0/5 * * * ?}</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> cronExpression;

    <span class="annotation">@Bean</span>
    JobDetail helloQuartzJobDetail() {
        <span class="keyword">return</span> JobBuilder.newJob(HelloQuartzJob.class)
                .storeDurably()
                .build();
    }

    <span class="annotation">@Bean</span>
    CronTriggerFactoryBean cronTrigger() {
        CronTriggerFactoryBean cronTrigger = <span class="keyword">new</span> CronTriggerFactoryBean();
        cronTrigger.setCronExpression(cronExpression);
        cronTrigger.setJobDetail(helloQuartzJobDetail());
        <span class="keyword">return</span> cronTrigger;
    }
}</code></pre>
<div class="title">application.properties:</div><pre class="CodeRay listingblock"><code>spring.quartz.job-store-type=jdbc
spring.quartz.jdbc.initialize-schema=always

ops.quartz.cron = 0 0/5 * * * ?</code></pre></section>
<section id="_spring_integration_und_spring_batch"><h2>Spring-Integration und Spring-Batch</h2><div class="ulist"><ul><li><p>Der <strong><code>JobLaunchingMessageHandler</code></strong> startet einen Batch-Job nach Empfang einer Message.</p></li><li><p>Inhalt (<em>Payload</em>) der Message ist ein <strong><code>JobLaunchRequest</code></strong>.</p></li><li><p>Ein <code>JobLaunchRequest</code> enthält den Job und die Parameter.</p></li><li><p>Spring-Integration ermöglicht die Modellierung einer Software als Datenfluss
entsprechend der <em>Enterprise Integration Patterns</em>, auch ohne Messaging-Middleware.</p></li><li><p>Es ist auch möglich Webservices, E-Mail, FTP etc. zu integrieren.</p></li><li><p>Beispielsweise erzeugt ein <em>FileInboundChannelAdapter</em> eine Nachricht, sobald eine
Datei einem bestimmten Verzeichnis angelegt wird und kann damit direkt einen
Batch-Job zum Verarbeiten dieser Datei anstoßen.</p></li></ul></div></section>
<section id="_start_eines_batch_jobs_bei_anlegen_einer_datei"><h2>Start eines Batch-Jobs bei Anlegen einer Datei</h2><div class="imageblock" style=""><img src="images/ops/launch-batch-job.png" alt="launch batch job" width="100%"></div></section>
<section id="_implementierung_des_transformers"><h2>Implementierung des Transformers</h2><div class="title">FileMessageToJobRequest.java</div><pre class="CodeRay listingblock"><code class="java language-java"><span class="directive">public</span> <span class="type">class</span> <span class="class">FileMessageToJobRequest</span> {
    <span class="directive">private</span> Job job;
    <span class="directive">private</span> <span class="predefined-type">String</span> fileParameterName;

    <span class="directive">public</span> <span class="type">void</span> setFileParameterName(<span class="predefined-type">String</span> fileParameterName) {
        <span class="local-variable">this</span>.fileParameterName = fileParameterName;
    }

    <span class="directive">public</span> <span class="type">void</span> setJob(Job job) {
        <span class="local-variable">this</span>.job = job;
    }

    <span class="annotation">@Transformer</span> <span class="comment">// diese Annotation macht die Klasse zu einem Transformer</span>
    <span class="directive">public</span> JobLaunchRequest toRequest(Message&lt;<span class="predefined-type">File</span>&gt; message) {
        JobParametersBuilder jobParametersBuilder = <span class="keyword">new</span> JobParametersBuilder();

        jobParametersBuilder.addString(fileParameterName,
                message.getPayload().getAbsolutePath()); <span class="comment">// Inhalt der Message ist ein File Objekt</span>

        <span class="keyword">return</span> <span class="keyword">new</span> JobLaunchRequest(job, jobParametersBuilder.toJobParameters());
    }
}</code></pre></section>
<section id="_konfiguration_des_transformers"><h2>Konfiguration des Transformers</h2><pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Bean</span>
<span class="directive">public</span> FileMessageToJobRequest fileMessageToJobRequest(Job filePollerJob) {
    FileMessageToJobRequest fileMessageToJobRequest = <span class="keyword">new</span> FileMessageToJobRequest();
    fileMessageToJobRequest.setFileParameterName(<span class="string"><span class="delimiter">&quot;</span><span class="content">input.file.name</span><span class="delimiter">&quot;</span></span>);
    fileMessageToJobRequest.setJob(filePollerJob);
    <span class="keyword">return</span> fileMessageToJobRequest;
}</code></pre>
<div class="paragraph"><p><br></p></div>
<div class="paragraph"><p>Der Reader kann damit folgendermaßen auf den Parameter zugreifen:</p></div>
<pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Bean</span>
<span class="annotation">@StepScope</span>
ResourcesItemReader filePollerReader(<span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters['input.file.name']}</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> resource) {
        ResourcesItemReader reader = <span class="keyword">new</span> ResourcesItemReader();
    reader.setResources(<span class="keyword">new</span> Resource<span class="type">[]</span> { <span class="keyword">new</span> FileSystemResource(resource) });
    <span class="keyword">return</span> reader;
}</code></pre></section>
<section id="_konfiguration_des_gateways"><h2>Konfiguration des Gateways</h2><pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Bean</span>
<span class="directive">public</span> JobLaunchingGateway jobLaunchingGateway() {
    SimpleJobLauncher simpleJobLauncher = <span class="keyword">new</span> SimpleJobLauncher();
    simpleJobLauncher.setJobRepository(jobRepository);
    simpleJobLauncher.setTaskExecutor(<span class="keyword">new</span> SyncTaskExecutor());
    JobLaunchingGateway jobLaunchingGateway = <span class="keyword">new</span> JobLaunchingGateway(simpleJobLauncher);

    <span class="keyword">return</span> jobLaunchingGateway;
}</code></pre>
<div class="ulist"><ul><li><p>Mit dem <code>SyncTaskExecutor</code> wird die Antwort erst verschickt, wenn der Job fertig ist</p></li><li><p>Mit einem <code>AsyncTaskExecutor</code> wird die Antwort sofort verschickt.<br>
&#8658; Anhand der Job-ID in der Antwort kann man das <em>JobRepository</em> pollen, um den Fortschritt zu ermitteln</p></li><li><p>Alternativ kann der Job auch aktiv Nachrichten zu seinem Fortschritt verschicken</p></li></ul></div>
<div class="admonitionblock warning teacherBox"><table><tr><td class="icon"><i class="fa fa-warning" title="Warning"></i></td><td class="content">Die Datei muss gelöscht werden, <strong>bevor</strong> die Antwort eintrifft, andernfalls wird sofort eine
neue Message zur selben Datei verschickt.</td></tr></table></div></section>
<section id="_konfiguration_des_flows"><h2>Konfiguration des Flows</h2><pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Bean</span>
<span class="directive">public</span> IntegrationFlow integrationFlow(FileMessageToJobRequest fileMessageToJobRequest) {
    FileInboundChannelAdapterSpec source = Files
            .inboundAdapter(<span class="keyword">new</span> <span class="predefined-type">File</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">target/myfiles</span><span class="delimiter">&quot;</span></span>))
            .filter(<span class="keyword">new</span> SimplePatternFileListFilter(<span class="string"><span class="delimiter">&quot;</span><span class="content">*.txt</span><span class="delimiter">&quot;</span></span>));
    <span class="keyword">return</span> IntegrationFlows.from(source, <span class="local-variable">this</span>::configureEndpoint)
            .handle(fileMessageToJobRequest)
            .handle(jobLaunchingGateway())
            .log(LoggingHandler.Level.WARN, <span class="string"><span class="delimiter">&quot;</span><span class="content">headers.id + ': ' + payload</span><span class="delimiter">&quot;</span></span>) <span class="comment">// response loggen</span>
            .get();
}

<span class="directive">private</span> <span class="type">void</span> configureEndpoint(SourcePollingChannelAdapterSpec channelAdapter) {
    PollerSpec poller = Pollers.fixedRate(<span class="integer">1000</span>).maxMessagesPerPoll(<span class="integer">1</span>);
    channelAdapter.poller(poller);
}</code></pre></section>
<section id="_aufgabe_1_scheduling_und_intergration"><h2>Aufgabe 1: Scheduling und Intergration</h2><div class="olist arabic"><ol class="arabic"><li><p>Sehen Sie sich den Sourcecode der besprochenen Beispiele im Projekt <code>exercises-ops</code> an.</p></li><li><p>Ändern Sie die Zeiten für das Scheduling und führen Sie die Beispielanwendung aus.</p></li><li><p>Führen Sie den <code>FilePollerJob</code> aus, indem Sie eine entsprechende Datei anlegen.</p></li><li><p>Können Sie die ausgeführten Jobs und Steps im Repository finden?</p></li><li><p>Was passiert, wenn Sie in <code>FilePollerJobConfig</code> den <code>SyncTaskExecutor</code> durch einen
<code>SimpleAsyncTaskExecutor</code> austauschen?</p></li><li><p>Setzen Sie Breakpoints im Tasklet bzw. im Processor und versuchen Sie die besprochenen
Klassen in den Laufzeit-Datenstrukturen zu finden.</p></li></ol></div></section>
<section id="_rest"><h2>REST</h2><div class="paragraph"><p>REST in wenigen Worten:</p></div>
<div class="ulist"><ul><li><p>Bei Rest geht es um Ressourcen (Dinge), die eindeutig über URI identifiziert werden</p></li><li><p>Aktionen beschränken sich auf CRUD-Operationen (HTTP-Verben)</p></li><li><p>Operationen (Funktionsaufrufe) sind über POST-Request möglich, sollten aber vermieden werden</p></li></ul></div>
<div class="paragraph"><p>Beispiel:</p></div>
<div class="ulist"><ul><li><p>Statt der Operation Überweise Betrag X von A nach B</p></li><li><p>wird eine neue Überweisung angelegt, die über eine eigene URI identifiziert werden kann</p></li></ul></div>
<div class="paragraph"><p>Mehr dazu <a href="https://www.restapitutorial.com/lessons/whatisrest.html#">&#8594; https://www.restapitutorial.com</a></p></div></section>
<section id="_restful_job_processing"><h2>RESTful job processing</h2><div class="paragraph"><p>Hier muss man unterscheiden:</p></div>
<div class="olist arabic"><ol class="arabic"><li><p>Der Job steht im Mittelpunkt</p></li><li><p>Das Ergebnis der Jobausführung (z. B. ein Report) steht im Mittelpunkt</p></li></ol></div></section>
<section id="_jobs_per_rest_api_steuern"><h2>Jobs per REST-API steuern</h2><div class="literalblock"><div class="content"><pre>POST https://api.site.com/batchjobs/helloJob name='Egon'
HTTP/1.1 201 Created
Location /batchjobs/helloJob/123</pre></div></div>
<div class="paragraph"><p>Erzeugt eine neue Job-Execution mit der ID 123</p></div>
<div class="paragraph"><p>Wichtig ist ein <strong><code>SimpleJobLauncher</code></strong> mit einem <strong><code>AsyncTaskExecutor</code></strong></p></div>
<div class="literalblock"><div class="content"><pre>GET https://api.site.com/batchjobs/helloJob/123</pre></div></div>
<div class="paragraph"><p>Liefert Meta-Information (Startzeitpunkt, Parameter, Status, &#8230;&#8203;) der JobExecution</p></div>
<div class="literalblock"><div class="content"><pre>GET https://api.site.com/batchjobs/helloJob</pre></div></div>
<div class="paragraph"><p>Liefert Liste aller JobExecutions</p></div>
<div class="literalblock"><div class="content"><pre>PUT https://api.site.com/batchjobs/helloJob status=stopped</pre></div></div></section>
<section id="_ergebnis_eines_batch_jobs_per_rest_api"><h2>Ergebnis eines Batch-Jobs per REST-API</h2><div class="literalblock"><div class="content"><pre>POST https://api.site.com/reports/2020-03
HTTP/1.1 202 Accepted
Location /queue/124</pre></div></div>
<div class="paragraph"><p>Startet den <em>createReport</em> Batch-Job mit Execution-ID 124</p></div>
<div class="literalblock"><div class="content"><pre>GET https://api.site.com/batchjobs/createReport/124</pre></div></div>
<div class="paragraph"><p>Liefert Meta-Information zur Job-Ausführung</p></div>
<div class="literalblock"><div class="content"><pre>GET https://api.site.com/queue/124
HTTP/1.1 200 Ok</pre></div></div>
<div class="literalblock"><div class="content"><pre>{ "status": "STARTED" }</pre></div></div>
<div class="paragraph"><p>Liefert Status-Info, solange der Job noch läuft</p></div>
<div class="literalblock"><div class="content"><pre>GET https://api.site.com/queue/124
HTTP/1.1 303 See Other
Location: /reports/2020-03</pre></div></div>
<div class="paragraph"><p>oder ein Redirect, falls der Job fertig ist.</p></div>
<div class="paragraph"><p>Siehe auch <a href="https://farazdagi.com/2014/rest-and-long-running-jobs/" class="bare">https://farazdagi.com/2014/rest-and-long-running-jobs/</a></p></div>
<aside class="notes"><div class="ulist"><ul><li><p>Wenn <code>POST <a href="https://api.site.com/reports/2020-03" class="bare">https://api.site.com/reports/2020-03</a></code> erneut aufgerufen wird gibt man 409 (Conflict)
zurück.</p></li><li><p>Ein <code>GET <a href="https://api.site.com/reports/2020-03" class="bare">https://api.site.com/reports/2020-03</a></code> liefert 404 (Not Found) solange der Report noch nicht
erstellt wurde.</p></li></ul></div></aside></section>
<section id="_batchanwendungen_in_der_cloud"><h2>Batchanwendungen in der Cloud</h2><div class="ulist"><ul><li><p>Die Cloud bietet fast unbegrenzt Rechenleistung</p></li><li><p>Diese Rechenleistung verursacht nur solange Kosten, solange sie tatsächlich genutzt wird</p></li><li><p>Batch-Jobs benötigen sehr viele Rechenleistung, aber nur solange sie tatsächlich laufen</p></li><li><p>&#8658; Passt irgendwie gut zusammen&#8230;&#8203;</p></li></ul></div></section>
<section id="_spring_cloud_task"><h2>Spring Cloud Task</h2><div class="ulist"><ul><li><p>Erstellung kurzlebiger Microservices</p></li><li><p>Verwendet eigenes Task-Repository um die Ergebnisse der Task-Ausführung zu speichern</p></li><li><p>Dependency in <em>Spring Initializr</em>:</p><div class="imageblock" style="text-align: left"><img src="images/ops/cloud-task-dependency.png" alt="cloud task dependency" width="100%"></div></li><li><p>Dependency in Maven:</p><pre class="CodeRay listingblock"><code class="xml language-xml"><span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.springframework.boot<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.springframework.cloud<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>spring-cloud-starter-task<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre></li></ul></div></section>
<section id="_spring_cloud_taskbeispiel"><h2>Spring Cloud Task&#8201;&#8212;&#8201;Beispiel</h2><pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@SpringBootApplication</span>
<span class="annotation">@EnableTask</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> <span class="type">class</span> <span class="class">CloudTaskHelloWorldApplication</span> {

    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
        SpringApplication.run(CloudTaskHelloWorldApplication.class, args);
    }

    <span class="annotation">@Bean</span>
    <span class="directive">public</span> CommandLineRunner commandLineRunner() {
        <span class="keyword">return</span> (args) -&gt; <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hello, World!</span><span class="delimiter">&quot;</span></span>);
    }
}</code></pre>
<div class="colist arabic"><table><tr><td><i class="conum" data-value="1"></i><b>1</b></td><td>Die <strong><code>@EnableTask</code></strong> Annotation zeichnet die Applikation als <em>Spring Could Task</em> aus</td></tr></table></div>
<div class="paragraph"><p><br></p></div>
<div class="title">application.properties:</div><pre class="CodeRay listingblock"><code># Der application.name erscheint in der Datenbank-Spalte TASK_NAME
spring.application.name=helloWorld
logging.level.org.springframework.cloud.task=DEBUG

# Database connection
spring.datasource.url=jdbc:hsqldb:hsql://localhost:9001/xdb;sql.enforce_strict_size=true;hsqldb.tx=mvcc
spring.datasource.username=SA
spring.datasource.password=</code></pre></section>
<section id="_spring_cloud_taskrespository"><h2>Spring Cloud Task&#8201;&#8212;&#8201;Respository</h2><div class="imageblock" style=""><img src="images/ops/cloud-task-repository.png" alt="cloud task repository" width="60%"></div></section>
<section id="_spring_cloud_taskähnlichkeiten_zu_spring_batch"><h2>Spring Cloud Task&#8201;&#8212;&#8201;Ähnlichkeiten zu Spring-Batch</h2><div class="ulist"><ul><li><p>Name, Argumente, Zeitpunkte, Exit-Code und Fehler-/Exit-Message werden im Repository protokolliert</p></li><li><p>Es gibt einen <strong><code>ExitCodeExceptionMapper</code></strong>, der Exceptions auf Exit-Codes mapped</p></li><li><p>Es gibt einen <strong><code>TaskExecutionListener</code></strong> und korrespondierende <code>@BeforeTask</code>, <code>@AfterTask</code> und <code>@FailedTask</code>
Annotationen (keine Registierung erforderlich, Listener muss nur Bean sein)</p></li><li><p>Man kann verhindern, dass zwei Tasks mit dem gleichen Namen gleichzeitig ausgeführt werden</p></li></ul></div>
<div class="paragraph"><p>Siehe auch <a href="https://docs.spring.io/spring-cloud-task/docs/current/reference/#features">&#8594; Spring Cloud Task Reference Guide</a></p></div></section>
<section id="_spring_cloud_task_spring_batch"><h2>Spring Cloud Task + Spring-Batch</h2><div class="ulist"><ul><li><p>Spring Cloud Task bietet den <strong><code>TaskBatchExecutionListener</code></strong>, der jeden Batch-Job als Cloud-Task behandelt</p></li><li><p>Lediglich <strong><code>@EnableTask</code></strong> und <strong><code>@EnableBatchProcessing</code></strong> notwendig.</p></li><li><p>Spring Boot basierte Batch-Applikation wird damit automatisch zum Spring Cloud-Task</p></li><li><p>Die Tabelle <strong><code>TASK_TASK_BATCH</code></strong> stellt die Verbindung zwischen den beiden Welten her</p></li></ul></div>
<div class="admonitionblock note teacherBox"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">Wenn man keinen <code>JobParametersIncrementer</code> angegeben hat, muss man für jeden erneuten Aufruf einen
anderen Parameter angeben. Spring-Boot-Applikationen verwenden den <code>JobLauncherCommandLineRunner</code>.
Dieser wertet Parameter genauso aus, wie der <code>CommandLineJobRunner</code> (also z. B. <code>my.id(long)=1</code>).</td></tr></table></div></section>
<section id="_paritionierung_in_der_cloud"><h2>Paritionierung in der Cloud</h2><div class="ulist"><ul><li><p>Partitionierung mit dem <strong><code>DeployerPartitionHandler</code></strong> ist ähnlich dem Remote-Partitioning:</p><div class="ulist"><ul><li><p>Es gibt einen Manager, der die Arbeit aufteilt und die Ergebnisse einsammelt und zusammenfasst.</p></li><li><p>Es gibt viele Worker, die die eigentliche Arbeit machen.</p></li></ul></div></li><li><p>Unterschiede:</p><div class="ulist"><ul><li><p>Der Manager startet die Worker selbst.</p></li><li><p>Die Parameter werden nicht per Message an die Worker übergeben sondern direkt als Aufruf-Parameter beim Start
oder werden vom Worker aus dem Repository ausgelesen.</p></li><li><p>Der Manager empfängt keine Antwort-Message, sondern pollt das Repository bis alle Worker fertig sind und holt
sich dann Teilergebnisse aus dem Repository.</p></li></ul></div></li><li><p>Zum Starten der Worker benötigt der <code>DeployerPartitionHandler</code> einen <strong><code>TaskLauncher</code></strong>. Momentan
gibt es Implementierungen für <em>CloudFoundry</em>, <em>Kubernetes</em> und eine lokale Version.</p></li></ul></div></section>
<section id="_maven_abhängigkeiten_für_den_deployerpartitionhandler"><h2>Maven-Abhängigkeiten für den DeployerPartitionHandler</h2><div class="paragraph"><p>Notwendige Abhängigkeiten für lokales Deployment:</p></div>
<pre class="CodeRay listingblock"><code class="xml language-xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.springframework.cloud<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>spring-cloud-starter-task<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.springframework.cloud<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>spring-cloud-deployer-local<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>2.7.2<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.springframework.batch<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>spring-batch-integration<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre></section>
<section id="_deployerpartitionhandler_verwenden"><h2>DeployerPartitionHandler verwenden</h2><pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Bean</span>
<span class="directive">public</span> PartitionHandler partitionHandler() {
    Resource resource = <span class="local-variable">this</span>.resourceLoader
            .getResource(<span class="string"><span class="delimiter">&quot;</span><span class="content">maven://de.springbatchdeepdive:exercises-cloud-gauss-solution:1.0.0-SNAPSHOT</span><span class="delimiter">&quot;</span></span>);

    DeployerPartitionHandler partitionHandler = <span class="keyword">new</span> DeployerPartitionHandler(taskLauncher, jobExplorer, resource,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">workerStep</span><span class="delimiter">&quot;</span></span>, taskRepository);

    <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; commandLineArgs = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;(<span class="integer">3</span>);
    commandLineArgs.add(<span class="string"><span class="delimiter">&quot;</span><span class="content">--spring.profiles.active=worker</span><span class="delimiter">&quot;</span></span>);
    commandLineArgs.add(<span class="string"><span class="delimiter">&quot;</span><span class="content">--spring.cloud.task.initialize-enabled=false</span><span class="delimiter">&quot;</span></span>);
    commandLineArgs.add(<span class="string"><span class="delimiter">&quot;</span><span class="content">--spring.batch.initializer.enabled=false</span><span class="delimiter">&quot;</span></span>);
    partitionHandler
            .setCommandLineArgsProvider(<span class="keyword">new</span> PassThroughCommandLineArgsProvider(commandLineArgs));
    partitionHandler
            .setEnvironmentVariablesProvider(<span class="keyword">new</span> SimpleEnvironmentVariablesProvider(<span class="local-variable">this</span>.environment));
    partitionHandler.setMaxWorkers(<span class="integer">2</span>);
    partitionHandler.setApplicationName(<span class="string"><span class="delimiter">&quot;</span><span class="content">PartitionedGaussJobTask</span><span class="delimiter">&quot;</span></span>);

    <span class="keyword">return</span> partitionHandler;
}

<span class="annotation">@Bean</span>
<span class="annotation">@Profile</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">worker</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> DeployerStepExecutionHandler stepExecutionHandler(JobExplorer jobExplorer) {
    <span class="keyword">return</span> <span class="keyword">new</span> DeployerStepExecutionHandler(<span class="local-variable">this</span>.context, jobExplorer, <span class="local-variable">this</span>.jobRepository);
}</code></pre></section>
<section id="_spring_cloud_data_flow"><h2>Spring Cloud Data Flow</h2><div class="olist arabic"><ol class="arabic"><li><p><a href="https://dataflow.spring.io/docs/installation/local/docker/">&#8594; Installation mit Docker Compose</a><br>
<a href="https://raw.githubusercontent.com/spring-cloud/spring-cloud-dataflow/master/spring-cloud-dataflow-server/docker-compose.yml">&#8594; docker-compose.yml herunterladen</a></p><pre class="CodeRay listingblock"><code>set DATAFLOW_VERSION=2.6.3
set SKIPPER_VERSION=2.5.2

rem up oder down
docker-compose %1</code></pre></li><li><p><a href="https://dataflow.spring.io/docs/installation/local/docker-customize/">&#8594; Lokales Maven Repository mounten</a>
(bei <code>dataflow-server</code> und bei <code>skipper-server</code>)</p><pre class="CodeRay listingblock"><code>  volumes:
    - ~/.m2:/root/.m2</code></pre></li><li><p>Dashboard aufrufen: <a href="http://localhost:9393/dashboard" class="bare">http://localhost:9393/dashboard</a></p></li><li><p>Applikation registieren mit:</p><pre class="CodeRay listingblock"><code>`maven://de.springbatchdeepdive:exercises-cloud-task-solution:1.0.0-SNAPSHOT`</code></pre></li><li><p>Task erstellen und ausführen</p></li></ol></div></section>
<section id="_monitoring_mit_micrometer"><h2>Monitoring mit Micrometer</h2><div class="ulist"><ul><li><p><a href="https://micrometer.io/">&#8594; Micrometer</a> ist das Monitoring-Gegenstück zu <a href="http://www.slf4j.org/">&#8594; SLF4J</a>.</p></li><li><p>Micrometer unterstützt alle gängigen Monitoring-Backends (u.a. Azure Monitor, Netflix Atlas,
Prometheus + Grafana, Elastic).</p></li><li><p>Spring setzt durchgängig auf Micrometer und bietet bereits standardmäßig ein umfangereiches
Set eingebauter Metriken.</p></li><li><p>Eigene Metriken lassen sich sehr einfach über Annotationen oder die Micrometer-API hinzufügen.</p></li><li><p>Zur Einbindung eines bestimmten Backends sind nur die zugehörige Maven-Dependency und die
entsprechende Konfiguration notwendig.</p></li></ul></div></section>
<section id="_micrometer_architektur"><h2>Micrometer Architektur</h2><div class="dlist"><dl><dt class="hdlist1">Micrometer Core (<code>micrometer-core-1.3.5.jar</code>) </dt><dd><p>Enthält nur die API, hat keine Abhängigkeiten zu anderen Bibliotheken</p></dd><dt class="hdlist1">Meter Registry: </dt><dd><p>Erweitert die abstrakte Klasse <strong><code>MeterRegistry</strong></code> und stellt damit die Anbindung an ein Backend
zum Speichern von Metriken her.<br>
Beispiele: <code>micrometer-registry-prometheus</code>, <code>micrometer-registry-atlas</code></p></dd><dt class="hdlist1">Adapter zum Abgreifen von Metriken: </dt><dd><p>Beispielsweise <strong>Spring Boot Actuator</strong> sammelt Metriken aus diversen Quellen ein und stellt sie über Micrometer bereit.</p></dd></dl></div></section>
<section id="_die_wichtigsen_metrik_typen"><h2>Die wichtigsen Metrik-Typen</h2><div class="imageblock" style=""><img src="images/Meter.svg" alt="Meter" width="1682" height="552"></div></section>
<section id="_beispiel_für_eigenen_messwert"><h2>Beispiel für eigenen Messwert</h2><pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SampleCounter</span> <span class="directive">implements</span> InitializingBean {

    <span class="annotation">@Autowired</span>
    <span class="directive">private</span> MeterRegistry registry;

    <span class="directive">private</span> Counter counter;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> afterPropertiesSet() <span class="directive">throws</span> <span class="exception">Exception</span> {
        counter = Counter.builder(<span class="string"><span class="delimiter">&quot;</span><span class="content">sample.tick.counter</span><span class="delimiter">&quot;</span></span>)
                .description(<span class="string"><span class="delimiter">&quot;</span><span class="content">Zählt die Aufrufe der tick-Methode</span><span class="delimiter">&quot;</span></span>)
                .tags(<span class="string"><span class="delimiter">&quot;</span><span class="content">app</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">statistics</span><span class="delimiter">&quot;</span></span>)
                .register(registry);
    }

    <span class="directive">public</span> <span class="type">void</span> count() {
        counter.increment();
    }
}</code></pre>
<div class="title">Verwendung:</div><pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Autowired</span>
<span class="directive">private</span> SampleCounter sampleCounter;

<span class="annotation">@Scheduled</span>(fixedRate = <span class="integer">1000L</span>)
<span class="type">void</span> tick() <span class="directive">throws</span> <span class="exception">InterruptedException</span> {
    sampleCounter.count();
    sampleService.sinusDelay();
}</code></pre></section>
<section id="_messwerte_in_spring_anwendungen"><h2>Messwerte in Spring-Anwendungen</h2><div class="paragraph"><p>Micrometer-Annotationen für Methoden:</p></div>
<div class="ulist"><ul><li><p><strong><code>@Counted</code></strong> erfordert <code>CountedAspect</code> Bean</p></li><li><p><strong><code>@Timed</code></strong> erfordert <code>TimedAspect</code> Bean</p></li></ul></div>
<div class="title">Notwendige Konfiguration für <code>@Timed</code> Annotation:</div><pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Bean</span>
TimedAspect timedAspect(MeterRegistry registry) {
    <span class="keyword">return</span> <span class="keyword">new</span> TimedAspect();
}</code></pre>
<div class="title">Beispiel:</div><pre class="CodeRay listingblock"><code class="java language-java"><span class="annotation">@Timed</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">sample.sinus.timer</span><span class="delimiter">&quot;</span></span>,
        description = <span class="string"><span class="delimiter">&quot;</span><span class="content">Timer, der eine Sinuskurve produziert</span><span class="delimiter">&quot;</span></span>,
        extraTags = {<span class="string"><span class="delimiter">&quot;</span><span class="content">app</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">statistics</span><span class="delimiter">&quot;</span></span>})
<span class="directive">public</span> <span class="type">void</span> sinusDelay() <span class="directive">throws</span> <span class="exception">InterruptedException</span> {
    <span class="type">double</span> x = <span class="predefined-type">System</span>.nanoTime() * <span class="predefined-type">Math</span>.PI / <span class="float">60e9</span>;
    <span class="type">long</span> y = <span class="integer">250L</span> - (<span class="type">long</span>) (<span class="integer">100</span> * <span class="predefined-type">Math</span>.sin(x));
    log.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">delaying {} ms</span><span class="delimiter">&quot;</span></span>, y);
    <span class="predefined-type">TimeUnit</span>.MILLISECONDS.sleep(y);
}</code></pre>
<div class="admonitionblock warning teacherBox"><table><tr><td class="icon"><i class="fa fa-warning" title="Warning"></i></td><td class="content">Die Annotationen <code>@Counted</code> und <code>@Timed</code> wirken nur auf nicht private Methoden von Beans.</td></tr></table></div></section>
<section id="_eingebaute_spring_batch_metriken"><h2>Eingebaute Spring-Batch Metriken</h2><table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:33.3333%"><col style="width:33.3333%"><col style="width:33.3334%"></colgroup><thead><tr><th class="tableblock halign-left valign-top">Metrik-Name</th><th class="tableblock halign-left valign-top">Typ</th><th class="tableblock halign-left valign-top">Beschreibung</th></tr><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">spring.batch.job</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">TIMER</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Dauer der Job-Ausführung</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">spring.batch.job.active</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">LONG_TASK_TIMER</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Gerade aktive Jobs</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">spring.batch.step</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">TIMER</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Dauer der Step-Ausführung</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">spring.batch.item.read</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">TIMER</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Dauer des Lesens</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">spring.batch.item.process</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">TIMER</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Dauer der Verarbeitung</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">spring.batch.chunk.write</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">TIMER</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Dauer des Schreibens von Chunks</p></td></tr></table></section>
<section id="_prometheus"><h2>Prometheus</h2><div class="paragraph"><p>Open-Source Zeitreihendatenbank von Google</p></div>
<div class="paragraph"><p><strong>Installation:</strong></p></div>
<div class="paragraph"><p>ZIP-Datei von <a href="https://prometheus.io/download/" class="bare">https://prometheus.io/download/</a> herunterladen und entpacken.</p></div>
<div class="paragraph"><p><strong>Ausführung:</strong></p></div>
<div class="literalblock"><div class="content"><pre>cd &lt;Installationsverzeichnis&gt;
prometheus.exe --config.file=&lt;Pfad&gt;\prometheus.yml</pre></div></div>
<div class="paragraph"><p>Aufruf: <a href="http://localhost:9090" class="bare">http://localhost:9090</a></p></div></section>
<section id="_grafana"><h2>Grafana</h2><div class="paragraph"><p>Webbasierte Visualisierungsplattfrom für Monitoring-Daten, Open-Source</p></div>
<div class="paragraph"><p><strong>Installation (Standalone Windows Binaries):</strong></p></div>
<div class="olist arabic"><ol class="arabic"><li><p>ZIP-Datei von <a href="https://grafana.com/grafana/download" class="bare">https://grafana.com/grafana/download</a> herunterladen</p></li><li><p>Eigenschaften der ZIP-Datei ändern:
<span class="image"><img src="images/ops/Grafana-Zip.png" alt="Grafana Zip"></span></p></li><li><p>ZIP-Datei entpacken</p></li></ol></div>
<div class="paragraph"><p><strong>Ausführung:</strong></p></div>
<div class="literalblock"><div class="content"><pre>cd &lt;Installationsverzeichnis&gt;\bin
grafana-server.exe</pre></div></div>
<div class="paragraph"><p>siehe auch <a href="https://grafana.com/docs/grafana/next/setup-grafana/installation/windows/">Windows installation guide</a></p></div>
<div class="paragraph"><p>Aufruf: <a href="http://localhost:3000" class="bare">http://localhost:3000</a>
Login: admin/admin</p></div></section>
<section id="_spring_boot_actuator"><h2>Spring Boot Actuator</h2><div class="paragraph"><p>Stellt Monitoring-Daten aus Spring-Boot Anwendungen per JMX oder REST zur Verfügung</p></div>
<div class="title">pom.xml</div><pre class="CodeRay listingblock"><code class="xml language-xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.springframework.boot<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
<div class="title">application.properties</div><pre class="CodeRay listingblock"><code class="xml language-xml"># Expose all actuator endpoints (niemals in der Produktion!)
management.endpoints.web.exposure.include=*</code></pre>
<div class="paragraph"><p>Aufruf: <a href="http://localhost:8080/actuator" class="bare">http://localhost:8080/actuator</a></p></div></section>
<section id="_konfiguration_von_micrometer_für_prometheus"><h2>Konfiguration von Micrometer für Prometheus</h2><div class="title">pom.xml</div><pre class="CodeRay listingblock"><code class="xml language-xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>io.micrometer<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>micrometer-registry-prometheus<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;scope&gt;</span>runtime<span class="tag">&lt;/scope&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
<div class="title">application.properties</div><pre class="CodeRay listingblock"><code class="xml language-xml">management.endpoint.metrics.enabled=true
management.endpoint.prometheus.enabled=true
management.metrics.export.prometheus.enabled=true</code></pre>
<div class="paragraph"><p>Aufruf: <a href="http://localhost:8080/actuator/prometheus" class="bare">http://localhost:8080/actuator/prometheus</a></p></div></section>
<section id="_abfrage_mit_prometheus"><h2>Abfrage mit Prometheus</h2><div class="imageblock" style=""><img src="images/ops/Prometheus_Abfrage.png" alt="Prometheus Abfrage"></div></section>
<section id="_prometheus_aus_datenquelle_in_grafana_einbinden"><h2>Prometheus aus Datenquelle in Grafana einbinden</h2><div class="imageblock" style=""><img src="images/ops/Grafana_Datasource.png" alt="Grafana Datasource"></div></section>
<section id="_prometheus_aus_datenquelle_in_grafana_einbinden_2"><h2>Prometheus aus Datenquelle in Grafana einbinden</h2><div class="imageblock" style=""><img src="images/ops/Grafana-AdhocAbfrage.png" alt="Grafana AdhocAbfrage"></div></section>
<section id="_grafana_dashboard"><h2>Grafana Dashboard</h2><div class="imageblock" style=""><img src="images/ops/Grafana_Dashboard.png" alt="Grafana Dashboard"></div></section>
<section id="_zusammenfassung_lektion_8"><h2>Zusammenfassung Lektion 8</h2><div class="ulist"><ul><li><p>Batchjobs mit Quartz oder TaskScheduler anstoßen</p></li><li><p>Batch mit Spring-Integration einbinden und über eine Message anstoßen</p></li><li><p>Batchverarbeitung in der Cloud, insbes. <code>DeployerPartitionHandler</code></p></li><li><p>Monitoring mit Micrometer</p></li></ul></div></section>
<section id="_aufgaben"><h2>Aufgaben</h2><div class="olist arabic"><ol class="arabic"><li><p>Machen Sie sich mit der Beispielanwendung vertraut. Welche Actuator-Endpoints gibt es?</p></li><li><p>Ändern Sie die Ausführungshäufigkeit der beiden Hello-Jobs.</p></li><li><p>Bringen Sie den <em>FilePollerJob</em> zur Ausführung, indem Sie eine entsprechende Datei anlegen.</p></li><li><p>Sehen Sie sich die Stacktraces bei der Ausführung der obigen Jobs und den Inhalt des
Repositories an.</p></li><li><p>Erstellen Sie mit <em>Spring Initializr</em> einen Cloud-Task, der den Hello-World Job ausführt</p></li><li><p>Verwenden Sie Prometheus + Grafana zum Anzeigen der Metriken zum Step-Counter und Sinus-Timer</p></li></ol></div>
<div class="paragraph"><p><br>
&#8594; <a href="index.html">Agenda</a></p></div></section></div></div><script src="reveal.js-3.9.2/lib/js/head.min.js"></script><script src="reveal.js-3.9.2/js/reveal.js"></script><script>// See https://github.com/hakimel/reveal.js#configuration for a full list of configuration options
Reveal.initialize({
  // Display controls in the bottom right corner
  controls: true,
  // Display a presentation progress bar
  progress: true,
  // Display the page number of the current slide
  slideNumber: true,
  // Push each slide change to the browser history
  history: true,
  // Enable keyboard shortcuts for navigation
  keyboard: true,
  // Enable the slide overview mode
  overview: true,
  // Vertical centering of slides
  center: true,
  // Enables touch navigation on devices with touch input
  touch: true,
  // Loop the presentation
  loop: false,
  // Change the presentation direction to be RTL
  rtl: false,
  // Turns fragments on and off globally
  fragments: true,
  // Flags if the presentation is running in an embedded mode,
  // i.e. contained within a limited portion of the screen
  embedded: false,
  // Number of milliseconds between automatically proceeding to the
  // next slide, disabled when set to 0, this value can be overwritten
  // by using a data-autoslide attribute on your slides
  autoSlide: 0,
  // Stop auto-sliding after user input
  autoSlideStoppable: true,
  // Enable slide navigation via mouse wheel
  mouseWheel: true,
  // Hides the address bar on mobile devices
  hideAddressBar: true,
  // Opens links in an iframe preview overlay
  previewLinks: false,
  // Theme (e.g., beige, black, league, night, serif, simple, sky, solarized, white)
  // NOTE setting the theme in the config no longer works in reveal.js 3.x
  //theme: Reveal.getQueryHash().theme || 'anderscore',
  // Transition style (e.g., none, fade, slide, convex, concave, zoom)
  transition: Reveal.getQueryHash().transition || 'linear',
  // Transition speed (e.g., default, fast, slow)
  transitionSpeed: 'default',
  // Transition style for full page slide backgrounds (e.g., none, fade, slide, convex, concave, zoom)
  backgroundTransition: 'fade',
  // Number of slides away from the current that are visible
  viewDistance: 3,
  // Parallax background image (e.g., "'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg'")
  parallaxBackgroundImage: '',
  // Parallax background size in CSS syntax (e.g., "2100px 900px")
  parallaxBackgroundSize: '',

  // The "normal" size of the presentation, aspect ratio will be preserved
  // when the presentation is scaled to fit different resolutions. Can be
  // specified using percentage units.
  width: 1728,
  height: 972,

  // Factor of the display size that should remain empty around the content
  margin: 0.1,

  // Bounds for smallest/largest possible scale to apply to content
  minScale: 0.2,
  maxScale: 1.5,

  // Optional libraries used to extend on reveal.js
  dependencies: [
      { src: 'reveal.js-3.9.2/lib/js/classList.js', condition: function() { return !document.body.classList; } },
      { src: 'reveal.js-3.9.2/plugin/title-footer/title-footer.js', async: true, callback: function()
          {title_footer.initialize('Spring Workshop', 'Jan Lühr', 'anderScore GmbH • Frankenwerft 35 • 50667 Köln');}},
      { src: 'reveal.js-3.9.2/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
      { src: 'reveal.js-3.9.2/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
      
      { src: 'reveal.js-3.9.2/plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
      { src: 'reveal.js-3.9.2/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
  ]
});</script></body></html>